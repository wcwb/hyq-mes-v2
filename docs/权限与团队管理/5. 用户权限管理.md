# ç”¨æˆ·æƒé™ç®¡ç†

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç”¨æˆ·æƒé™ç®¡ç†çš„å„ç§æ“ä½œå’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ æƒé™æ£€æŸ¥æ–¹æ³•

### åŸºæœ¬æƒé™æ£€æŸ¥

#### hasPermissionToSafely()
è¿™æ˜¯æ¨èçš„æƒé™æ£€æŸ¥æ–¹æ³•ï¼Œè§£å†³äº†å¤šå›¢é˜Ÿç¯å¢ƒä¸‹çš„æƒé™åç§°è§£æé—®é¢˜ã€‚

```php
// åŸºæœ¬ç”¨æ³•
$user = auth()->user();

// æ£€æŸ¥å•ä¸ªæƒé™
if ($user->hasPermissionToSafely('view_orders')) {
    echo "ç”¨æˆ·æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// æ£€æŸ¥æƒé™å¯¹è±¡
$permission = Permission::findByName('view_orders');
if ($user->hasPermissionToSafely($permission)) {
    echo "ç”¨æˆ·æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// æŒ‡å®šå®ˆå«
if ($user->hasPermissionToSafely('view_orders', 'api')) {
    echo "ç”¨æˆ·åœ¨APIå®ˆå«ä¸‹æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}
```

#### canSafely()
Laravel Gate ç³»ç»Ÿçš„å®‰å…¨ç‰ˆæœ¬ï¼Œæ”¯æŒå¤šå›¢é˜Ÿç¯å¢ƒã€‚

```php
// åŸºæœ¬æƒé™æ£€æŸ¥
if ($user->canSafely('edit_products')) {
    echo "ç”¨æˆ·å¯ä»¥ç¼–è¾‘äº§å“";
}

// å¸¦å‚æ•°çš„æƒé™æ£€æŸ¥
if ($user->canSafely('edit_product', $product)) {
    echo "ç”¨æˆ·å¯ä»¥ç¼–è¾‘è¿™ä¸ªç‰¹å®šäº§å“";
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
public function edit(Product $product)
{
    if (!auth()->user()->canSafely('edit_product', $product)) {
        abort(403, 'æ‚¨æ²¡æœ‰ç¼–è¾‘æ­¤äº§å“çš„æƒé™');
    }
    
    return view('products.edit', compact('product'));
}
```

### æ‰¹é‡æƒé™æ£€æŸ¥

#### hasAnyPermissionSafely()
é«˜æ•ˆåœ°æ£€æŸ¥å¤šä¸ªæƒé™ï¼Œé¿å…é‡å¤æŸ¥è¯¢ã€‚

```php
$permissions = ['view_orders', 'edit_orders', 'delete_orders'];

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰ä»»æ„ä¸€ä¸ªæƒé™
if ($user->hasAnyPermissionSafely($permissions)) {
    echo "ç”¨æˆ·è‡³å°‘æœ‰ä¸€ä¸ªè®¢å•ç›¸å…³æƒé™";
}

// æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æƒé™
if ($user->hasAnyPermissionSafely($permissions, true)) {
    echo "ç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰è®¢å•æƒé™";
}

// å®é™…åº”ç”¨ç¤ºä¾‹
public function orderDashboard()
{
    $user = auth()->user();
    $orderPermissions = ['view_orders', 'edit_orders', 'delete_orders'];
    
    if (!$user->hasAnyPermissionSafely($orderPermissions)) {
        abort(403, 'æ‚¨æ²¡æœ‰è®¿é—®è®¢å•ç®¡ç†çš„æƒé™');
    }
    
    $canView = $user->hasPermissionToSafely('view_orders');
    $canEdit = $user->hasPermissionToSafely('edit_orders');
    $canDelete = $user->hasPermissionToSafely('delete_orders');
    
    return view('orders.dashboard', compact('canView', 'canEdit', 'canDelete'));
}
```

### è·¨å›¢é˜Ÿæƒé™æ£€æŸ¥

#### hasPermissionInTeam()
æ£€æŸ¥ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿä¸­çš„æƒé™ã€‚

```php
// æ£€æŸ¥ç”¨æˆ·åœ¨å›¢é˜Ÿ5ä¸­æ˜¯å¦æœ‰æŸ¥çœ‹è®¢å•æƒé™
if ($user->hasPermissionInTeam(5, 'view_orders')) {
    echo "ç”¨æˆ·åœ¨å›¢é˜Ÿ5æœ‰æŸ¥çœ‹è®¢å•æƒé™";
}

// ç®¡ç†å‘˜è·¨å›¢é˜Ÿæƒé™æ£€æŸ¥
public function adminOrderView($teamId, $orderId)
{
    $user = auth()->user();
    
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if (!$user->hasRole('super_admin')) {
        // æ£€æŸ¥æ˜¯å¦åœ¨æŒ‡å®šå›¢é˜Ÿæœ‰æƒé™
        if (!$user->hasPermissionInTeam($teamId, 'view_orders')) {
            abort(403, 'æ‚¨æ²¡æœ‰æŸ¥çœ‹è¯¥å›¢é˜Ÿè®¢å•çš„æƒé™');
        }
    }
    
    $order = Order::where('team_id', $teamId)->findOrFail($orderId);
    return view('orders.show', compact('order'));
}
```

## â• ç”¨æˆ·æƒé™åˆ†é…

### åˆ†é…ç›´æ¥æƒé™

#### givePermissionTo()
ä¸ºç”¨æˆ·ç›´æ¥åˆ†é…æƒé™ï¼Œè¿™äº›æƒé™ç‹¬ç«‹äºè§’è‰²å­˜åœ¨ã€‚

```php
// åˆ†é…å•ä¸ªæƒé™
$user->givePermissionTo('view_orders');

// åˆ†é…å¤šä¸ªæƒé™
$user->givePermissionTo(['view_orders', 'edit_orders', 'create_orders']);

// åˆ†é…æƒé™å¯¹è±¡
$permission = Permission::findByName('view_orders');
$user->givePermissionTo($permission);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åˆ†é…æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->givePermissionTo('view_orders');
```

#### å®‰å…¨åˆ†é…æƒé™æ–¹æ³•
```php
// ä½¿ç”¨å®‰å…¨æ–¹æ³•åˆ†é…æƒé™ï¼ˆè‡ªåŠ¨å¤„ç†å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼‰
$user->setCurrentTeamAsPermissionContext();
$user->givePermissionTo('view_orders');

// æˆ–è€…åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åˆ†é…æƒé™
$user->withTeamContext(7, function($user) {
    $user->givePermissionTo('view_orders');
});
```

### åˆ†é…è§’è‰²

#### assignRole()
ä¸ºç”¨æˆ·åˆ†é…è§’è‰²ï¼Œç”¨æˆ·å°†ç»§æ‰¿è§’è‰²çš„æ‰€æœ‰æƒé™ã€‚

```php
// åˆ†é…å•ä¸ªè§’è‰²
$user->assignRole('editor');

// åˆ†é…å¤šä¸ªè§’è‰²
$user->assignRole(['editor', 'creator']);

// åˆ†é…è§’è‰²å¯¹è±¡
$role = Role::findByName('editor');
$user->assignRole($role);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åˆ†é…è§’è‰²
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->assignRole('viewer');
```

#### assignRoleSafely()
å®‰å…¨åœ°åˆ†é…è§’è‰²ï¼ˆè‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼‰ã€‚

```php
// å®‰å…¨åˆ†é…å•ä¸ªè§’è‰²
$user->assignRoleSafely('creator');

// å®‰å…¨åˆ†é…å¤šä¸ªè§’è‰²
$user->assignRoleSafely(['creator', 'editor']);

// é“¾å¼è°ƒç”¨
$user->assignRoleSafely('creator')
     ->assignRoleSafely('editor');
```

#### assignRoleInTeam()
åœ¨æŒ‡å®šå›¢é˜Ÿä¸­ä¸ºç”¨æˆ·åˆ†é…è§’è‰²ã€‚

```php
// åœ¨å›¢é˜Ÿ7ä¸­åˆ†é…viewerè§’è‰²
$user->assignRoleInTeam(7, 'viewer');

// åœ¨å›¢é˜Ÿ7ä¸­åˆ†é…å¤šä¸ªè§’è‰²
$user->assignRoleInTeam(7, ['editor', 'approver']);
```

### æ‰¹é‡æƒé™åˆ†é…

#### syncPermissions()
åŒæ­¥æƒé™ï¼ˆæ›¿æ¢æ‰€æœ‰ç›´æ¥æƒé™ï¼‰ã€‚

```php
// è®¾ç½®ç”¨æˆ·çš„æ‰€æœ‰ç›´æ¥æƒé™
$user->syncPermissions(['view_orders', 'edit_orders', 'create_orders']);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åŒæ­¥æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->syncPermissions(['view_orders']);

// æ¸…ç©ºæ‰€æœ‰ç›´æ¥æƒé™
$user->syncPermissions([]);
```

#### syncRoles()
åŒæ­¥è§’è‰²ï¼ˆæ›¿æ¢æ‰€æœ‰è§’è‰²ï¼‰ã€‚

```php
// è®¾ç½®ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
$user->syncRoles(['editor', 'creator']);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åŒæ­¥è§’è‰²
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->syncRoles(['viewer']);

// æ¸…ç©ºæ‰€æœ‰è§’è‰²
$user->syncRoles([]);
```

### API æ¥å£åˆ†é…æƒé™

#### åˆ†é…ç”¨æˆ·ç›´æ¥æƒé™
```http
POST /api/users/{userId}/permissions
Content-Type: application/json

{
    "permissions": ["view_orders", "edit_orders"]
}
```

#### åˆ†é…ç”¨æˆ·è§’è‰²
```http
POST /api/users/{userId}/roles
Content-Type: application/json

{
    "roles": ["creator", "editor"]
}
```

#### ä¸ºè§’è‰²åˆ†é…æƒé™
```http
POST /api/roles/{roleId}/permissions
Content-Type: application/json

{
    "permissions": ["view_orders", "edit_orders"]
}
```

### å®é™…åº”ç”¨ç¤ºä¾‹

#### æ–°ç”¨æˆ·å…¥èŒæƒé™åˆ†é…
```php
// æ–°ç”¨æˆ·å…¥èŒæ—¶åˆ†é…åŸºç¡€æƒé™
function assignNewUserPermissions(User $user, int $teamId, string $position): void
{
    $user->withTeamContext($teamId, function($user) use ($position) {
        switch ($position) {
            case 'manager':
                // ç®¡ç†å‘˜æƒé™
                $user->assignRole('manager');
                $user->givePermissionTo([
                    'view_orders', 'edit_orders', 'create_orders', 'approve_orders',
                    'view_products', 'edit_products', 'create_products',
                    'view_customers', 'edit_customers', 'create_customers',
                    'view_reports'
                ]);
                break;
                
            case 'editor':
                // ç¼–è¾‘å‘˜æƒé™
                $user->assignRole('editor');
                $user->givePermissionTo([
                    'view_orders', 'edit_orders', 'create_orders',
                    'view_products', 'edit_products', 'create_products',
                    'view_customers', 'edit_customers'
                ]);
                break;
                
            case 'viewer':
                // æŸ¥çœ‹å‘˜æƒé™
                $user->assignRole('viewer');
                $user->givePermissionTo([
                    'view_orders', 'view_products', 'view_customers'
                ]);
                break;
                
            default:
                // é»˜è®¤åŸºç¡€æƒé™
                $user->assignRole('member');
                $user->givePermissionTo(['view_orders']);
        }
        
        echo "å·²ä¸ºç”¨æˆ·åˆ†é… {$position} æƒé™\n";
    });
}

// ä½¿ç”¨ç¤ºä¾‹
$newUser = User::find(2);
assignNewUserPermissions($newUser, 7, 'editor');
```

#### æƒé™å‡çº§å¤„ç†
```php
// ç”¨æˆ·æƒé™å‡çº§
function upgradeUserPermissions(User $user, int $teamId, string $fromRole, string $toRole): void
{
    $user->withTeamContext($teamId, function($user) use ($fromRole, $toRole) {
        // ç§»é™¤æ—§è§’è‰²
        if ($user->hasRole($fromRole)) {
            $user->removeRole($fromRole);
        }
        
        // åˆ†é…æ–°è§’è‰²
        $user->assignRole($toRole);
        
        // æ ¹æ®æ–°è§’è‰²åˆ†é…é¢å¤–æƒé™
        switch ($toRole) {
            case 'manager':
                $user->givePermissionTo([
                    'approve_orders', 'delete_orders',
                    'delete_products', 'manage_customers',
                    'view_reports', 'export_data'
                ]);
                break;
                
            case 'senior_editor':
                $user->givePermissionTo([
                    'approve_orders', 'delete_products'
                ]);
                break;
        }
        
        echo "ç”¨æˆ·å·²ä» {$fromRole} å‡çº§ä¸º {$toRole}\n";
    });
}

// ä½¿ç”¨ç¤ºä¾‹
upgradeUserPermissions($user, 7, 'editor', 'manager');
```

#### æƒé™åˆ†é…æœåŠ¡
```php
class PermissionAssignmentService
{
    /**
     * ä¸ºç”¨æˆ·åˆ†é…ç‰¹å®šæƒé™
     */
    public function assignSpecificPermissions(User $user, array $permissions, ?int $teamId = null): array
    {
        $assignedPermissions = [];
        
        $executeAssignment = function($user) use ($permissions, &$assignedPermissions) {
            foreach ($permissions as $permission) {
                if (!$user->hasDirectPermission($permission)) {
                    $user->givePermissionTo($permission);
                    $assignedPermissions[] = $permission;
                }
            }
        };
        
        if ($teamId) {
            $user->withTeamContext($teamId, $executeAssignment);
        } else {
            $user->setCurrentTeamAsPermissionContext();
            $executeAssignment($user);
        }
        
        return $assignedPermissions;
    }
    
    /**
     * æ‰¹é‡ä¸ºç”¨æˆ·åˆ†é…è§’è‰²æƒé™
     */
    public function bulkAssignRolePermissions(array $userIds, string $roleName, int $teamId): array
    {
        $results = [];
        
        foreach ($userIds as $userId) {
            $user = User::find($userId);
            if ($user) {
                $user->withTeamContext($teamId, function($user) use ($roleName) {
                    $user->assignRole($roleName);
                });
                $results[$userId] = $roleName;
            }
        }
        
        return $results;
    }
    
    /**
     * å¤åˆ¶ç”¨æˆ·æƒé™åˆ°å¦ä¸€ä¸ªç”¨æˆ·
     */
    public function copyUserPermissions(User $fromUser, User $toUser, int $teamId): array
    {
        $copiedData = [];
        
        // åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­æ“ä½œ
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        // å¤åˆ¶è§’è‰²
        $roles = $fromUser->roles->pluck('name')->toArray();
        $toUser->syncRoles($roles);
        $copiedData['roles'] = $roles;
        
        // å¤åˆ¶ç›´æ¥æƒé™
        $permissions = $fromUser->getDirectPermissions()->pluck('name')->toArray();
        $toUser->syncPermissions($permissions);
        $copiedData['permissions'] = $permissions;
        
        return $copiedData;
    }
    
    /**
     * æ ¹æ®æ¨¡æ¿åˆ†é…æƒé™
     */
    public function assignPermissionsByTemplate(User $user, string $template, int $teamId): array
    {
        $templates = [
            'admin' => [
                'roles' => ['admin'],
                'permissions' => [
                    'view_orders', 'create_orders', 'edit_orders', 'delete_orders', 'approve_orders',
                    'view_products', 'create_products', 'edit_products', 'delete_products',
                    'view_customers', 'create_customers', 'edit_customers', 'delete_customers',
                    'view_reports', 'export_data', 'manage_team'
                ]
            ],
            'manager' => [
                'roles' => ['manager'],
                'permissions' => [
                    'view_orders', 'create_orders', 'edit_orders', 'approve_orders',
                    'view_products', 'create_products', 'edit_products',
                    'view_customers', 'create_customers', 'edit_customers',
                    'view_reports'
                ]
            ],
            'editor' => [
                'roles' => ['editor'],
                'permissions' => [
                    'view_orders', 'create_orders', 'edit_orders',
                    'view_products', 'create_products', 'edit_products',
                    'view_customers', 'edit_customers'
                ]
            ],
            'viewer' => [
                'roles' => ['viewer'],
                'permissions' => [
                    'view_orders', 'view_products', 'view_customers'
                ]
            ]
        ];
        
        if (!isset($templates[$template])) {
            throw new \InvalidArgumentException("æƒé™æ¨¡æ¿ '{$template}' ä¸å­˜åœ¨");
        }
        
        $templateData = $templates[$template];
        
        $user->withTeamContext($teamId, function($user) use ($templateData) {
            // åˆ†é…è§’è‰²
            $user->syncRoles($templateData['roles']);
            
            // åˆ†é…æƒé™
            $user->syncPermissions($templateData['permissions']);
        });
        
        return $templateData;
    }
}

// ä½¿ç”¨æƒé™åˆ†é…æœåŠ¡
$assignmentService = new PermissionAssignmentService();

// åˆ†é…ç‰¹å®šæƒé™
$assignedPermissions = $assignmentService->assignSpecificPermissions(
    $user, 
    ['view_orders', 'edit_orders'], 
    7
);
echo "å·²åˆ†é…æƒé™: " . implode(', ', $assignedPermissions) . "\n";

// æ‰¹é‡åˆ†é…è§’è‰²
$results = $assignmentService->bulkAssignRolePermissions(
    [2, 3, 4], 
    'editor', 
    7
);
foreach ($results as $userId => $role) {
    echo "ç”¨æˆ· {$userId} å·²åˆ†é…è§’è‰²: {$role}\n";
}

// å¤åˆ¶æƒé™
$sourceUser = User::find(1); // æ¨¡æ¿ç”¨æˆ·
$targetUser = User::find(2); // ç›®æ ‡ç”¨æˆ·
$copiedData = $assignmentService->copyUserPermissions($sourceUser, $targetUser, 7);
echo "å·²å¤åˆ¶è§’è‰²: " . implode(', ', $copiedData['roles']) . "\n";
echo "å·²å¤åˆ¶æƒé™: " . implode(', ', $copiedData['permissions']) . "\n";

// ä½¿ç”¨æ¨¡æ¿åˆ†é…æƒé™
$templateData = $assignmentService->assignPermissionsByTemplate($user, 'manager', 7);
echo "å·²åº”ç”¨ç®¡ç†å‘˜æ¨¡æ¿\n";
```

### æƒé™åˆ†é…çš„æœ€ä½³å®è·µ

#### 1. æƒé™åˆ†é…å‰çš„éªŒè¯
```php
// åˆ†é…æƒé™å‰è¿›è¡ŒéªŒè¯
function safeAssignPermission(User $user, string $permission, int $teamId): bool
{
    // æ£€æŸ¥æƒé™æ˜¯å¦å­˜åœ¨
    $permissionExists = Permission::where('name', $permission)
        ->where('team_id', $teamId)
        ->exists();
    
    if (!$permissionExists) {
        echo "æƒé™ {$permission} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨\n";
        return false;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰æ­¤æƒé™
    if ($user->hasPermissionInTeam($teamId, $permission)) {
        echo "ç”¨æˆ·å·²æ‹¥æœ‰æƒé™ {$permission}\n";
        return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºæƒé™é™åˆ¶
    $maxPermissions = 50; // å‡è®¾æ¯ä¸ªç”¨æˆ·æœ€å¤š50ä¸ªæƒé™
    $currentPermissionCount = $user->getAllPermissions()->count();
    
    if ($currentPermissionCount >= $maxPermissions) {
        echo "ç”¨æˆ·æƒé™æ•°é‡å·²è¾¾ä¸Šé™ ({$maxPermissions})\n";
        return false;
    }
    
    // æ‰§è¡Œåˆ†é…
    $user->withTeamContext($teamId, function($user) use ($permission) {
        $user->givePermissionTo($permission);
    });
    
    return true;
}
```

#### 2. æƒé™åˆ†é…æ—¥å¿—è®°å½•
```php
// è®°å½•æƒé™åˆ†é…æ“ä½œ
function logPermissionAssignment(User $user, string $permission, int $teamId, User $operator): void
{
    Log::info('Permission assigned', [
        'user_id' => $user->id,
        'user_name' => $user->name,
        'permission' => $permission,
        'team_id' => $teamId,
        'operator_id' => $operator->id,
        'operator_name' => $operator->name,
        'timestamp' => now(),
        'ip_address' => request()->ip()
    ]);
}

// åœ¨åˆ†é…æƒé™æ—¶è°ƒç”¨
$user->givePermissionTo('view_orders');
logPermissionAssignment($user, 'view_orders', 7, auth()->user());
```

#### 3. æƒé™åˆ†é…é€šçŸ¥
```php
// å‘é€æƒé™åˆ†é…é€šçŸ¥
function notifyPermissionAssignment(User $user, array $assignedPermissions, int $teamId): void
{
    $team = Team::find($teamId);
    
    $user->notify(new PermissionAssignedNotification([
        'permissions' => $assignedPermissions,
        'team_name' => $team->name,
        'assigned_at' => now()
    ]));
}

// ä½¿ç”¨ç¤ºä¾‹
$assignedPermissions = ['view_orders', 'edit_orders'];
$user->givePermissionTo($assignedPermissions);
notifyPermissionAssignment($user, $assignedPermissions, 7);
```

#### 4. æƒé™åˆ†é…å®¡æ‰¹æµç¨‹
```php
// æƒé™åˆ†é…ç”³è¯·
class PermissionRequest extends Model
{
    protected $fillable = [
        'user_id', 'team_id', 'requested_permissions', 
        'requested_roles', 'reason', 'status', 'approved_by'
    ];
    
    protected $casts = [
        'requested_permissions' => 'array',
        'requested_roles' => 'array'
    ];
}

// æƒé™ç”³è¯·æœåŠ¡
class PermissionRequestService
{
    public function createRequest(User $user, array $permissions, array $roles, string $reason, int $teamId): PermissionRequest
    {
        return PermissionRequest::create([
            'user_id' => $user->id,
            'team_id' => $teamId,
            'requested_permissions' => $permissions,
            'requested_roles' => $roles,
            'reason' => $reason,
            'status' => 'pending'
        ]);
    }
    
    public function approveRequest(PermissionRequest $request, User $approver): bool
    {
        $user = $request->user;
        
        $user->withTeamContext($request->team_id, function($user) use ($request) {
            // åˆ†é…è§’è‰²
            if (!empty($request->requested_roles)) {
                foreach ($request->requested_roles as $role) {
                    $user->assignRole($role);
                }
            }
            
            // åˆ†é…æƒé™
            if (!empty($request->requested_permissions)) {
                $user->givePermissionTo($request->requested_permissions);
            }
        });
        
        $request->update([
            'status' => 'approved',
            'approved_by' => $approver->id,
            'approved_at' => now()
        ]);
        
        return true;
    }
}
```

## ğŸ—‘ï¸ åˆ é™¤æƒé™æ–¹æ³•

### åˆ é™¤ç”¨æˆ·ç›´æ¥æƒé™

#### revokePermissionTo()
åˆ é™¤ç”¨æˆ·çš„ç›´æ¥æƒé™ï¼ˆä¸å½±å“é€šè¿‡è§’è‰²è·å¾—çš„æƒé™ï¼‰ã€‚

```php
// åˆ é™¤å•ä¸ªæƒé™
$user->revokePermissionTo('view_orders');

// åˆ é™¤å¤šä¸ªæƒé™
$user->revokePermissionTo(['view_orders', 'edit_orders']);

// åˆ é™¤æƒé™å¯¹è±¡
$permission = Permission::findByName('view_orders');
$user->revokePermissionTo($permission);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åˆ é™¤æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->revokePermissionTo('view_orders');
```

#### å®‰å…¨åˆ é™¤æƒé™æ–¹æ³•
```php
// ä½¿ç”¨å®‰å…¨æ–¹æ³•åˆ é™¤æƒé™ï¼ˆè‡ªåŠ¨å¤„ç†å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼‰
$user->setCurrentTeamAsPermissionContext();
$user->revokePermissionTo('view_orders');

// æˆ–è€…åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åˆ é™¤æƒé™
$user->withTeamContext(7, function($user) {
    $user->revokePermissionTo('view_orders');
});
```

### åˆ é™¤ç”¨æˆ·è§’è‰²

#### removeRole()
åˆ é™¤ç”¨æˆ·çš„è§’è‰²ï¼Œç”¨æˆ·å°†å¤±å»è¯¥è§’è‰²çš„æ‰€æœ‰æƒé™ã€‚

```php
// åˆ é™¤å•ä¸ªè§’è‰²
$user->removeRole('viewer');

// åˆ é™¤å¤šä¸ªè§’è‰²
$user->removeRole(['editor', 'creator']);

// åˆ é™¤è§’è‰²å¯¹è±¡
$role = Role::findByName('editor');
$user->removeRole($role);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åˆ é™¤è§’è‰²
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->removeRole('viewer');
```

#### removeRoleSafely()
å®‰å…¨åœ°åˆ é™¤ç”¨æˆ·è§’è‰²ï¼ˆè‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼‰ã€‚

```php
// å®‰å…¨åˆ é™¤å•ä¸ªè§’è‰²
$user->removeRoleSafely('creator');

// å®‰å…¨åˆ é™¤å¤šä¸ªè§’è‰²
$user->removeRoleSafely(['creator', 'editor']);

// é“¾å¼è°ƒç”¨
$user->removeRoleSafely('creator')
     ->removeRoleSafely('editor');
```

#### removeRoleInTeam()
åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åˆ é™¤ç”¨æˆ·è§’è‰²ã€‚

```php
// åœ¨å›¢é˜Ÿ7ä¸­åˆ é™¤viewerè§’è‰²
$user->removeRoleInTeam(7, 'viewer');

// åœ¨å›¢é˜Ÿ7ä¸­åˆ é™¤å¤šä¸ªè§’è‰²
$user->removeRoleInTeam(7, ['editor', 'approver']);
```



### æ‰¹é‡åˆ é™¤æƒé™

#### syncPermissions()
åŒæ­¥æƒé™ï¼ˆæ›¿æ¢æ‰€æœ‰ç›´æ¥æƒé™ï¼‰ã€‚

```php
// æ¸…ç©ºæ‰€æœ‰ç›´æ¥æƒé™
$user->syncPermissions([]);

// æ›¿æ¢ä¸ºæ–°çš„æƒé™é›†åˆ
$user->syncPermissions(['view_orders', 'view_products']);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åŒæ­¥æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$user->syncPermissions(['view_orders']);
```

#### syncRolesSafely()
å®‰å…¨åœ°åŒæ­¥ç”¨æˆ·è§’è‰²ï¼ˆæ›¿æ¢å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰è§’è‰²ï¼‰ã€‚

```php
// æ¸…ç©ºå½“å‰å›¢é˜Ÿçš„æ‰€æœ‰è§’è‰²
$user->syncRolesSafely([]);

// æ›¿æ¢ä¸ºæ–°çš„è§’è‰²é›†åˆ
$user->syncRolesSafely(['viewer', 'creator']);

// æ¡ä»¶æ€§è§’è‰²åŒæ­¥
if ($user->hasRole('admin')) {
    // ç®¡ç†å‘˜ä¿ç•™adminè§’è‰²ï¼Œæ·»åŠ å…¶ä»–è§’è‰²
    $currentRoles = $user->getRoleNames()->toArray();
    $newRoles = array_merge($currentRoles, ['editor']);
    $user->syncRolesSafely($newRoles);
} else {
    // æ™®é€šç”¨æˆ·ç›´æ¥æ›¿æ¢è§’è‰²
    $user->syncRolesSafely(['viewer']);
}
```

### API æ¥å£åˆ é™¤æƒé™

#### åˆ é™¤ç”¨æˆ·ç›´æ¥æƒé™
```http
DELETE /api/users/{userId}/permissions
Content-Type: application/json

{
    "permissions": ["view_orders", "edit_orders"]
}
```

#### åˆ é™¤ç”¨æˆ·è§’è‰²
```http
DELETE /api/users/{userId}/roles
Content-Type: application/json

{
    "roles": ["creator", "editor"]
}
```

#### ä»è§’è‰²ä¸­åˆ é™¤æƒé™
```http
DELETE /api/roles/{roleId}/permissions
Content-Type: application/json

{
    "permissions": ["view_orders", "edit_orders"]
}
```

### å®é™…åº”ç”¨ç¤ºä¾‹

#### ç”¨æˆ·ç¦»èŒå¤„ç†
```php
// ç”¨æˆ·ç¦»èŒæ—¶æ¸…ç†æƒé™
function handleUserResignation(User $user): void
{
    // è·å–ç”¨æˆ·æ‰€å±çš„æ‰€æœ‰å›¢é˜Ÿ
    $teams = $user->teams;
    
    foreach ($teams as $team) {
        // åœ¨æ¯ä¸ªå›¢é˜Ÿä¸­æ¸…ç†æƒé™
        $user->withTeamContext($team->id, function($user) {
            // æ¸…ç©ºæ‰€æœ‰è§’è‰²
            $user->syncRoles([]);
            
            // æ¸…ç©ºæ‰€æœ‰ç›´æ¥æƒé™
            $user->syncPermissions([]);
            
            echo "å·²æ¸…ç†å›¢é˜Ÿ {$team->id} ä¸­çš„æƒé™\n";
        });
    }
    
    // ä»æ‰€æœ‰å›¢é˜Ÿä¸­ç§»é™¤ç”¨æˆ·
    $user->teams()->detach();
    
    echo "ç”¨æˆ·æƒé™æ¸…ç†å®Œæˆ\n";
}

// ä½¿ç”¨ç¤ºä¾‹
$resignedUser = User::find(2);
handleUserResignation($resignedUser);
```

#### è§’è‰²é™çº§å¤„ç†
```php
// å°†ç®¡ç†å‘˜é™çº§ä¸ºæ™®é€šç”¨æˆ·
function demoteAdmin(User $user, int $teamId): void
{
    $user->withTeamContext($teamId, function($user) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        if ($user->hasRole('admin')) {
            // ç§»é™¤ç®¡ç†å‘˜è§’è‰²
            $user->removeRole('admin');
            
            // åˆ†é…åŸºç¡€è§’è‰²
            $user->assignRole('viewer');
            
            // ç§»é™¤æ‰€æœ‰ç›´æ¥æƒé™
            $user->syncPermissions([]);
            
            echo "ç®¡ç†å‘˜å·²é™çº§ä¸ºæ™®é€šç”¨æˆ·\n";
        }
    });
}

// ä½¿ç”¨ç¤ºä¾‹
demoteAdmin($user, 7);
```

#### æƒé™å›æ”¶æœåŠ¡
```php
class PermissionRevocationService
{
    /**
     * å›æ”¶ç”¨æˆ·çš„ç‰¹å®šæƒé™
     */
    public function revokeSpecificPermissions(User $user, array $permissions, ?int $teamId = null): array
    {
        $revokedPermissions = [];
        
        $executeRevocation = function($user) use ($permissions, &$revokedPermissions) {
            foreach ($permissions as $permission) {
                if ($user->hasDirectPermission($permission)) {
                    $user->revokePermissionTo($permission);
                    $revokedPermissions[] = $permission;
                }
            }
        };
        
        if ($teamId) {
            $user->withTeamContext($teamId, $executeRevocation);
        } else {
            $user->setCurrentTeamAsPermissionContext();
            $executeRevocation($user);
        }
        
        return $revokedPermissions;
    }
    
    /**
     * å›æ”¶ç”¨æˆ·çš„è¿‡æœŸæƒé™
     */
    public function revokeExpiredPermissions(User $user): array
    {
        $expiredPermissions = [];
        
        // å‡è®¾æƒé™æœ‰è¿‡æœŸæ—¶é—´å­—æ®µ
        $userPermissions = $user->permissions()
            ->wherePivot('expires_at', '<', now())
            ->get();
        
        foreach ($userPermissions as $permission) {
            $user->revokePermissionTo($permission);
            $expiredPermissions[] = $permission->name;
        }
        
        return $expiredPermissions;
    }
    
    /**
     * æ‰¹é‡å›æ”¶å›¢é˜Ÿæƒé™
     */
    public function bulkRevokeTeamPermissions(array $userIds, array $permissions, int $teamId): array
    {
        $results = [];
        
        foreach ($userIds as $userId) {
            $user = User::find($userId);
            if ($user) {
                $revoked = $this->revokeSpecificPermissions($user, $permissions, $teamId);
                $results[$userId] = $revoked;
            }
        }
        
        return $results;
    }
}

// ä½¿ç”¨æƒé™å›æ”¶æœåŠ¡
$revocationService = new PermissionRevocationService();

// å›æ”¶ç‰¹å®šæƒé™
$revokedPermissions = $revocationService->revokeSpecificPermissions(
    $user, 
    ['view_orders', 'edit_orders'], 
    7
);
echo "å·²å›æ”¶æƒé™: " . implode(', ', $revokedPermissions) . "\n";

// æ‰¹é‡å›æ”¶æƒé™
$results = $revocationService->bulkRevokeTeamPermissions(
    [2, 3, 4], 
    ['delete_orders'], 
    7
);
foreach ($results as $userId => $permissions) {
    echo "ç”¨æˆ· {$userId} è¢«å›æ”¶æƒé™: " . implode(', ', $permissions) . "\n";
}
```

### åˆ é™¤æƒé™çš„æœ€ä½³å®è·µ

#### 1. æƒé™åˆ é™¤å‰çš„éªŒè¯
```php
// åˆ é™¤æƒé™å‰è¿›è¡ŒéªŒè¯
function safeRevokePermission(User $user, string $permission, int $teamId): bool
{
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦çœŸçš„æœ‰è¿™ä¸ªæƒé™
    if (!$user->hasPermissionInTeam($teamId, $permission)) {
        echo "ç”¨æˆ·åœ¨å›¢é˜Ÿ {$teamId} ä¸­æ²¡æœ‰ {$permission} æƒé™\n";
        return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å…³é”®æƒé™ï¼ˆå¦‚å›¢é˜Ÿæ‰€æœ‰è€…æƒé™ï¼‰
    $criticalPermissions = ['manage_team', 'delete_team'];
    if (in_array($permission, $criticalPermissions)) {
        // ç¡®ä¿å›¢é˜Ÿè‡³å°‘æœ‰ä¸€ä¸ªæ‰€æœ‰è€…
        $teamOwners = User::role('owner')->where('current_team_id', $teamId)->count();
        if ($teamOwners <= 1 && $user->hasRole('owner')) {
            echo "æ— æ³•åˆ é™¤æœ€åä¸€ä¸ªå›¢é˜Ÿæ‰€æœ‰è€…çš„å…³é”®æƒé™\n";
            return false;
        }
    }
    
    // æ‰§è¡Œåˆ é™¤
    $user->withTeamContext($teamId, function($user) use ($permission) {
        $user->revokePermissionTo($permission);
    });
    
    return true;
}
```

#### 2. æƒé™åˆ é™¤æ—¥å¿—è®°å½•
```php
// è®°å½•æƒé™åˆ é™¤æ“ä½œ
function logPermissionRevocation(User $user, string $permission, int $teamId, User $operator): void
{
    Log::info('Permission revoked', [
        'user_id' => $user->id,
        'user_name' => $user->name,
        'permission' => $permission,
        'team_id' => $teamId,
        'operator_id' => $operator->id,
        'operator_name' => $operator->name,
        'timestamp' => now(),
        'ip_address' => request()->ip()
    ]);
}

// åœ¨åˆ é™¤æƒé™æ—¶è°ƒç”¨
$user->revokePermissionTo('view_orders');
logPermissionRevocation($user, 'view_orders', 7, auth()->user());
```

#### 3. æƒé™åˆ é™¤é€šçŸ¥
```php
// å‘é€æƒé™åˆ é™¤é€šçŸ¥
function notifyPermissionRevocation(User $user, array $revokedPermissions, int $teamId): void
{
    $team = Team::find($teamId);
    
    $user->notify(new PermissionRevokedNotification([
        'permissions' => $revokedPermissions,
        'team_name' => $team->name,
        'revoked_at' => now()
    ]));
}

// ä½¿ç”¨ç¤ºä¾‹
$revokedPermissions = ['view_orders', 'edit_orders'];
$user->revokePermissionTo($revokedPermissions);
notifyPermissionRevocation($user, $revokedPermissions, 7);
```

## ğŸ”„ å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†

### è‡ªåŠ¨å›¢é˜Ÿä¸Šä¸‹æ–‡

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ `current_team_id` ä½œä¸ºæƒé™ä¸Šä¸‹æ–‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚

```php
// ç”¨æˆ·ç™»å½•åï¼Œç³»ç»Ÿè‡ªåŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
$user = auth()->user();
echo "å½“å‰å›¢é˜Ÿ: " . $user->current_team_id;

// æƒé™æ£€æŸ¥è‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡
if ($user->hasPermissionToSafely('view_orders')) {
    // æ£€æŸ¥ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æƒé™
}
```

### æ‰‹åŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡ã€‚

```php
// è®¾ç½®ç”¨æˆ·å½“å‰å›¢é˜Ÿä¸ºæƒé™ä¸Šä¸‹æ–‡
$user->setCurrentTeamAsPermissionContext();

// éªŒè¯è®¾ç½®æ˜¯å¦æˆåŠŸ
$registrar = app(\Spatie\Permission\PermissionRegistrar::class);
echo "æƒé™ä¸Šä¸‹æ–‡å›¢é˜ŸID: " . $registrar->getPermissionsTeamId();
```

### ä¸´æ—¶åˆ‡æ¢å›¢é˜Ÿä¸Šä¸‹æ–‡

ä½¿ç”¨ `withTeamContext()` æ–¹æ³•ä¸´æ—¶åˆ‡æ¢åˆ°æŒ‡å®šå›¢é˜Ÿæ‰§è¡Œæ“ä½œã€‚

```php
// åœ¨å›¢é˜Ÿ7ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œ
$result = $user->withTeamContext(7, function($user) {
    // æ£€æŸ¥å›¢é˜Ÿ7çš„æƒé™
    $hasViewPermission = $user->hasPermissionToSafely('view_orders');
    $hasEditPermission = $user->hasPermissionToSafely('edit_orders');
    
    // è·å–å›¢é˜Ÿ7çš„è§’è‰²
    $roles = $user->roles;
    
    return [
        'can_view' => $hasViewPermission,
        'can_edit' => $hasEditPermission,
        'roles' => $roles->pluck('name')->toArray()
    ];
});

// æ“ä½œå®Œæˆåï¼Œå›¢é˜Ÿä¸Šä¸‹æ–‡è‡ªåŠ¨æ¢å¤
echo "å›¢é˜Ÿ7æƒé™æ£€æŸ¥ç»“æœ: " . json_encode($result);
```

## ğŸ“Š æƒé™æŸ¥è¯¢å’Œåˆ†æ

### è·å–ç”¨æˆ·æƒé™åˆ—è¡¨

```php
// è·å–ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰æƒé™
$permissions = $user->getAllPermissions();
foreach ($permissions as $permission) {
    echo "æƒé™: {$permission->name} (å›¢é˜Ÿ: {$permission->team_id})";
}

// è·å–æƒé™åç§°æ•°ç»„
$permissionNames = $user->getAllPermissions()->pluck('name')->toArray();
echo "æƒé™åˆ—è¡¨: " . implode(', ', $permissionNames);

// æŒ‰æ¨¡å—åˆ†ç»„æƒé™
$permissionsByModule = [];
foreach ($permissions as $permission) {
    $module = explode('_', $permission->name)[1] ?? 'other'; // å‡è®¾æƒé™æ ¼å¼ä¸º action_module
    $permissionsByModule[$module][] = $permission->name;
}
```

### æƒé™ç»Ÿè®¡å’Œåˆ†æ

```php
// åˆ›å»ºæƒé™åˆ†ææœåŠ¡
class PermissionAnalysisService
{
    public function getUserPermissionSummary(User $user): array
    {
        $allRoles = $user->getAllRoles();
        $summary = [];
        
        foreach ($allRoles as $role) {
            $teamId = $role->pivot_team_id;
            if (!isset($summary[$teamId])) {
                $summary[$teamId] = [
                    'team_id' => $teamId,
                    'roles' => [],
                    'permissions' => []
                ];
            }
            
            $summary[$teamId]['roles'][] = $role->name;
            
            // è·å–è§’è‰²æƒé™
            $rolePermissions = $role->permissions->pluck('name')->toArray();
            $summary[$teamId]['permissions'] = array_unique(
                array_merge($summary[$teamId]['permissions'], $rolePermissions)
            );
        }
        
        return $summary;
    }
    
    public function getPermissionMatrix(User $user): array
    {
        $modules = ['orders', 'products', 'customers', 'reports']; // ç³»ç»Ÿæ¨¡å—
        $actions = ['view', 'create', 'edit', 'delete', 'approve']; // æ“ä½œç±»å‹
        
        $matrix = [];
        foreach ($modules as $module) {
            $matrix[$module] = [];
            foreach ($actions as $action) {
                $permissionName = "{$action}_{$module}";
                $matrix[$module][$action] = $user->hasPermissionToSafely($permissionName);
            }
        }
        
        return $matrix;
    }
}

// ä½¿ç”¨æƒé™åˆ†ææœåŠ¡
$analysisService = new PermissionAnalysisService();

// è·å–ç”¨æˆ·æƒé™æ‘˜è¦
$summary = $analysisService->getUserPermissionSummary($user);
foreach ($summary as $teamData) {
    echo "å›¢é˜Ÿ {$teamData['team_id']}:\n";
    echo "  è§’è‰²: " . implode(', ', $teamData['roles']) . "\n";
    echo "  æƒé™æ•°é‡: " . count($teamData['permissions']) . "\n";
}

// è·å–æƒé™çŸ©é˜µ
$matrix = $analysisService->getPermissionMatrix($user);
foreach ($matrix as $module => $actions) {
    echo "æ¨¡å— {$module}:\n";
    foreach ($actions as $action => $hasPermission) {
        echo "  {$action}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
    }
}
```

## ğŸ›¡ï¸ æƒé™éªŒè¯æ¨¡å¼

### ä¸­é—´ä»¶æƒé™éªŒè¯

```php
// åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
class CheckPermission
{
    public function handle($request, Closure $next, $permission)
    {
        $user = auth()->user();
        
        if (!$user) {
            abort(401, 'è¯·å…ˆç™»å½•');
        }
        
        if (!$user->current_team_id) {
            abort(403, 'è¯·å…ˆé€‰æ‹©å›¢é˜Ÿ');
        }
        
        if (!$user->hasPermissionToSafely($permission)) {
            abort(403, "æ‚¨æ²¡æœ‰ '{$permission}' æƒé™");
        }
        
        return $next($request);
    }
}

// åœ¨è·¯ç”±ä¸­ä½¿ç”¨
Route::middleware(['auth', 'permission:view_orders'])->group(function () {
    Route::get('/orders', [OrderController::class, 'index']);
    Route::get('/orders/{order}', [OrderController::class, 'show']);
});

// åœ¨æ§åˆ¶å™¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨
class OrderController extends Controller
{
    public function __construct()
    {
        $this->middleware('permission:view_orders')->only(['index', 'show']);
        $this->middleware('permission:create_orders')->only(['create', 'store']);
        $this->middleware('permission:edit_orders')->only(['edit', 'update']);
        $this->middleware('permission:delete_orders')->only(['destroy']);
    }
}
```

### ç­–ç•¥æƒé™éªŒè¯

```php
// åˆ›å»ºè®¢å•ç­–ç•¥
class OrderPolicy
{
    public function viewAny(User $user): bool
    {
        return $user->hasPermissionToSafely('view_orders');
    }
    
    public function view(User $user, Order $order): bool
    {
        // æ£€æŸ¥å›¢é˜Ÿæƒé™
        if ($user->current_team_id !== $order->team_id) {
            return false;
        }
        
        return $user->hasPermissionToSafely('view_orders');
    }
    
    public function create(User $user): bool
    {
        return $user->hasPermissionToSafely('create_orders');
    }
    
    public function update(User $user, Order $order): bool
    {
        // æ£€æŸ¥å›¢é˜Ÿå’Œæƒé™
        return $user->current_team_id === $order->team_id 
            && $user->hasPermissionToSafely('edit_orders');
    }
    
    public function delete(User $user, Order $order): bool
    {
        // åªæœ‰å›¢é˜Ÿæ‰€æœ‰è€…æˆ–æœ‰åˆ é™¤æƒé™çš„ç”¨æˆ·å¯ä»¥åˆ é™¤
        return $user->current_team_id === $order->team_id 
            && ($user->hasRole('owner') || $user->hasPermissionToSafely('delete_orders'));
    }
    
    public function approve(User $user, Order $order): bool
    {
        return $user->current_team_id === $order->team_id 
            && $user->hasPermissionToSafely('approve_orders');
    }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ç­–ç•¥
class OrderController extends Controller
{
    public function index()
    {
        $this->authorize('viewAny', Order::class);
        
        $user = auth()->user();
        $orders = Order::where('team_id', $user->current_team_id)->paginate(20);
        
        return view('orders.index', compact('orders'));
    }
    
    public function show(Order $order)
    {
        $this->authorize('view', $order);
        
        return view('orders.show', compact('order'));
    }
    
    public function update(Request $request, Order $order)
    {
        $this->authorize('update', $order);
        
        // æ›´æ–°è®¢å•é€»è¾‘
        $order->update($request->validated());
        
        return redirect()->route('orders.show', $order);
    }
}
```

### è¡¨å•è¯·æ±‚æƒé™éªŒè¯

```php
// åˆ›å»ºè¡¨å•è¯·æ±‚ç±»
class UpdateOrderRequest extends FormRequest
{
    public function authorize()
    {
        $user = auth()->user();
        $order = $this->route('order');
        
        // æ£€æŸ¥å›¢é˜Ÿæƒé™
        if ($user->current_team_id !== $order->team_id) {
            return false;
        }
        
        // æ£€æŸ¥ç¼–è¾‘æƒé™
        return $user->hasPermissionToSafely('edit_orders');
    }
    
    public function rules()
    {
        return [
            'title' => 'required|string|max:255',
            'description' => 'nullable|string',
            'status' => 'required|in:pending,processing,completed,cancelled',
            'priority' => 'required|in:low,medium,high,urgent'
        ];
    }
    
    public function messages()
    {
        return [
            'title.required' => 'è®¢å•æ ‡é¢˜ä¸èƒ½ä¸ºç©º',
            'status.required' => 'è®¢å•çŠ¶æ€ä¸èƒ½ä¸ºç©º',
            'status.in' => 'è®¢å•çŠ¶æ€å€¼æ— æ•ˆ',
        ];
    }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
public function update(UpdateOrderRequest $request, Order $order)
{
    // æƒé™éªŒè¯å·²åœ¨ FormRequest ä¸­å®Œæˆ
    $order->update($request->validated());
    
    return redirect()->route('orders.show', $order)
        ->with('success', 'è®¢å•æ›´æ–°æˆåŠŸ');
}
```

## ğŸ¨ å‰ç«¯æƒé™æ§åˆ¶

### Blade æ¨¡æ¿æƒé™æ£€æŸ¥

```php
{{-- æ£€æŸ¥æƒé™æ˜¾ç¤ºæŒ‰é’® --}}
@if(auth()->user()->hasPermissionToSafely('create_orders'))
    <a href="{{ route('orders.create') }}" class="btn btn-primary">
        åˆ›å»ºè®¢å•
    </a>
@endif

{{-- æ£€æŸ¥å¤šä¸ªæƒé™ --}}
@php
    $user = auth()->user();
    $canEdit = $user->hasPermissionToSafely('edit_orders');
    $canDelete = $user->hasPermissionToSafely('delete_orders');
@endphp

@if($canEdit || $canDelete)
    <div class="action-buttons">
        @if($canEdit)
            <a href="{{ route('orders.edit', $order) }}" class="btn btn-secondary">
                ç¼–è¾‘
            </a>
        @endif
        
        @if($canDelete)
            <form method="POST" action="{{ route('orders.destroy', $order) }}" 
                  style="display: inline;">
                @csrf
                @method('DELETE')
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ')">
                    åˆ é™¤
                </button>
            </form>
        @endif
    </div>
@endif

{{-- ä½¿ç”¨ç­–ç•¥æ£€æŸ¥ --}}
@can('update', $order)
    <a href="{{ route('orders.edit', $order) }}" class="btn btn-secondary">
        ç¼–è¾‘è®¢å•
    </a>
@endcan

@can('delete', $order)
    <button class="btn btn-danger" onclick="deleteOrder({{ $order->id }})">
        åˆ é™¤è®¢å•
    </button>
@endcan
```

### Vue.js æƒé™æ§åˆ¶

```javascript
// åˆ›å»ºæƒé™æ··å…¥
const permissionMixin = {
    methods: {
        hasPermission(permission) {
            return this.$store.getters.userPermissions.includes(permission);
        },
        
        hasAnyPermission(permissions) {
            return permissions.some(permission => this.hasPermission(permission));
        },
        
        hasAllPermissions(permissions) {
            return permissions.every(permission => this.hasPermission(permission));
        }
    }
};

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export default {
    mixins: [permissionMixin],
    
    computed: {
        canCreateOrder() {
            return this.hasPermission('create_orders');
        },
        
        canManageOrders() {
            return this.hasAnyPermission(['edit_orders', 'delete_orders']);
        }
    },
    
    template: `
        <div>
            <button v-if="canCreateOrder" @click="createOrder">
                åˆ›å»ºè®¢å•
            </button>
            
            <div v-if="canManageOrders" class="order-actions">
                <button v-if="hasPermission('edit_orders')" @click="editOrder">
                    ç¼–è¾‘
                </button>
                <button v-if="hasPermission('delete_orders')" @click="deleteOrder">
                    åˆ é™¤
                </button>
            </div>
        </div>
    `
};
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### æƒé™ç¼“å­˜ç­–ç•¥

```php
// åœ¨ç”¨æˆ·æ¨¡å‹ä¸­å®ç°æƒé™ç¼“å­˜
class User extends Authenticatable
{
    public function getCachedPermissions(): array
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        
        return Cache::remember($cacheKey, 1800, function() {
            $permissions = [];
            
            // è·å–ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰æƒé™
            foreach ($this->roles as $role) {
                $rolePermissions = $role->permissions->pluck('name')->toArray();
                $permissions = array_merge($permissions, $rolePermissions);
            }
            
            return array_unique($permissions);
        });
    }
    
    public function clearPermissionCache(): void
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        Cache::forget($cacheKey);
    }
    
    // é‡å†™æƒé™æ£€æŸ¥æ–¹æ³•ä½¿ç”¨ç¼“å­˜
    public function hasPermissionToSafely($permission, $guardName = null): bool
    {
        if (is_object($permission)) {
            return parent::hasPermissionToSafely($permission, $guardName);
        }
        
        $cachedPermissions = $this->getCachedPermissions();
        return in_array($permission, $cachedPermissions);
    }
}
```

### æ‰¹é‡æƒé™é¢„åŠ è½½

```php
// åœ¨æ§åˆ¶å™¨ä¸­é¢„åŠ è½½æƒé™æ•°æ®
class DashboardController extends Controller
{
    public function index()
    {
        $user = auth()->user();
        
        // é¢„åŠ è½½ç”¨æˆ·è§’è‰²å’Œæƒé™
        $user->load(['roles.permissions']);
        
        // æ‰¹é‡æ£€æŸ¥æƒé™
        $permissions = [
            'view_orders', 'create_orders', 'edit_orders', 'delete_orders',
            'view_products', 'create_products', 'edit_products', 'delete_products',
            'view_customers', 'create_customers', 'edit_customers', 'delete_customers'
        ];
        
        $userPermissions = [];
        foreach ($permissions as $permission) {
            $userPermissions[$permission] = $user->hasPermissionToSafely($permission);
        }
        
        return view('dashboard', compact('userPermissions'));
    }
}
```

é€šè¿‡è¿™äº›æƒé™ç®¡ç†æ–¹æ³•å’Œæœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥æ„å»ºä¸€ä¸ªå®‰å…¨ã€é«˜æ•ˆã€æ˜“ç»´æŠ¤çš„æƒé™ç³»ç»Ÿã€‚è®°ä½å§‹ç»ˆä½¿ç”¨å®‰å…¨æ–¹æ³•ï¼Œåˆç†åˆ©ç”¨ç¼“å­˜ï¼Œå¹¶åœ¨å‰ç«¯è¿›è¡Œé€‚å½“çš„æƒé™æ§åˆ¶ã€‚ 