# è§’è‰²ç®¡ç†

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†è§’è‰²ç®¡ç†çš„å„ç§æ“ä½œï¼ŒåŒ…æ‹¬è§’è‰²åˆ†é…ã€ç§»é™¤ã€æŸ¥è¯¢å’Œè·¨å›¢é˜Ÿç®¡ç†ã€‚

## ğŸ“š ç›®å½•

- [ğŸ­ è§’è‰²åˆ†é…](#-è§’è‰²åˆ†é…)
  - [åŸºæœ¬è§’è‰²åˆ†é…](#åŸºæœ¬è§’è‰²åˆ†é…)
    - [assignRoleSafely()](#assignrolesafely)
    - [è§’è‰²åˆ†é…éªŒè¯](#è§’è‰²åˆ†é…éªŒè¯)
  - [è·¨å›¢é˜Ÿè§’è‰²åˆ†é…](#è·¨å›¢é˜Ÿè§’è‰²åˆ†é…)
    - [assignRoleInTeam()](#assignroleinteam)
    - [ç®¡ç†å‘˜è·¨å›¢é˜Ÿåˆ†é…ç¤ºä¾‹](#ç®¡ç†å‘˜è·¨å›¢é˜Ÿåˆ†é…ç¤ºä¾‹)

- [ğŸ—‘ï¸ è§’è‰²ç§»é™¤](#ï¸-è§’è‰²ç§»é™¤)
  - [åˆ é™¤ç”¨æˆ·è§’è‰²](#åˆ é™¤ç”¨æˆ·è§’è‰²)
    - [removeRoleSafely()](#removerolesafely)
    - [removeRoleInTeam()](#removeroleinteam)
    - [åŸç”Ÿåˆ é™¤è§’è‰²æ–¹æ³•](#åŸç”Ÿåˆ é™¤è§’è‰²æ–¹æ³•)
  - [è·¨å›¢é˜Ÿè§’è‰²ç§»é™¤](#è·¨å›¢é˜Ÿè§’è‰²ç§»é™¤)
  - [ä»è§’è‰²ä¸­åˆ é™¤æƒé™](#ä»è§’è‰²ä¸­åˆ é™¤æƒé™)
    - [revokePermissionTo()](#revokepermissionto)
    - [æ‰¹é‡åˆ é™¤è§’è‰²æƒé™](#æ‰¹é‡åˆ é™¤è§’è‰²æƒé™)
    - [å®‰å…¨åˆ é™¤è§’è‰²æƒé™](#å®‰å…¨åˆ é™¤è§’è‰²æƒé™)
  - [è§’è‰²æƒé™åŒæ­¥åˆ é™¤](#è§’è‰²æƒé™åŒæ­¥åˆ é™¤)
    - [syncPermissions()](#syncpermissions)
  - [è§’è‰²æƒé™åˆ é™¤æœåŠ¡](#è§’è‰²æƒé™åˆ é™¤æœåŠ¡)
    - [åˆ›å»ºè§’è‰²æƒé™åˆ é™¤æœåŠ¡](#åˆ›å»ºè§’è‰²æƒé™åˆ é™¤æœåŠ¡)
  - [å¤šå›¢é˜Ÿè§’è‰²æƒé™åˆ é™¤](#å¤šå›¢é˜Ÿè§’è‰²æƒé™åˆ é™¤)
    - [è·¨å›¢é˜Ÿæ‰¹é‡åˆ é™¤è§’è‰²æƒé™](#è·¨å›¢é˜Ÿæ‰¹é‡åˆ é™¤è§’è‰²æƒé™)
    - [å¤šå›¢é˜Ÿè§’è‰²æƒé™ç®¡ç†æœåŠ¡](#å¤šå›¢é˜Ÿè§’è‰²æƒé™ç®¡ç†æœåŠ¡)
    - [å¤šå›¢é˜Ÿæƒé™åˆ é™¤çš„æœ€ä½³å®è·µ](#å¤šå›¢é˜Ÿæƒé™åˆ é™¤çš„æœ€ä½³å®è·µ)
  - [è§’è‰²æƒé™åˆ é™¤çš„æœ€ä½³å®è·µ](#è§’è‰²æƒé™åˆ é™¤çš„æœ€ä½³å®è·µ)
    - [åˆ é™¤å‰éªŒè¯](#åˆ é™¤å‰éªŒè¯)
    - [åˆ é™¤æƒé™æ—¥å¿—è®°å½•](#åˆ é™¤æƒé™æ—¥å¿—è®°å½•)
    - [å½±å“ç”¨æˆ·é€šçŸ¥](#å½±å“ç”¨æˆ·é€šçŸ¥)
    - [æƒé™åˆ é™¤å›æ»š](#æƒé™åˆ é™¤å›æ»š)

- [ğŸ”„ è§’è‰²åŒæ­¥](#-è§’è‰²åŒæ­¥)
  - [syncRolesSafely()](#syncrolessafely)
  - [è·¨å›¢é˜Ÿè§’è‰²åŒæ­¥](#è·¨å›¢é˜Ÿè§’è‰²åŒæ­¥)

- [ğŸ” è§’è‰²æŸ¥è¯¢](#-è§’è‰²æŸ¥è¯¢)
  - [åŸºæœ¬è§’è‰²æŸ¥è¯¢](#åŸºæœ¬è§’è‰²æŸ¥è¯¢)
  - [è·¨å›¢é˜Ÿè§’è‰²æŸ¥è¯¢](#è·¨å›¢é˜Ÿè§’è‰²æŸ¥è¯¢)
    - [getRolesInTeam()](#getrolesinteam)
    - [getAllRoles()](#getallroles)
  - [é«˜çº§è§’è‰²æŸ¥è¯¢](#é«˜çº§è§’è‰²æŸ¥è¯¢)

- [ğŸ” é€šè¿‡è§’è‰²æŸ¥è¯¢æƒé™](#-é€šè¿‡è§’è‰²æŸ¥è¯¢æƒé™)
  - [è·å–è§’è‰²æƒé™](#è·å–è§’è‰²æƒé™)
    - [è·å–è§’è‰²çš„æ‰€æœ‰æƒé™](#è·å–è§’è‰²çš„æ‰€æœ‰æƒé™)
    - [æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ç‰¹å®šæƒé™](#æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ç‰¹å®šæƒé™)
  - [é€šè¿‡ç”¨æˆ·è§’è‰²æŸ¥è¯¢æƒé™](#é€šè¿‡ç”¨æˆ·è§’è‰²æŸ¥è¯¢æƒé™)
    - [è·å–ç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—çš„æƒé™](#è·å–ç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—çš„æƒé™)
    - [åŒºåˆ†ç›´æ¥æƒé™å’Œè§’è‰²æƒé™](#åŒºåˆ†ç›´æ¥æƒé™å’Œè§’è‰²æƒé™)
  - [è·¨å›¢é˜Ÿè§’è‰²æƒé™æŸ¥è¯¢](#è·¨å›¢é˜Ÿè§’è‰²æƒé™æŸ¥è¯¢)
    - [æŸ¥è¯¢ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿçš„è§’è‰²æƒé™](#æŸ¥è¯¢ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿçš„è§’è‰²æƒé™)
    - [æŸ¥è¯¢ç‰¹å®šå›¢é˜Ÿçš„è§’è‰²æƒé™](#æŸ¥è¯¢ç‰¹å®šå›¢é˜Ÿçš„è§’è‰²æƒé™)
  - [è§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡](#è§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡)
    - [åˆ›å»ºè§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡](#åˆ›å»ºè§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡)
  - [æƒé™ç»§æ‰¿æŸ¥è¯¢](#æƒé™ç»§æ‰¿æŸ¥è¯¢)
    - [æŸ¥è¯¢æƒé™ç»§æ‰¿å…³ç³»](#æŸ¥è¯¢æƒé™ç»§æ‰¿å…³ç³»)
  - [æƒé™æŸ¥è¯¢ä¼˜åŒ–](#æƒé™æŸ¥è¯¢ä¼˜åŒ–)
    - [æ‰¹é‡æƒé™æŸ¥è¯¢](#æ‰¹é‡æƒé™æŸ¥è¯¢)

- [ğŸ¯ è§’è‰²ç®¡ç†æœ€ä½³å®è·µ](#-è§’è‰²ç®¡ç†æœ€ä½³å®è·µ)
  - [è§’è‰²åˆ†é…ç­–ç•¥](#è§’è‰²åˆ†é…ç­–ç•¥)
  - [è§’è‰²å˜æ›´é€šçŸ¥](#è§’è‰²å˜æ›´é€šçŸ¥)
  - [è§’è‰²æƒé™éªŒè¯](#è§’è‰²æƒé™éªŒè¯)

---

## ğŸ­ è§’è‰²åˆ†é…

### åŸºæœ¬è§’è‰²åˆ†é…

#### assignRoleSafely()
æ¨èçš„è§’è‰²åˆ†é…æ–¹æ³•ï¼Œè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„å½“å‰å›¢é˜Ÿã€‚

```php
$user = User::find(1);

// åˆ†é…å•ä¸ªè§’è‰²åˆ°å½“å‰å›¢é˜Ÿ
$user->assignRoleSafely('creator');

// åˆ†é…å¤šä¸ªè§’è‰²
$user->assignRoleSafely(['creator', 'editor']);

// é“¾å¼è°ƒç”¨
$user->assignRoleSafely('creator')
     ->assignRoleSafely('approver');

// éªŒè¯è§’è‰²åˆ†é…
if ($user->hasRole('creator')) {
    echo "ç”¨æˆ·å·²æˆåŠŸåˆ†é…creatorè§’è‰²";
}
```

#### è§’è‰²åˆ†é…éªŒè¯

```php
// å¸¦éªŒè¯çš„è§’è‰²åˆ†é…
function assignRoleWithValidation(User $user, string $role): bool
{
    try {
        // æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨äºç”¨æˆ·å½“å‰å›¢é˜Ÿ
        $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
            ->where('team_id', $user->current_team_id)
            ->exists();
        
        if (!$roleExists) {
            throw new InvalidArgumentException("è§’è‰² '{$role}' åœ¨å›¢é˜Ÿ {$user->current_team_id} ä¸­ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰è¯¥è§’è‰²
        if ($user->hasRole($role)) {
            echo "ç”¨æˆ·å·²ç»æ‹¥æœ‰ '{$role}' è§’è‰²";
            return true;
        }
        
        // åˆ†é…è§’è‰²
        $user->assignRoleSafely($role);
        
        Log::info('è§’è‰²åˆ†é…æˆåŠŸ', [
            'user_id' => $user->id,
            'role' => $role,
            'team_id' => $user->current_team_id
        ]);
        
        return true;
        
    } catch (Exception $e) {
        Log::error('è§’è‰²åˆ†é…å¤±è´¥', [
            'user_id' => $user->id,
            'role' => $role,
            'error' => $e->getMessage()
        ]);
        
        return false;
    }
}

// ä½¿ç”¨éªŒè¯å‡½æ•°
$success = assignRoleWithValidation($user, 'creator');
if ($success) {
    echo "è§’è‰²åˆ†é…æˆåŠŸ";
} else {
    echo "è§’è‰²åˆ†é…å¤±è´¥";
}
```

### è·¨å›¢é˜Ÿè§’è‰²åˆ†é…

#### assignRoleInTeam()
åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åˆ†é…è§’è‰²ç»™ç”¨æˆ·ã€‚

```php
// åœ¨å›¢é˜Ÿ5ä¸­åˆ†é…viewerè§’è‰²
$user->assignRoleInTeam(5, 'viewer');

// åœ¨å›¢é˜Ÿ7ä¸­åˆ†é…å¤šä¸ªè§’è‰²
$user->assignRoleInTeam(7, ['editor', 'approver']);

// æ‰¹é‡è·¨å›¢é˜Ÿåˆ†é…
$teamRoleAssignments = [
    5 => ['viewer'],
    7 => ['editor', 'approver'],
    10 => ['creator']
];

foreach ($teamRoleAssignments as $teamId => $roles) {
    $user->assignRoleInTeam($teamId, $roles);
    echo "å·²åœ¨å›¢é˜Ÿ {$teamId} åˆ†é…è§’è‰²: " . implode(', ', $roles) . "\n";
}
```

#### ç®¡ç†å‘˜è·¨å›¢é˜Ÿåˆ†é…ç¤ºä¾‹

```php
// ç®¡ç†å‘˜åˆ†é…ç”¨æˆ·åˆ°å¤šä¸ªå›¢é˜Ÿ
class TeamManagementService
{
    public function assignUserToMultipleTeams(User $user, array $teamAssignments): array
    {
        $results = [];
        
        foreach ($teamAssignments as $teamId => $role) {
            try {
                // éªŒè¯å›¢é˜Ÿå­˜åœ¨
                $team = Team::findOrFail($teamId);
                
                // éªŒè¯è§’è‰²å­˜åœ¨äºè¯¥å›¢é˜Ÿ
                $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
                    ->where('team_id', $teamId)
                    ->exists();
                
                if (!$roleExists) {
                    throw new Exception("è§’è‰² '{$role}' åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨");
                }
                
                // åˆ†é…è§’è‰²
                $user->assignRoleInTeam($teamId, $role);
                
                $results[$teamId] = [
                    'success' => true,
                    'message' => "æˆåŠŸåˆ†é…è§’è‰² '{$role}' åˆ°å›¢é˜Ÿ '{$team->name}'"
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
}

// ä½¿ç”¨æœåŠ¡
$service = new TeamManagementService();
$assignments = [
    5 => 'viewer',
    7 => 'editor',
    10 => 'creator'
];

$results = $service->assignUserToMultipleTeams($user, $assignments);
foreach ($results as $teamId => $result) {
    echo "å›¢é˜Ÿ {$teamId}: " . $result['message'] . "\n";
}
```

## ğŸ—‘ï¸ è§’è‰²ç§»é™¤

### åˆ é™¤ç”¨æˆ·è§’è‰²

#### removeRoleSafely()
å®‰å…¨åœ°åˆ é™¤ç”¨æˆ·è§’è‰²ï¼ˆè‡ªåŠ¨ä½¿ç”¨å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡ï¼‰ã€‚

```php
// åˆ é™¤å•ä¸ªè§’è‰²
$user->removeRoleSafely('creator');

// åˆ é™¤å¤šä¸ªè§’è‰²
$user->removeRoleSafely(['creator', 'editor']);

// é“¾å¼è°ƒç”¨
$user->removeRoleSafely('creator')
     ->removeRoleSafely('editor');
```

#### removeRoleInTeam()
åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åˆ é™¤ç”¨æˆ·è§’è‰²ã€‚

```php
// åœ¨å›¢é˜Ÿ7ä¸­åˆ é™¤viewerè§’è‰²
$user->removeRoleInTeam(7, 'viewer');

// åœ¨å›¢é˜Ÿ7ä¸­åˆ é™¤å¤šä¸ªè§’è‰²
$user->removeRoleInTeam(7, ['editor', 'approver']);
```

#### åŸç”Ÿåˆ é™¤è§’è‰²æ–¹æ³•
```php
// éœ€è¦å…ˆè®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);

// åˆ é™¤å•ä¸ªè§’è‰²
$user->removeRole('viewer');

// åˆ é™¤å¤šä¸ªè§’è‰²
foreach (['creator', 'editor'] as $role) {
    $user->removeRole($role);
}
```


### è·¨å›¢é˜Ÿè§’è‰²ç§»é™¤

```php
// ç§»é™¤æŒ‡å®šå›¢é˜Ÿçš„è§’è‰²
$user->withTeamContext(5, function($user) {
    $user->removeRole('viewer');
});

// æ‰¹é‡ç§»é™¤è·¨å›¢é˜Ÿè§’è‰²
function removeRolesFromTeams(User $user, array $teamRoles): void
{
    foreach ($teamRoles as $teamId => $roles) {
        $user->withTeamContext($teamId, function($user) use ($roles) {
            $user->removeRole($roles);
        });
        
        echo "å·²ä»å›¢é˜Ÿ {$teamId} ç§»é™¤è§’è‰²: " . implode(', ', (array)$roles) . "\n";
    }
}

// ä½¿ç”¨ç¤ºä¾‹
$teamRolesToRemove = [
    5 => 'viewer',
    7 => ['editor', 'approver']
];

removeRolesFromTeams($user, $teamRolesToRemove);
```

### ä»è§’è‰²ä¸­åˆ é™¤æƒé™

#### revokePermissionTo()
ä»è§’è‰²ä¸­åˆ é™¤æƒé™ï¼Œå½±å“æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ã€‚

```php
// ä»è§’è‰²ä¸­åˆ é™¤å•ä¸ªæƒé™
$role = \Spatie\Permission\Models\Role::findByName('editor');
$role->revokePermissionTo('delete_orders');

// ä»è§’è‰²ä¸­åˆ é™¤å¤šä¸ªæƒé™
$role->revokePermissionTo(['delete_orders', 'approve_orders']);

// åˆ é™¤æƒé™å¯¹è±¡
$permission = \Spatie\Permission\Models\Permission::findByName('delete_orders');
$role->revokePermissionTo($permission);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åˆ é™¤è§’è‰²æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$role = \Spatie\Permission\Models\Role::find(22);
$role->revokePermissionTo('view_orders');
```

#### æ‰¹é‡åˆ é™¤è§’è‰²æƒé™
```php
// æ‰¹é‡åˆ é™¤è§’è‰²çš„å¤šä¸ªæƒé™
function batchRevokeRolePermissions(string $roleName, array $permissions, int $teamId): array
{
    // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->first();
    
    if (!$role) {
        throw new \Exception("è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨");
    }
    
    $revokedPermissions = [];
    foreach ($permissions as $permission) {
        if ($role->hasPermissionTo($permission)) {
            $role->revokePermissionTo($permission);
            $revokedPermissions[] = $permission;
        }
    }
    
    // æ¸…é™¤æƒé™ç¼“å­˜
    app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
    
    return $revokedPermissions;
}

// ä½¿ç”¨ç¤ºä¾‹
$revokedPermissions = batchRevokeRolePermissions('editor', ['delete_orders', 'approve_orders'], 7);
echo "å·²ä»ç¼–è¾‘è€…è§’è‰²åˆ é™¤æƒé™: " . implode(', ', $revokedPermissions) . "\n";
```

#### å®‰å…¨åˆ é™¤è§’è‰²æƒé™
```php
// å®‰å…¨åˆ é™¤è§’è‰²æƒé™ï¼ˆå¸¦éªŒè¯ï¼‰
function safeRevokeRolePermission(string $roleName, string $permission, int $teamId): bool
{
    try {
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            echo "è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨\n";
            return false;
        }
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰è¯¥æƒé™
        if (!$role->hasPermissionTo($permission)) {
            echo "è§’è‰² {$roleName} æ²¡æœ‰æƒé™ {$permission}\n";
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å…³é”®æƒé™ï¼ˆå¦‚å›¢é˜Ÿæ‰€æœ‰è€…çš„ç®¡ç†æƒé™ï¼‰
        $criticalPermissions = ['manage_team', 'delete_team', 'manage_team_members'];
        if (in_array($permission, $criticalPermissions) && $roleName === 'owner') {
            echo "æ— æ³•åˆ é™¤å›¢é˜Ÿæ‰€æœ‰è€…çš„å…³é”®æƒé™ {$permission}\n";
            return false;
        }
        
        // æ‰§è¡Œåˆ é™¤
        $role->revokePermissionTo($permission);
        
        // æ¸…é™¤ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        echo "æˆåŠŸä»è§’è‰² {$roleName} åˆ é™¤æƒé™ {$permission}\n";
        return true;
        
    } catch (\Exception $e) {
        echo "åˆ é™¤æƒé™å¤±è´¥: " . $e->getMessage() . "\n";
        return false;
    }
}

// ä½¿ç”¨å®‰å…¨åˆ é™¤æ–¹æ³•
$success = safeRevokeRolePermission('editor', 'delete_orders', 7);
```

### è§’è‰²æƒé™åŒæ­¥åˆ é™¤

#### syncPermissions()
åŒæ­¥è§’è‰²æƒé™ï¼ˆæ›¿æ¢è§’è‰²çš„æ‰€æœ‰æƒé™ï¼‰ã€‚

```php
// è®¾ç½®è§’è‰²çš„æ‰€æœ‰æƒé™ï¼ˆæ›¿æ¢ç°æœ‰æƒé™ï¼‰
$role = \Spatie\Permission\Models\Role::findByName('editor');
$role->syncPermissions(['view_orders', 'edit_orders', 'create_orders']);

// æ¸…ç©ºè§’è‰²çš„æ‰€æœ‰æƒé™
$role->syncPermissions([]);

// åœ¨æŒ‡å®šå›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­åŒæ­¥è§’è‰²æƒé™
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$role = \Spatie\Permission\Models\Role::find(22);
$role->syncPermissions(['view_orders']); // åªä¿ç•™æŸ¥çœ‹æƒé™
```

### è§’è‰²æƒé™åˆ é™¤æœåŠ¡

#### åˆ›å»ºè§’è‰²æƒé™åˆ é™¤æœåŠ¡
```php
class RolePermissionRevocationService
{
    /**
     * ä»è§’è‰²ä¸­åˆ é™¤ç‰¹å®šæƒé™
     */
    public function revokePermissionsFromRole(string $roleName, array $permissions, int $teamId): array
    {
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            throw new \Exception("è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨");
        }
        
        $revokedPermissions = [];
        $skippedPermissions = [];
        
        foreach ($permissions as $permission) {
            if ($role->hasPermissionTo($permission)) {
                $role->revokePermissionTo($permission);
                $revokedPermissions[] = $permission;
            } else {
                $skippedPermissions[] = $permission;
            }
        }
        
        // æ¸…é™¤ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'revoked' => $revokedPermissions,
            'skipped' => $skippedPermissions,
            'role' => $roleName,
            'team_id' => $teamId
        ];
    }
    
    /**
     * æ‰¹é‡ä»å¤šä¸ªè§’è‰²åˆ é™¤æƒé™
     */
    public function bulkRevokePermissionsFromRoles(array $rolePermissions, int $teamId): array
    {
        $results = [];
        
        foreach ($rolePermissions as $roleName => $permissions) {
            try {
                $result = $this->revokePermissionsFromRole($roleName, $permissions, $teamId);
                $results[$roleName] = $result;
            } catch (\Exception $e) {
                $results[$roleName] = [
                    'error' => $e->getMessage(),
                    'role' => $roleName,
                    'team_id' => $teamId
                ];
            }
        }
        
        return $results;
    }
    
    /**
     * é™çº§è§’è‰²æƒé™
     */
    public function downgradeRolePermissions(string $roleName, int $teamId): array
    {
        // å®šä¹‰æƒé™ç­‰çº§
        $permissionLevels = [
            'delete' => 5,    // åˆ é™¤æƒé™
            'approve' => 4,   // å®¡æ‰¹æƒé™
            'edit' => 3,      // ç¼–è¾‘æƒé™
            'create' => 2,    // åˆ›å»ºæƒé™
            'view' => 1       // æŸ¥çœ‹æƒé™
        ];
        
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            throw new \Exception("è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨");
        }
        
        $currentPermissions = $role->permissions->pluck('name')->toArray();
        $revokedPermissions = [];
        
        // æ ¹æ®è§’è‰²ç±»å‹ç¡®å®šè¦åˆ é™¤çš„æƒé™ç­‰çº§
        $maxLevel = match($roleName) {
            'viewer' => 1,      // åªä¿ç•™æŸ¥çœ‹æƒé™
            'creator' => 2,     // ä¿ç•™æŸ¥çœ‹å’Œåˆ›å»ºæƒé™
            'editor' => 3,      // ä¿ç•™æŸ¥çœ‹ã€åˆ›å»ºå’Œç¼–è¾‘æƒé™
            'approver' => 4,    // ä¿ç•™æŸ¥çœ‹ã€åˆ›å»ºã€ç¼–è¾‘å’Œå®¡æ‰¹æƒé™
            default => 5        // ä¿ç•™æ‰€æœ‰æƒé™
        };
        
        foreach ($currentPermissions as $permission) {
            // è§£ææƒé™ç­‰çº§
            $level = 1; // é»˜è®¤ä¸ºæŸ¥çœ‹æƒé™
            foreach ($permissionLevels as $action => $actionLevel) {
                if (str_contains($permission, $action)) {
                    $level = $actionLevel;
                    break;
                }
            }
            
            // å¦‚æœæƒé™ç­‰çº§è¶…è¿‡è§’è‰²å…è®¸çš„æœ€å¤§ç­‰çº§ï¼Œåˆ™åˆ é™¤
            if ($level > $maxLevel) {
                $role->revokePermissionTo($permission);
                $revokedPermissions[] = $permission;
            }
        }
        
        // æ¸…é™¤ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'role' => $roleName,
            'team_id' => $teamId,
            'max_level' => $maxLevel,
            'revoked_permissions' => $revokedPermissions,
            'remaining_permissions' => array_diff($currentPermissions, $revokedPermissions)
        ];
    }
    
    /**
     * æ¸…ç†è¿‡æœŸæƒé™
     */
    public function cleanupExpiredRolePermissions(int $teamId): array
    {
        // å‡è®¾æƒé™æœ‰è¿‡æœŸæ—¶é—´å­—æ®µ
        $expiredPermissions = \Spatie\Permission\Models\Permission::where('team_id', $teamId)
            ->where('expires_at', '<', now())
            ->get();
        
        $results = [];
        
        foreach ($expiredPermissions as $permission) {
            $rolesWithPermission = \Spatie\Permission\Models\Role::whereHas('permissions', function($query) use ($permission) {
                $query->where('id', $permission->id);
            })->where('team_id', $teamId)->get();
            
            foreach ($rolesWithPermission as $role) {
                $role->revokePermissionTo($permission);
                
                if (!isset($results[$role->name])) {
                    $results[$role->name] = [];
                }
                $results[$role->name][] = $permission->name;
            }
        }
        
        // æ¸…é™¤ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
}

// ä½¿ç”¨è§’è‰²æƒé™åˆ é™¤æœåŠ¡
$revocationService = new RolePermissionRevocationService();

// ä»å•ä¸ªè§’è‰²åˆ é™¤æƒé™
$result = $revocationService->revokePermissionsFromRole('editor', ['delete_orders', 'approve_orders'], 7);
echo "ä»ç¼–è¾‘è€…è§’è‰²åˆ é™¤çš„æƒé™: " . implode(', ', $result['revoked']) . "\n";

// æ‰¹é‡ä»å¤šä¸ªè§’è‰²åˆ é™¤æƒé™
$rolePermissions = [
    'editor' => ['delete_orders', 'approve_orders'],
    'creator' => ['delete_orders'],
    'viewer' => ['edit_orders', 'create_orders']
];
$results = $revocationService->bulkRevokePermissionsFromRoles($rolePermissions, 7);

foreach ($results as $roleName => $result) {
    if (isset($result['error'])) {
        echo "è§’è‰² {$roleName} åˆ é™¤å¤±è´¥: {$result['error']}\n";
    } else {
        echo "è§’è‰² {$roleName} åˆ é™¤çš„æƒé™: " . implode(', ', $result['revoked']) . "\n";
    }
}

// é™çº§è§’è‰²æƒé™
$downgradeResult = $revocationService->downgradeRolePermissions('editor', 7);
echo "ç¼–è¾‘è€…è§’è‰²é™çº§ï¼Œåˆ é™¤çš„æƒé™: " . implode(', ', $downgradeResult['revoked_permissions']) . "\n";

// æ¸…ç†è¿‡æœŸæƒé™
$cleanupResults = $revocationService->cleanupExpiredRolePermissions(7);
foreach ($cleanupResults as $roleName => $expiredPermissions) {
    echo "è§’è‰² {$roleName} æ¸…ç†çš„è¿‡æœŸæƒé™: " . implode(', ', $expiredPermissions) . "\n";
}
```

### å¤šå›¢é˜Ÿè§’è‰²æƒé™åˆ é™¤

#### è·¨å›¢é˜Ÿæ‰¹é‡åˆ é™¤è§’è‰²æƒé™
```php
// è·¨å¤šä¸ªå›¢é˜Ÿåˆ é™¤è§’è‰²æƒé™
function revokeRolePermissionsAcrossTeams(string $roleName, array $permissions, array $teamIds): array
{
    $results = [];
    
    foreach ($teamIds as $teamId) {
        try {
            // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $teamId)
                ->first();
            
            if (!$role) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => "è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨"
                ];
                continue;
            }
            
            $revokedPermissions = [];
            foreach ($permissions as $permission) {
                if ($role->hasPermissionTo($permission)) {
                    $role->revokePermissionTo($permission);
                    $revokedPermissions[] = $permission;
                }
            }
            
            $results[$teamId] = [
                'success' => true,
                'role' => $roleName,
                'revoked_permissions' => $revokedPermissions,
                'message' => "æˆåŠŸåˆ é™¤ " . count($revokedPermissions) . " ä¸ªæƒé™"
            ];
            
        } catch (\Exception $e) {
            $results[$teamId] = [
                'success' => false,
                'message' => $e->getMessage()
            ];
        }
    }
    
    // æ¸…é™¤æƒé™ç¼“å­˜
    app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
    
    return $results;
}

// ä½¿ç”¨ç¤ºä¾‹
$teamIds = [5, 7, 10, 15];
$permissions = ['delete_orders', 'approve_orders'];
$results = revokeRolePermissionsAcrossTeams('editor', $permissions, $teamIds);

foreach ($results as $teamId => $result) {
    if ($result['success']) {
        echo "å›¢é˜Ÿ {$teamId}: {$result['message']}\n";
        echo "  åˆ é™¤çš„æƒé™: " . implode(', ', $result['revoked_permissions']) . "\n";
    } else {
        echo "å›¢é˜Ÿ {$teamId}: å¤±è´¥ - {$result['message']}\n";
    }
}
```

#### å¤šå›¢é˜Ÿè§’è‰²æƒé™ç®¡ç†æœåŠ¡
```php
class MultiTeamRolePermissionService
{
    /**
     * åœ¨æ‰€æœ‰å›¢é˜Ÿä¸­åˆ é™¤è§’è‰²çš„ç‰¹å®šæƒé™
     */
    public function revokePermissionFromRoleGlobally(string $roleName, array $permissions): array
    {
        $teams = Team::all();
        $results = [];
        
        foreach ($teams as $team) {
            try {
                // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($team->id);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $team->id)
                    ->first();
                
                if (!$role) {
                    $results[$team->id] = [
                        'team_name' => $team->name,
                        'success' => false,
                        'message' => "è§’è‰²ä¸å­˜åœ¨"
                    ];
                    continue;
                }
                
                $revokedPermissions = [];
                foreach ($permissions as $permission) {
                    if ($role->hasPermissionTo($permission)) {
                        $role->revokePermissionTo($permission);
                        $revokedPermissions[] = $permission;
                    }
                }
                
                $results[$team->id] = [
                    'team_name' => $team->name,
                    'success' => true,
                    'revoked_permissions' => $revokedPermissions,
                    'count' => count($revokedPermissions)
                ];
                
            } catch (\Exception $e) {
                $results[$team->id] = [
                    'team_name' => $team->name,
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // æ¸…é™¤æƒé™ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * åœ¨æŒ‡å®šå›¢é˜Ÿä¸­åŒæ­¥è§’è‰²æƒé™
     */
    public function syncRolePermissionsAcrossTeams(string $roleName, array $permissions, array $teamIds): array
    {
        $results = [];
        
        foreach ($teamIds as $teamId) {
            try {
                // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $teamId)
                    ->first();
                
                if (!$role) {
                    $results[$teamId] = [
                        'success' => false,
                        'message' => "è§’è‰²ä¸å­˜åœ¨"
                    ];
                    continue;
                }
                
                // è·å–å½“å‰æƒé™
                $currentPermissions = $role->permissions->pluck('name')->toArray();
                
                // åŒæ­¥æƒé™
                $role->syncPermissions($permissions);
                
                $results[$teamId] = [
                    'success' => true,
                    'previous_permissions' => $currentPermissions,
                    'new_permissions' => $permissions,
                    'added' => array_diff($permissions, $currentPermissions),
                    'removed' => array_diff($currentPermissions, $permissions)
                ];
                
            } catch (\Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // æ¸…é™¤æƒé™ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * æ‰¹é‡é™çº§å¤šä¸ªå›¢é˜Ÿçš„è§’è‰²æƒé™
     */
    public function bulkDowngradeRolePermissions(string $roleName, array $teamIds, int $maxPermissionLevel = 3): array
    {
        $permissionLevels = [
            'delete' => 5,
            'approve' => 4,
            'edit' => 3,
            'create' => 2,
            'view' => 1
        ];
        
        $results = [];
        
        foreach ($teamIds as $teamId) {
            try {
                // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $teamId)
                    ->first();
                
                if (!$role) {
                    $results[$teamId] = [
                        'success' => false,
                        'message' => "è§’è‰²ä¸å­˜åœ¨"
                    ];
                    continue;
                }
                
                $currentPermissions = $role->permissions->pluck('name')->toArray();
                $revokedPermissions = [];
                
                foreach ($currentPermissions as $permission) {
                    $level = 1; // é»˜è®¤ä¸ºæŸ¥çœ‹æƒé™
                    foreach ($permissionLevels as $action => $actionLevel) {
                        if (str_contains($permission, $action)) {
                            $level = $actionLevel;
                            break;
                        }
                    }
                    
                    if ($level > $maxPermissionLevel) {
                        $role->revokePermissionTo($permission);
                        $revokedPermissions[] = $permission;
                    }
                }
                
                $results[$teamId] = [
                    'success' => true,
                    'max_level' => $maxPermissionLevel,
                    'revoked_permissions' => $revokedPermissions,
                    'remaining_permissions' => array_diff($currentPermissions, $revokedPermissions)
                ];
                
            } catch (\Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // æ¸…é™¤æƒé™ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * è·å–è§’è‰²åœ¨æ‰€æœ‰å›¢é˜Ÿçš„æƒé™å·®å¼‚æŠ¥å‘Š
     */
    public function getRolePermissionDifferenceReport(string $roleName): array
    {
        $teams = Team::all();
        $report = [
            'role_name' => $roleName,
            'teams' => [],
            'permission_summary' => []
        ];
        
        $allPermissions = collect();
        
        foreach ($teams as $team) {
            // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($team->id);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $team->id)
                ->first();
            
            if ($role) {
                $permissions = $role->permissions->pluck('name')->toArray();
                $report['teams'][$team->id] = [
                    'team_name' => $team->name,
                    'permissions' => $permissions,
                    'permission_count' => count($permissions)
                ];
                
                $allPermissions = $allPermissions->merge($permissions);
            } else {
                $report['teams'][$team->id] = [
                    'team_name' => $team->name,
                    'permissions' => [],
                    'permission_count' => 0,
                    'note' => 'è§’è‰²ä¸å­˜åœ¨'
                ];
            }
        }
        
        // ç”Ÿæˆæƒé™æ‘˜è¦
        $uniquePermissions = $allPermissions->unique()->values()->toArray();
        $report['permission_summary'] = [
            'total_unique_permissions' => count($uniquePermissions),
            'permissions' => $uniquePermissions,
            'teams_with_role' => count(array_filter($report['teams'], function($team) {
                return !isset($team['note']);
            }))
        ];
        
        return $report;
    }
}

// ä½¿ç”¨å¤šå›¢é˜Ÿè§’è‰²æƒé™ç®¡ç†æœåŠ¡
$multiTeamService = new MultiTeamRolePermissionService();

// å…¨å±€åˆ é™¤è§’è‰²æƒé™
$globalResults = $multiTeamService->revokePermissionFromRoleGlobally('editor', ['delete_orders']);
echo "å…¨å±€åˆ é™¤ç¼–è¾‘è€…è§’è‰²çš„åˆ é™¤æƒé™:\n";
foreach ($globalResults as $teamId => $result) {
    if ($result['success']) {
        echo "  å›¢é˜Ÿ {$result['team_name']}: åˆ é™¤äº† {$result['count']} ä¸ªæƒé™\n";
    } else {
        echo "  å›¢é˜Ÿ {$result['team_name']}: å¤±è´¥ - {$result['message']}\n";
    }
}

// è·¨å›¢é˜ŸåŒæ­¥è§’è‰²æƒé™
$syncResults = $multiTeamService->syncRolePermissionsAcrossTeams(
    'editor', 
    ['view_orders', 'edit_orders', 'create_orders'], 
    [5, 7, 10]
);
echo "\nè·¨å›¢é˜ŸåŒæ­¥ç¼–è¾‘è€…è§’è‰²æƒé™:\n";
foreach ($syncResults as $teamId => $result) {
    if ($result['success']) {
        echo "  å›¢é˜Ÿ {$teamId}:\n";
        echo "    æ·»åŠ æƒé™: " . implode(', ', $result['added']) . "\n";
        echo "    åˆ é™¤æƒé™: " . implode(', ', $result['removed']) . "\n";
    }
}

// æ‰¹é‡é™çº§è§’è‰²æƒé™
$downgradeResults = $multiTeamService->bulkDowngradeRolePermissions('editor', [5, 7, 10], 3);
echo "\næ‰¹é‡é™çº§ç¼–è¾‘è€…è§’è‰²æƒé™ï¼ˆæœ€é«˜ç­‰çº§3ï¼‰:\n";
foreach ($downgradeResults as $teamId => $result) {
    if ($result['success']) {
        echo "  å›¢é˜Ÿ {$teamId}: åˆ é™¤äº† " . count($result['revoked_permissions']) . " ä¸ªé«˜çº§æƒé™\n";
    }
}

// è·å–è§’è‰²æƒé™å·®å¼‚æŠ¥å‘Š
$report = $multiTeamService->getRolePermissionDifferenceReport('editor');
echo "\nç¼–è¾‘è€…è§’è‰²æƒé™å·®å¼‚æŠ¥å‘Š:\n";
echo "æ€»è®¡å”¯ä¸€æƒé™: {$report['permission_summary']['total_unique_permissions']}\n";
echo "æ‹¥æœ‰è¯¥è§’è‰²çš„å›¢é˜Ÿæ•°: {$report['permission_summary']['teams_with_role']}\n";
```

#### å¤šå›¢é˜Ÿæƒé™åˆ é™¤çš„æœ€ä½³å®è·µ

##### 1. æ‰¹é‡æ“ä½œå‰çš„é¢„æ£€æŸ¥
```php
// å¤šå›¢é˜Ÿæ“ä½œå‰çš„é¢„æ£€æŸ¥
function preCheckMultiTeamRolePermissionRevocation(string $roleName, array $permissions, array $teamIds): array
{
    $checkResults = [];
    
    foreach ($teamIds as $teamId) {
        $team = Team::find($teamId);
        if (!$team) {
            $checkResults[$teamId] = [
                'valid' => false,
                'message' => 'å›¢é˜Ÿä¸å­˜åœ¨'
            ];
            continue;
        }
        
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            $checkResults[$teamId] = [
                'valid' => false,
                'team_name' => $team->name,
                'message' => 'è§’è‰²ä¸å­˜åœ¨'
            ];
            continue;
        }
        
        $existingPermissions = [];
        $missingPermissions = [];
        
        foreach ($permissions as $permission) {
            if ($role->hasPermissionTo($permission)) {
                $existingPermissions[] = $permission;
            } else {
                $missingPermissions[] = $permission;
            }
        }
        
        $checkResults[$teamId] = [
            'valid' => !empty($existingPermissions),
            'team_name' => $team->name,
            'role_exists' => true,
            'existing_permissions' => $existingPermissions,
            'missing_permissions' => $missingPermissions,
            'can_revoke_count' => count($existingPermissions)
        ];
    }
    
    return $checkResults;
}

// ä½¿ç”¨é¢„æ£€æŸ¥
$preCheckResults = preCheckMultiTeamRolePermissionRevocation('editor', ['delete_orders', 'approve_orders'], [5, 7, 10]);
foreach ($preCheckResults as $teamId => $result) {
    echo "å›¢é˜Ÿ {$teamId} ({$result['team_name']}): ";
    if ($result['valid']) {
        echo "å¯åˆ é™¤ {$result['can_revoke_count']} ä¸ªæƒé™\n";
    } else {
        echo "æ— æ³•æ“ä½œ - {$result['message']}\n";
    }
}
```

##### 2. å¤šå›¢é˜Ÿæ“ä½œçš„äº‹åŠ¡å¤„ç†
```php
// å¤šå›¢é˜Ÿæƒé™åˆ é™¤çš„äº‹åŠ¡å¤„ç†
function transactionalMultiTeamRolePermissionRevocation(string $roleName, array $permissions, array $teamIds): array
{
    DB::beginTransaction();
    
    try {
        $results = [];
        $rollbackData = [];
        
        foreach ($teamIds as $teamId) {
            // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $teamId)
                ->first();
            
            if (!$role) {
                continue;
            }
            
            // è®°å½•å½“å‰æƒé™ç”¨äºå›æ»š
            $currentPermissions = $role->permissions->pluck('name')->toArray();
            $rollbackData[$teamId] = $currentPermissions;
            
            // åˆ é™¤æƒé™
            $revokedPermissions = [];
            foreach ($permissions as $permission) {
                if ($role->hasPermissionTo($permission)) {
                    $role->revokePermissionTo($permission);
                    $revokedPermissions[] = $permission;
                }
            }
            
            $results[$teamId] = [
                'success' => true,
                'revoked_permissions' => $revokedPermissions
            ];
        }
        
        DB::commit();
        
        // æ¸…é™¤æƒé™ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'success' => true,
            'results' => $results,
            'rollback_data' => $rollbackData
        ];
        
    } catch (\Exception $e) {
        DB::rollback();
        
        return [
            'success' => false,
            'message' => $e->getMessage(),
            'rollback_data' => $rollbackData ?? []
        ];
    }
}
```

### è§’è‰²æƒé™åˆ é™¤çš„æœ€ä½³å®è·µ

#### 1. åˆ é™¤å‰éªŒè¯
```php
// åˆ é™¤è§’è‰²æƒé™å‰çš„å®‰å…¨æ£€æŸ¥
function validateRolePermissionRevocation(string $roleName, string $permission, int $teamId): bool
{
    // æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->first();
    
    if (!$role) {
        throw new \Exception("è§’è‰² {$roleName} ä¸å­˜åœ¨");
    }
    
    // æ£€æŸ¥æƒé™æ˜¯å¦å­˜åœ¨
    $permissionExists = \Spatie\Permission\Models\Permission::where('name', $permission)
        ->where('team_id', $teamId)
        ->exists();
    
    if (!$permissionExists) {
        throw new \Exception("æƒé™ {$permission} ä¸å­˜åœ¨");
    }
    
    // æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰è¯¥æƒé™
    if (!$role->hasPermissionTo($permission)) {
        throw new \Exception("è§’è‰² {$roleName} æ²¡æœ‰æƒé™ {$permission}");
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯å…³é”®æƒé™
    $criticalPermissions = ['manage_team', 'delete_team'];
    if (in_array($permission, $criticalPermissions) && $roleName === 'owner') {
        throw new \Exception("ä¸èƒ½åˆ é™¤å›¢é˜Ÿæ‰€æœ‰è€…çš„å…³é”®æƒé™");
    }
    
    return true;
}
```

#### 2. åˆ é™¤æƒé™æ—¥å¿—è®°å½•
```php
// è®°å½•è§’è‰²æƒé™åˆ é™¤æ“ä½œ
function logRolePermissionRevocation(string $roleName, string $permission, int $teamId, User $operator): void
{
    Log::info('Role permission revoked', [
        'role_name' => $roleName,
        'permission' => $permission,
        'team_id' => $teamId,
        'operator_id' => $operator->id,
        'operator_name' => $operator->name,
        'timestamp' => now(),
        'ip_address' => request()->ip()
    ]);
}

// åœ¨åˆ é™¤æƒé™æ—¶è°ƒç”¨
$role->revokePermissionTo('delete_orders');
logRolePermissionRevocation('editor', 'delete_orders', 7, auth()->user());
```

#### 3. å½±å“ç”¨æˆ·é€šçŸ¥
```php
// é€šçŸ¥å—å½±å“çš„ç”¨æˆ·
function notifyUsersOfRolePermissionRevocation(string $roleName, array $revokedPermissions, int $teamId): void
{
    // æŸ¥æ‰¾æ‹¥æœ‰è¯¥è§’è‰²çš„æ‰€æœ‰ç”¨æˆ·
    $affectedUsers = User::whereHas('roles', function($query) use ($roleName, $teamId) {
        $query->where('name', $roleName)->where('team_id', $teamId);
    })->get();
    
    foreach ($affectedUsers as $user) {
        $user->notify(new RolePermissionRevokedNotification([
            'role_name' => $roleName,
            'revoked_permissions' => $revokedPermissions,
            'team_id' => $teamId,
            'revoked_at' => now()
        ]));
    }
    
    echo "å·²é€šçŸ¥ " . $affectedUsers->count() . " ä¸ªç”¨æˆ·è§’è‰²æƒé™å˜æ›´\n";
}

// ä½¿ç”¨ç¤ºä¾‹
$revokedPermissions = ['delete_orders', 'approve_orders'];
notifyUsersOfRolePermissionRevocation('editor', $revokedPermissions, 7);
```

#### 4. æƒé™åˆ é™¤å›æ»š
```php
// æƒé™åˆ é™¤å›æ»šåŠŸèƒ½
class RolePermissionRevocationRollback
{
    private array $revocationHistory = [];
    
    public function recordRevocation(string $roleName, array $permissions, int $teamId): string
    {
        $rollbackId = uniqid('rollback_');
        $this->revocationHistory[$rollbackId] = [
            'role_name' => $roleName,
            'permissions' => $permissions,
            'team_id' => $teamId,
            'revoked_at' => now(),
            'operator_id' => auth()->id()
        ];
        
        return $rollbackId;
    }
    
    public function rollback(string $rollbackId): bool
    {
        if (!isset($this->revocationHistory[$rollbackId])) {
            throw new \Exception("å›æ»šè®°å½•ä¸å­˜åœ¨");
        }
        
        $record = $this->revocationHistory[$rollbackId];
        
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($record['team_id']);
        
        $role = \Spatie\Permission\Models\Role::where('name', $record['role_name'])
            ->where('team_id', $record['team_id'])
            ->first();
        
        if (!$role) {
            throw new \Exception("è§’è‰²ä¸å­˜åœ¨ï¼Œæ— æ³•å›æ»š");
        }
        
        // é‡æ–°åˆ†é…æƒé™
        $role->givePermissionTo($record['permissions']);
        
        // æ¸…é™¤ç¼“å­˜
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        // è®°å½•å›æ»šæ“ä½œ
        Log::info('Role permission revocation rolled back', [
            'rollback_id' => $rollbackId,
            'role_name' => $record['role_name'],
            'permissions' => $record['permissions'],
            'team_id' => $record['team_id'],
            'rolled_back_by' => auth()->id()
        ]);
        
        return true;
    }
}

// ä½¿ç”¨å›æ»šåŠŸèƒ½
$rollbackService = new RolePermissionRevocationRollback();

// è®°å½•åˆ é™¤æ“ä½œ
$rollbackId = $rollbackService->recordRevocation('editor', ['delete_orders', 'approve_orders'], 7);

// æ‰§è¡Œåˆ é™¤
$role->revokePermissionTo(['delete_orders', 'approve_orders']);

// å¦‚æœéœ€è¦å›æ»š
// $rollbackService->rollback($rollbackId);
```

## ğŸ”„ è§’è‰²åŒæ­¥

### syncRolesSafely()
æ›¿æ¢ç”¨æˆ·åœ¨å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰è§’è‰²ã€‚

```php
// åŒæ­¥è§’è‰²ï¼ˆæ›¿æ¢å½“å‰å›¢é˜Ÿçš„æ‰€æœ‰è§’è‰²ï¼‰
$user->syncRolesSafely(['editor', 'approver']);

// æ¸…ç©ºå½“å‰å›¢é˜Ÿçš„æ‰€æœ‰è§’è‰²
$user->syncRolesSafely([]);

// æ¡ä»¶æ€§è§’è‰²åŒæ­¥
function syncUserRoles(User $user, array $newRoles): array
{
    $currentRoles = $user->getRoleNames()->toArray();
    
    // æ¯”è¾ƒè§’è‰²å˜åŒ–
    $addedRoles = array_diff($newRoles, $currentRoles);
    $removedRoles = array_diff($currentRoles, $newRoles);
    
    // æ‰§è¡ŒåŒæ­¥
    $user->syncRolesSafely($newRoles);
    
    return [
        'added' => $addedRoles,
        'removed' => $removedRoles,
        'current' => $newRoles
    ];
}

// ä½¿ç”¨ç¤ºä¾‹
$changes = syncUserRoles($user, ['creator', 'approver']);
echo "æ·»åŠ çš„è§’è‰²: " . implode(', ', $changes['added']) . "\n";
echo "ç§»é™¤çš„è§’è‰²: " . implode(', ', $changes['removed']) . "\n";
```

### è·¨å›¢é˜Ÿè§’è‰²åŒæ­¥

```php
// åŒæ­¥ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿçš„è§’è‰²
class UserRoleSyncService
{
    public function syncUserRolesAcrossTeams(User $user, array $teamRoles): array
    {
        $results = [];
        
        foreach ($teamRoles as $teamId => $roles) {
            try {
                $user->withTeamContext($teamId, function($user) use ($roles) {
                    $user->syncRoles($roles);
                });
                
                $results[$teamId] = [
                    'success' => true,
                    'roles' => $roles
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'error' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
}

// ä½¿ç”¨æœåŠ¡
$syncService = new UserRoleSyncService();
$teamRoles = [
    5 => ['viewer'],
    7 => ['editor', 'approver'],
    10 => ['creator', 'editor']
];

$results = $syncService->syncUserRolesAcrossTeams($user, $teamRoles);
```

## ğŸ” è§’è‰²æŸ¥è¯¢

### åŸºæœ¬è§’è‰²æŸ¥è¯¢

```php
// è·å–å½“å‰å›¢é˜Ÿçš„è§’è‰²
$currentRoles = $user->roles;
foreach ($currentRoles as $role) {
    echo "è§’è‰²: {$role->name} (å›¢é˜Ÿ: {$role->team_id})\n";
}

// è·å–è§’è‰²åç§°
$roleNames = $user->getRoleNames();
echo "å½“å‰å›¢é˜Ÿè§’è‰²: " . $roleNames->implode(', ');

// æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
if ($user->hasRole('creator')) {
    echo "ç”¨æˆ·æ˜¯åˆ›å»ºè€…";
}

// æ£€æŸ¥æ˜¯å¦æœ‰ä»»æ„è§’è‰²
if ($user->hasAnyRole(['creator', 'editor', 'approver'])) {
    echo "ç”¨æˆ·æ˜¯å†…å®¹ç®¡ç†è€…";
}

// æ£€æŸ¥æ˜¯å¦æœ‰æ‰€æœ‰è§’è‰²
if ($user->hasAllRoles(['creator', 'editor'])) {
    echo "ç”¨æˆ·æ—¢æ˜¯åˆ›å»ºè€…åˆæ˜¯ç¼–è¾‘è€…";
}
```

### è·¨å›¢é˜Ÿè§’è‰²æŸ¥è¯¢

#### getRolesInTeam()
è·å–ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿä¸­çš„è§’è‰²ã€‚

```php
// è·å–ç”¨æˆ·åœ¨å›¢é˜Ÿ5ä¸­çš„è§’è‰²
$team5Roles = $user->getRolesInTeam(5);
foreach ($team5Roles as $role) {
    echo "å›¢é˜Ÿ5è§’è‰²: {$role->name}\n";
}

// æ£€æŸ¥ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿæ˜¯å¦æœ‰ç‰¹å®šè§’è‰²
function hasRoleInTeam(User $user, int $teamId, string $roleName): bool
{
    $rolesInTeam = $user->getRolesInTeam($teamId);
    return $rolesInTeam->contains('name', $roleName);
}

// ä½¿ç”¨ç¤ºä¾‹
if (hasRoleInTeam($user, 5, 'viewer')) {
    echo "ç”¨æˆ·åœ¨å›¢é˜Ÿ5æ˜¯æŸ¥çœ‹è€…";
}
```

#### getAllRoles()
è·å–ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿä¸­çš„è§’è‰²ã€‚

```php
// è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
$allRoles = $user->getAllRoles();
foreach ($allRoles as $role) {
    echo "è§’è‰²: {$role->name} (å›¢é˜Ÿ: {$role->pivot_team_id})\n";
}

// æŒ‰å›¢é˜Ÿåˆ†ç»„è§’è‰²
$rolesByTeam = $allRoles->groupBy('pivot_team_id');
foreach ($rolesByTeam as $teamId => $roles) {
    echo "å›¢é˜Ÿ {$teamId}: " . $roles->pluck('name')->implode(', ') . "\n";
}

// ç»Ÿè®¡è§’è‰²ä¿¡æ¯
$roleStats = [
    'total_roles' => $allRoles->count(),
    'unique_roles' => $allRoles->pluck('name')->unique()->count(),
    'teams_count' => $allRoles->pluck('pivot_team_id')->unique()->count()
];

echo "è§’è‰²ç»Ÿè®¡: " . json_encode($roleStats, JSON_UNESCAPED_UNICODE);
```

### é«˜çº§è§’è‰²æŸ¥è¯¢

```php
// åˆ›å»ºè§’è‰²æŸ¥è¯¢æœåŠ¡
class RoleQueryService
{
    public function getUserRoleMatrix(User $user): array
    {
        $allRoles = $user->getAllRoles();
        $teams = Team::all();
        $roleTypes = ['owner', 'viewer', 'creator', 'approver', 'editor'];
        
        $matrix = [];
        foreach ($teams as $team) {
            $matrix[$team->id] = [
                'team_name' => $team->name,
                'roles' => []
            ];
            
            foreach ($roleTypes as $roleType) {
                $hasRole = $allRoles->where('pivot_team_id', $team->id)
                    ->where('name', $roleType)
                    ->isNotEmpty();
                    
                $matrix[$team->id]['roles'][$roleType] = $hasRole;
            }
        }
        
        return $matrix;
    }
    
    public function findUsersWithRole(string $roleName, int $teamId = null): Collection
    {
        $query = User::whereHas('roles', function($q) use ($roleName, $teamId) {
            $q->where('name', $roleName);
            if ($teamId) {
                $q->where('team_id', $teamId);
            }
        });
        
        return $query->get();
    }
    
    public function getRoleHierarchy(User $user, int $teamId): array
    {
        $rolesInTeam = $user->getRolesInTeam($teamId);
        
        // å®šä¹‰è§’è‰²å±‚æ¬¡ï¼ˆæƒé‡è¶Šé«˜æƒé™è¶Šå¤§ï¼‰
        $hierarchy = [
            'owner' => 5,
            'approver' => 4,
            'editor' => 3,
            'creator' => 2,
            'viewer' => 1
        ];
        
        $userRoles = $rolesInTeam->pluck('name')->toArray();
        $maxWeight = 0;
        $highestRole = null;
        
        foreach ($userRoles as $role) {
            if (isset($hierarchy[$role]) && $hierarchy[$role] > $maxWeight) {
                $maxWeight = $hierarchy[$role];
                $highestRole = $role;
            }
        }
        
        return [
            'roles' => $userRoles,
            'highest_role' => $highestRole,
            'weight' => $maxWeight
        ];
    }
}

// ä½¿ç”¨è§’è‰²æŸ¥è¯¢æœåŠ¡
$queryService = new RoleQueryService();

// è·å–ç”¨æˆ·è§’è‰²çŸ©é˜µ
$matrix = $queryService->getUserRoleMatrix($user);
foreach ($matrix as $teamId => $teamData) {
    echo "å›¢é˜Ÿ: {$teamData['team_name']}\n";
    foreach ($teamData['roles'] as $role => $hasRole) {
        echo "  {$role}: " . ($hasRole ? 'âœ“' : 'âœ—') . "\n";
    }
}

// æŸ¥æ‰¾æ‹¥æœ‰ç‰¹å®šè§’è‰²çš„ç”¨æˆ·
$creators = $queryService->findUsersWithRole('creator', 10);
echo "å›¢é˜Ÿ10çš„åˆ›å»ºè€…: " . $creators->pluck('name')->implode(', ');

// è·å–è§’è‰²å±‚æ¬¡
$hierarchy = $queryService->getRoleHierarchy($user, 10);
echo "ç”¨æˆ·åœ¨å›¢é˜Ÿ10çš„æœ€é«˜è§’è‰²: {$hierarchy['highest_role']} (æƒé‡: {$hierarchy['weight']})";
```

## ğŸ” é€šè¿‡è§’è‰²æŸ¥è¯¢æƒé™

### è·å–è§’è‰²æƒé™

#### è·å–è§’è‰²çš„æ‰€æœ‰æƒé™
```php
// è·å–æŒ‡å®šè§’è‰²çš„æ‰€æœ‰æƒé™
$role = \Spatie\Permission\Models\Role::findByName('editor');
$permissions = $role->permissions;

foreach ($permissions as $permission) {
    echo "æƒé™: {$permission->name} (å›¢é˜Ÿ: {$permission->team_id})\n";
}

// è·å–æƒé™åç§°æ•°ç»„
$permissionNames = $role->permissions->pluck('name')->toArray();
echo "ç¼–è¾‘è€…æƒé™: " . implode(', ', $permissionNames);
```

#### æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ç‰¹å®šæƒé™
```php
// æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ç‰¹å®šæƒé™
$role = \Spatie\Permission\Models\Role::findByName('editor');

if ($role->hasPermissionTo('edit_orders')) {
    echo "ç¼–è¾‘è€…è§’è‰²æœ‰ç¼–è¾‘è®¢å•æƒé™";
}

// æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰ä»»æ„æƒé™
$orderPermissions = ['view_orders', 'edit_orders', 'create_orders'];
if ($role->hasAnyPermission($orderPermissions)) {
    echo "ç¼–è¾‘è€…è§’è‰²æœ‰è®¢å•ç›¸å…³æƒé™";
}

// æ£€æŸ¥è§’è‰²æ˜¯å¦æœ‰æ‰€æœ‰æƒé™
if ($role->hasAllPermissions($orderPermissions)) {
    echo "ç¼–è¾‘è€…è§’è‰²æœ‰æ‰€æœ‰è®¢å•æƒé™";
}
```

### é€šè¿‡ç”¨æˆ·è§’è‰²æŸ¥è¯¢æƒé™

#### è·å–ç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—çš„æƒé™
```php
// è·å–ç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—çš„æ‰€æœ‰æƒé™
$user = User::find(1);

// æ–¹æ³•1ï¼šé€šè¿‡è§’è‰²å…³è”è·å–
$rolePermissions = collect();
foreach ($user->roles as $role) {
    $rolePermissions = $rolePermissions->merge($role->permissions);
}

// å»é‡å¹¶æ˜¾ç¤º
$uniquePermissions = $rolePermissions->unique('id');
echo "é€šè¿‡è§’è‰²è·å¾—çš„æƒé™æ•°é‡: " . $uniquePermissions->count() . "\n";

// æ–¹æ³•2ï¼šä½¿ç”¨æŸ¥è¯¢æ„å»ºå™¨
$rolePermissions = \Spatie\Permission\Models\Permission::whereHas('roles', function($query) use ($user) {
    $query->whereIn('id', $user->roles->pluck('id'));
})->get();

foreach ($rolePermissions as $permission) {
    echo "è§’è‰²æƒé™: {$permission->name}\n";
}
```

#### åŒºåˆ†ç›´æ¥æƒé™å’Œè§’è‰²æƒé™
```php
// åŒºåˆ†ç”¨æˆ·çš„ç›´æ¥æƒé™å’Œè§’è‰²æƒé™
function analyzeUserPermissions(User $user): array
{
    // è·å–ç›´æ¥æƒé™
    $directPermissions = $user->getDirectPermissions();
    
    // è·å–é€šè¿‡è§’è‰²è·å¾—çš„æƒé™
    $rolePermissions = collect();
    foreach ($user->roles as $role) {
        $rolePermissions = $rolePermissions->merge($role->permissions);
    }
    $rolePermissions = $rolePermissions->unique('id');
    
    // è·å–æ‰€æœ‰æƒé™
    $allPermissions = $user->getAllPermissions();
    
    return [
        'direct_permissions' => $directPermissions->pluck('name')->toArray(),
        'role_permissions' => $rolePermissions->pluck('name')->toArray(),
        'all_permissions' => $allPermissions->pluck('name')->toArray(),
        'direct_count' => $directPermissions->count(),
        'role_count' => $rolePermissions->count(),
        'total_count' => $allPermissions->count()
    ];
}

// ä½¿ç”¨åˆ†æå‡½æ•°
$analysis = analyzeUserPermissions($user);
echo "ç›´æ¥æƒé™ ({$analysis['direct_count']}): " . implode(', ', $analysis['direct_permissions']) . "\n";
echo "è§’è‰²æƒé™ ({$analysis['role_count']}): " . implode(', ', $analysis['role_permissions']) . "\n";
echo "æ€»æƒé™ ({$analysis['total_count']}): " . implode(', ', $analysis['all_permissions']) . "\n";
```

### è·¨å›¢é˜Ÿè§’è‰²æƒé™æŸ¥è¯¢

#### æŸ¥è¯¢ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿçš„è§’è‰²æƒé™
```php
// è·å–ç”¨æˆ·åœ¨æ‰€æœ‰å›¢é˜Ÿçš„è§’è‰²æƒé™
function getUserRolePermissionsAcrossTeams(User $user): array
{
    $allRoles = $user->getAllRoles();
    $teamPermissions = [];
    
    foreach ($allRoles as $role) {
        $teamId = $role->pivot_team_id;
        
        if (!isset($teamPermissions[$teamId])) {
            $teamPermissions[$teamId] = [
                'team_id' => $teamId,
                'roles' => [],
                'permissions' => collect()
            ];
        }
        
        $teamPermissions[$teamId]['roles'][] = $role->name;
        $teamPermissions[$teamId]['permissions'] = $teamPermissions[$teamId]['permissions']
            ->merge($role->permissions);
    }
    
    // å»é‡æƒé™
    foreach ($teamPermissions as $teamId => &$data) {
        $data['permissions'] = $data['permissions']->unique('id')->pluck('name')->toArray();
        $data['permission_count'] = count($data['permissions']);
    }
    
    return $teamPermissions;
}

// ä½¿ç”¨ç¤ºä¾‹
$teamPermissions = getUserRolePermissionsAcrossTeams($user);
foreach ($teamPermissions as $teamId => $data) {
    echo "å›¢é˜Ÿ {$teamId}:\n";
    echo "  è§’è‰²: " . implode(', ', $data['roles']) . "\n";
    echo "  æƒé™æ•°é‡: {$data['permission_count']}\n";
    echo "  æƒé™åˆ—è¡¨: " . implode(', ', $data['permissions']) . "\n\n";
}
```

#### æŸ¥è¯¢ç‰¹å®šå›¢é˜Ÿçš„è§’è‰²æƒé™
```php
// æŸ¥è¯¢ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿé€šè¿‡è§’è‰²è·å¾—çš„æƒé™
function getUserRolePermissionsInTeam(User $user, int $teamId): array
{
    $rolesInTeam = $user->getRolesInTeam($teamId);
    $permissions = collect();
    
    foreach ($rolesInTeam as $role) {
        $permissions = $permissions->merge($role->permissions);
    }
    
    $uniquePermissions = $permissions->unique('id');
    
    return [
        'team_id' => $teamId,
        'roles' => $rolesInTeam->pluck('name')->toArray(),
        'permissions' => $uniquePermissions->pluck('name')->toArray(),
        'permission_objects' => $uniquePermissions->toArray()
    ];
}

// ä½¿ç”¨ç¤ºä¾‹
$teamRolePermissions = getUserRolePermissionsInTeam($user, 7);
echo "å›¢é˜Ÿ7è§’è‰²æƒé™åˆ†æ:\n";
echo "è§’è‰²: " . implode(', ', $teamRolePermissions['roles']) . "\n";
echo "æƒé™: " . implode(', ', $teamRolePermissions['permissions']) . "\n";
```

### è§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡

#### åˆ›å»ºè§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡
```php
class RolePermissionQueryService
{
    /**
     * è·å–è§’è‰²çš„æƒé™çŸ©é˜µ
     */
    public function getRolePermissionMatrix(int $teamId): array
    {
        $roles = \Spatie\Permission\Models\Role::where('team_id', $teamId)->get();
        $permissions = \Spatie\Permission\Models\Permission::where('team_id', $teamId)->get();
        
        $matrix = [];
        foreach ($roles as $role) {
            $matrix[$role->name] = [];
            foreach ($permissions as $permission) {
                $matrix[$role->name][$permission->name] = $role->hasPermissionTo($permission);
            }
        }
        
        return $matrix;
    }
    
    /**
     * æŸ¥æ‰¾æ‹¥æœ‰ç‰¹å®šæƒé™çš„è§’è‰²
     */
    public function findRolesWithPermission(string $permissionName, int $teamId = null): Collection
    {
        $query = \Spatie\Permission\Models\Role::whereHas('permissions', function($q) use ($permissionName) {
            $q->where('name', $permissionName);
        });
        
        if ($teamId) {
            $query->where('team_id', $teamId);
        }
        
        return $query->get();
    }
    
    /**
     * è·å–è§’è‰²æƒé™å·®å¼‚
     */
    public function compareRolePermissions(string $role1, string $role2, int $teamId): array
    {
        $roleObj1 = \Spatie\Permission\Models\Role::where('name', $role1)
            ->where('team_id', $teamId)->first();
        $roleObj2 = \Spatie\Permission\Models\Role::where('name', $role2)
            ->where('team_id', $teamId)->first();
        
        if (!$roleObj1 || !$roleObj2) {
            throw new \Exception('è§’è‰²ä¸å­˜åœ¨');
        }
        
        $permissions1 = $roleObj1->permissions->pluck('name')->toArray();
        $permissions2 = $roleObj2->permissions->pluck('name')->toArray();
        
        return [
            'role1' => $role1,
            'role2' => $role2,
            'role1_only' => array_diff($permissions1, $permissions2),
            'role2_only' => array_diff($permissions2, $permissions1),
            'common' => array_intersect($permissions1, $permissions2),
            'role1_permissions' => $permissions1,
            'role2_permissions' => $permissions2
        ];
    }
    
    /**
     * è·å–ç”¨æˆ·æƒé™æ¥æºåˆ†æ
     */
    public function analyzeUserPermissionSources(User $user, int $teamId): array
    {
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $directPermissions = $user->getDirectPermissions();
        $rolesInTeam = $user->getRolesInTeam($teamId);
        
        $analysis = [
            'team_id' => $teamId,
            'direct_permissions' => $directPermissions->pluck('name')->toArray(),
            'roles' => [],
            'permission_sources' => []
        ];
        
        // åˆ†ææ¯ä¸ªè§’è‰²çš„æƒé™
        foreach ($rolesInTeam as $role) {
            $rolePermissions = $role->permissions->pluck('name')->toArray();
            $analysis['roles'][$role->name] = $rolePermissions;
        }
        
        // åˆ†ææ¯ä¸ªæƒé™çš„æ¥æº
        $allPermissions = $user->getAllPermissions();
        foreach ($allPermissions as $permission) {
            $sources = [];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥æƒé™
            if ($directPermissions->contains('id', $permission->id)) {
                $sources[] = 'direct';
            }
            
            // æ£€æŸ¥æ¥è‡ªå“ªäº›è§’è‰²
            foreach ($rolesInTeam as $role) {
                if ($role->hasPermissionTo($permission)) {
                    $sources[] = "role:{$role->name}";
                }
            }
            
            $analysis['permission_sources'][$permission->name] = $sources;
        }
        
        return $analysis;
    }
    
    /**
     * è·å–è§’è‰²æƒé™ç»Ÿè®¡
     */
    public function getRolePermissionStats(int $teamId): array
    {
        $roles = \Spatie\Permission\Models\Role::where('team_id', $teamId)->with('permissions')->get();
        $stats = [];
        
        foreach ($roles as $role) {
            $permissions = $role->permissions;
            $permissionsByModule = $permissions->groupBy(function($permission) {
                // å‡è®¾æƒé™æ ¼å¼ä¸º action_module
                $parts = explode('_', $permission->name);
                return count($parts) > 1 ? $parts[1] : 'other';
            });
            
            $stats[$role->name] = [
                'total_permissions' => $permissions->count(),
                'permissions_by_module' => $permissionsByModule->map->count()->toArray(),
                'permission_list' => $permissions->pluck('name')->toArray()
            ];
        }
        
        return $stats;
    }
}

// ä½¿ç”¨è§’è‰²æƒé™æŸ¥è¯¢æœåŠ¡
$queryService = new RolePermissionQueryService();

// è·å–è§’è‰²æƒé™çŸ©é˜µ
$matrix = $queryService->getRolePermissionMatrix(7);
echo "å›¢é˜Ÿ7è§’è‰²æƒé™çŸ©é˜µ:\n";
foreach ($matrix as $roleName => $permissions) {
    echo "è§’è‰² {$roleName}:\n";
    foreach ($permissions as $permissionName => $hasPermission) {
        echo "  {$permissionName}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
    }
}

// æŸ¥æ‰¾æ‹¥æœ‰ç‰¹å®šæƒé™çš„è§’è‰²
$rolesWithEditPermission = $queryService->findRolesWithPermission('edit_orders', 7);
echo "æ‹¥æœ‰ç¼–è¾‘è®¢å•æƒé™çš„è§’è‰²: " . $rolesWithEditPermission->pluck('name')->implode(', ') . "\n";

// æ¯”è¾ƒè§’è‰²æƒé™
$comparison = $queryService->compareRolePermissions('editor', 'creator', 7);
echo "ç¼–è¾‘è€…ç‹¬æœ‰æƒé™: " . implode(', ', $comparison['role1_only']) . "\n";
echo "åˆ›å»ºè€…ç‹¬æœ‰æƒé™: " . implode(', ', $comparison['role2_only']) . "\n";
echo "å…±åŒæƒé™: " . implode(', ', $comparison['common']) . "\n";

// åˆ†æç”¨æˆ·æƒé™æ¥æº
$analysis = $queryService->analyzeUserPermissionSources($user, 7);
echo "ç”¨æˆ·æƒé™æ¥æºåˆ†æ:\n";
echo "ç›´æ¥æƒé™: " . implode(', ', $analysis['direct_permissions']) . "\n";
foreach ($analysis['permission_sources'] as $permission => $sources) {
    echo "æƒé™ {$permission} æ¥æº: " . implode(', ', $sources) . "\n";
}

// è·å–è§’è‰²æƒé™ç»Ÿè®¡
$stats = $queryService->getRolePermissionStats(7);
foreach ($stats as $roleName => $data) {
    echo "è§’è‰² {$roleName}: {$data['total_permissions']} ä¸ªæƒé™\n";
    foreach ($data['permissions_by_module'] as $module => $count) {
        echo "  {$module} æ¨¡å—: {$count} ä¸ªæƒé™\n";
    }
}
```

### æƒé™ç»§æ‰¿æŸ¥è¯¢

#### æŸ¥è¯¢æƒé™ç»§æ‰¿å…³ç³»
```php
// æŸ¥è¯¢ç”¨æˆ·æƒé™çš„ç»§æ‰¿å…³ç³»
function tracePermissionInheritance(User $user, string $permissionName, int $teamId): array
{
    $inheritance = [
        'permission' => $permissionName,
        'team_id' => $teamId,
        'has_permission' => false,
        'sources' => []
    ];
    
    // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥æƒé™
    $inheritance['has_permission'] = $user->hasPermissionTo($permissionName);
    
    if (!$inheritance['has_permission']) {
        return $inheritance;
    }
    
    // æ£€æŸ¥ç›´æ¥æƒé™
    if ($user->hasDirectPermission($permissionName)) {
        $inheritance['sources'][] = [
            'type' => 'direct',
            'source' => 'user',
            'granted_at' => null // å¯ä»¥ä»æ•°æ®åº“è·å–
        ];
    }
    
    // æ£€æŸ¥è§’è‰²æƒé™
    $rolesInTeam = $user->getRolesInTeam($teamId);
    foreach ($rolesInTeam as $role) {
        if ($role->hasPermissionTo($permissionName)) {
            $inheritance['sources'][] = [
                'type' => 'role',
                'source' => $role->name,
                'role_id' => $role->id,
                'granted_at' => null // å¯ä»¥ä»æ•°æ®åº“è·å–
            ];
        }
    }
    
    return $inheritance;
}

// ä½¿ç”¨æƒé™ç»§æ‰¿æŸ¥è¯¢
$inheritance = tracePermissionInheritance($user, 'edit_orders', 7);
echo "æƒé™ {$inheritance['permission']} ç»§æ‰¿å…³ç³»:\n";
echo "æ‹¥æœ‰æƒé™: " . ($inheritance['has_permission'] ? 'æ˜¯' : 'å¦') . "\n";

if ($inheritance['has_permission']) {
    echo "æƒé™æ¥æº:\n";
    foreach ($inheritance['sources'] as $source) {
        if ($source['type'] === 'direct') {
            echo "  - ç›´æ¥æƒé™\n";
        } else {
            echo "  - è§’è‰²æƒé™: {$source['source']}\n";
        }
    }
}
```

### æƒé™æŸ¥è¯¢ä¼˜åŒ–

#### æ‰¹é‡æƒé™æŸ¥è¯¢
```php
// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·æƒé™çŠ¶æ€
function batchCheckUserPermissions(User $user, array $permissions, int $teamId): array
{
    // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    // é¢„åŠ è½½ç”¨æˆ·æƒé™å’Œè§’è‰²
    $user->load(['permissions', 'roles.permissions']);
    
    $results = [];
    foreach ($permissions as $permission) {
        $results[$permission] = $user->hasPermissionTo($permission);
    }
    
    return $results;
}

// æ‰¹é‡æŸ¥è¯¢è§’è‰²æƒé™çŠ¶æ€
function batchCheckRolePermissions(string $roleName, array $permissions, int $teamId): array
{
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->with('permissions')
        ->first();
    
    if (!$role) {
        throw new \Exception("è§’è‰² {$roleName} åœ¨å›¢é˜Ÿ {$teamId} ä¸­ä¸å­˜åœ¨");
    }
    
    $results = [];
    foreach ($permissions as $permission) {
        $results[$permission] = $role->hasPermissionTo($permission);
    }
    
    return $results;
}

// ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
$permissionsToCheck = ['view_orders', 'edit_orders', 'create_orders', 'delete_orders', 'approve_orders'];

// æ‰¹é‡æ£€æŸ¥ç”¨æˆ·æƒé™
$userPermissions = batchCheckUserPermissions($user, $permissionsToCheck, 7);
echo "ç”¨æˆ·æƒé™çŠ¶æ€:\n";
foreach ($userPermissions as $permission => $hasPermission) {
    echo "  {$permission}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
}

// æ‰¹é‡æ£€æŸ¥è§’è‰²æƒé™
$rolePermissions = batchCheckRolePermissions('editor', $permissionsToCheck, 7);
echo "\nç¼–è¾‘è€…è§’è‰²æƒé™çŠ¶æ€:\n";
foreach ($rolePermissions as $permission => $hasPermission) {
    echo "  {$permission}: " . ($hasPermission ? 'âœ“' : 'âœ—') . "\n";
}
```

## ğŸ¯ è§’è‰²ç®¡ç†æœ€ä½³å®è·µ

### è§’è‰²åˆ†é…ç­–ç•¥

```php
// åˆ›å»ºè§’è‰²ç®¡ç†ç­–ç•¥
class RoleManagementStrategy
{
    public function assignNewUserRole(User $user, Team $team, string $defaultRole = 'viewer'): bool
    {
        try {
            // æ›´æ–°ç”¨æˆ·å½“å‰å›¢é˜Ÿ
            $user->update(['current_team_id' => $team->id]);
            
            // åˆ†é…é»˜è®¤è§’è‰²
            $user->assignRoleSafely($defaultRole);
            
            // è®°å½•æ—¥å¿—
            Log::info('æ–°ç”¨æˆ·è§’è‰²åˆ†é…', [
                'user_id' => $user->id,
                'team_id' => $team->id,
                'role' => $defaultRole
            ]);
            
            return true;
            
        } catch (Exception $e) {
            Log::error('æ–°ç”¨æˆ·è§’è‰²åˆ†é…å¤±è´¥', [
                'user_id' => $user->id,
                'team_id' => $team->id,
                'error' => $e->getMessage()
            ]);
            
            return false;
        }
    }
    
    public function promoteUser(User $user, int $teamId, string $newRole): bool
    {
        try {
            $currentRoles = $user->getRolesInTeam($teamId);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ›´é«˜æƒé™
            $hierarchy = ['viewer' => 1, 'creator' => 2, 'editor' => 3, 'approver' => 4, 'owner' => 5];
            $currentMaxWeight = 0;
            
            foreach ($currentRoles as $role) {
                if (isset($hierarchy[$role->name])) {
                    $currentMaxWeight = max($currentMaxWeight, $hierarchy[$role->name]);
                }
            }
            
            $newWeight = $hierarchy[$newRole] ?? 0;
            
            if ($newWeight <= $currentMaxWeight) {
                throw new Exception("ç”¨æˆ·å·²æœ‰ç›¸åŒæˆ–æ›´é«˜æƒé™çš„è§’è‰²");
            }
            
            // æ‰§è¡Œæ™‹å‡
            $user->assignRoleInTeam($teamId, $newRole);
            
            Log::info('ç”¨æˆ·æ™‹å‡æˆåŠŸ', [
                'user_id' => $user->id,
                'team_id' => $teamId,
                'new_role' => $newRole,
                'previous_max_weight' => $currentMaxWeight
            ]);
            
            return true;
            
        } catch (Exception $e) {
            Log::error('ç”¨æˆ·æ™‹å‡å¤±è´¥', [
                'user_id' => $user->id,
                'team_id' => $teamId,
                'new_role' => $newRole,
                'error' => $e->getMessage()
            ]);
            
            return false;
        }
    }
}
```

### è§’è‰²å˜æ›´é€šçŸ¥

```php
// åˆ›å»ºè§’è‰²å˜æ›´é€šçŸ¥ç³»ç»Ÿ
class RoleChangeNotificationService
{
    public function notifyRoleChange(User $user, int $teamId, array $changes): void
    {
        $team = Team::find($teamId);
        
        // å‘é€é‚®ä»¶é€šçŸ¥
        if (!empty($changes['added'])) {
            Mail::to($user->email)->send(new RoleAssignedMail($user, $team, $changes['added']));
        }
        
        if (!empty($changes['removed'])) {
            Mail::to($user->email)->send(new RoleRemovedMail($user, $team, $changes['removed']));
        }
        
        // å‘é€ç³»ç»Ÿé€šçŸ¥
        $user->notify(new RoleChangeNotification($team, $changes));
        
        // è®°å½•å®¡è®¡æ—¥å¿—
        AuditLog::create([
            'user_id' => $user->id,
            'team_id' => $teamId,
            'action' => 'role_change',
            'details' => $changes,
            'performed_by' => auth()->id()
        ]);
    }
}

// åœ¨è§’è‰²å˜æ›´æ—¶ä½¿ç”¨é€šçŸ¥æœåŠ¡
class User extends Authenticatable
{
    public function assignRoleSafely($roles): self
    {
        $beforeRoles = $this->getRoleNames()->toArray();
        
        parent::assignRoleSafely($roles);
        
        $afterRoles = $this->getRoleNames()->toArray();
        $changes = [
            'added' => array_diff($afterRoles, $beforeRoles),
            'removed' => array_diff($beforeRoles, $afterRoles)
        ];
        
        if (!empty($changes['added']) || !empty($changes['removed'])) {
            app(RoleChangeNotificationService::class)
                ->notifyRoleChange($this, $this->current_team_id, $changes);
        }
        
        return $this;
    }
}
```

### è§’è‰²æƒé™éªŒè¯

```php
// åˆ›å»ºè§’è‰²æƒé™éªŒè¯å™¨
class RolePermissionValidator
{
    public function validateRoleAssignment(User $assigner, User $target, int $teamId, string $role): bool
    {
        // æ£€æŸ¥åˆ†é…è€…æ˜¯å¦æœ‰æƒé™ç®¡ç†è¯¥å›¢é˜Ÿ
        if (!$assigner->hasPermissionInTeam($teamId, 'manage_team_members')) {
            throw new UnauthorizedException('æ‚¨æ²¡æœ‰ç®¡ç†è¯¥å›¢é˜Ÿæˆå‘˜çš„æƒé™');
        }
        
        // æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜åœ¨
        $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
            ->where('team_id', $teamId)
            ->exists();
            
        if (!$roleExists) {
            throw new InvalidArgumentException("è§’è‰² '{$role}' åœ¨è¯¥å›¢é˜Ÿä¸­ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥æ˜¯å¦å°è¯•åˆ†é…æ¯”è‡ªå·±æ›´é«˜çš„æƒé™
        $assignerHierarchy = $this->getUserRoleHierarchy($assigner, $teamId);
        $targetRoleWeight = $this->getRoleWeight($role);
        
        if ($targetRoleWeight >= $assignerHierarchy['weight'] && !$assigner->hasRole('super_admin')) {
            throw new UnauthorizedException('æ‚¨ä¸èƒ½åˆ†é…æ¯”è‡ªå·±æƒé™æ›´é«˜æˆ–ç›¸ç­‰çš„è§’è‰²');
        }
        
        return true;
    }
    
    private function getRoleWeight(string $role): int
    {
        $weights = [
            'viewer' => 1,
            'creator' => 2,
            'editor' => 3,
            'approver' => 4,
            'owner' => 5
        ];
        
        return $weights[$role] ?? 0;
    }
    
    private function getUserRoleHierarchy(User $user, int $teamId): array
    {
        $roles = $user->getRolesInTeam($teamId);
        $maxWeight = 0;
        
        foreach ($roles as $role) {
            $weight = $this->getRoleWeight($role->name);
            $maxWeight = max($maxWeight, $weight);
        }
        
        return ['weight' => $maxWeight];
    }
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨éªŒè¯å™¨
class TeamMemberController extends Controller
{
    protected RolePermissionValidator $validator;
    
    public function __construct(RolePermissionValidator $validator)
    {
        $this->validator = $validator;
    }
    
    public function assignRole(Request $request)
    {
        $validated = $request->validate([
            'user_id' => 'required|exists:users,id',
            'team_id' => 'required|exists:teams,id',
            'role' => 'required|string'
        ]);
        
        $assigner = auth()->user();
        $target = User::find($validated['user_id']);
        
        try {
            // éªŒè¯è§’è‰²åˆ†é…æƒé™
            $this->validator->validateRoleAssignment(
                $assigner,
                $target,
                $validated['team_id'],
                $validated['role']
            );
            
            // æ‰§è¡Œè§’è‰²åˆ†é…
            $target->assignRoleInTeam($validated['team_id'], $validated['role']);
            
            return response()->json([
                'success' => true,
                'message' => 'è§’è‰²åˆ†é…æˆåŠŸ'
            ]);
            
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 403);
        }
    }
}
```

é€šè¿‡è¿™äº›è§’è‰²ç®¡ç†æ–¹æ³•å’Œæœ€ä½³å®è·µï¼Œæ‚¨å¯ä»¥å®ç°ä¸€ä¸ªå®Œæ•´ã€å®‰å…¨ã€æ˜“ç»´æŠ¤çš„è§’è‰²ç®¡ç†ç³»ç»Ÿã€‚è®°ä½å§‹ç»ˆä½¿ç”¨å®‰å…¨æ–¹æ³•ï¼Œè¿›è¡Œé€‚å½“çš„éªŒè¯ï¼Œå¹¶å®æ–½å¿…è¦çš„é€šçŸ¥å’Œå®¡è®¡æœºåˆ¶ã€‚ 