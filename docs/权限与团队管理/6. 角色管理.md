# 角色管理

本文档详细介绍了角色管理的各种操作，包括角色分配、移除、查询和跨团队管理。

## 📚 目录

- [🎭 角色分配](#-角色分配)
  - [基本角色分配](#基本角色分配)
    - [assignRoleSafely()](#assignrolesafely)
    - [角色分配验证](#角色分配验证)
  - [跨团队角色分配](#跨团队角色分配)
    - [assignRoleInTeam()](#assignroleinteam)
    - [管理员跨团队分配示例](#管理员跨团队分配示例)

- [🗑️ 角色移除](#️-角色移除)
  - [删除用户角色](#删除用户角色)
    - [removeRoleSafely()](#removerolesafely)
    - [removeRoleInTeam()](#removeroleinteam)
    - [原生删除角色方法](#原生删除角色方法)
  - [跨团队角色移除](#跨团队角色移除)
  - [从角色中删除权限](#从角色中删除权限)
    - [revokePermissionTo()](#revokepermissionto)
    - [批量删除角色权限](#批量删除角色权限)
    - [安全删除角色权限](#安全删除角色权限)
  - [角色权限同步删除](#角色权限同步删除)
    - [syncPermissions()](#syncpermissions)
  - [角色权限删除服务](#角色权限删除服务)
    - [创建角色权限删除服务](#创建角色权限删除服务)
  - [多团队角色权限删除](#多团队角色权限删除)
    - [跨团队批量删除角色权限](#跨团队批量删除角色权限)
    - [多团队角色权限管理服务](#多团队角色权限管理服务)
    - [多团队权限删除的最佳实践](#多团队权限删除的最佳实践)
  - [角色权限删除的最佳实践](#角色权限删除的最佳实践)
    - [删除前验证](#删除前验证)
    - [删除权限日志记录](#删除权限日志记录)
    - [影响用户通知](#影响用户通知)
    - [权限删除回滚](#权限删除回滚)

- [🔄 角色同步](#-角色同步)
  - [syncRolesSafely()](#syncrolessafely)
  - [跨团队角色同步](#跨团队角色同步)

- [🔍 角色查询](#-角色查询)
  - [基本角色查询](#基本角色查询)
  - [跨团队角色查询](#跨团队角色查询)
    - [getRolesInTeam()](#getrolesinteam)
    - [getAllRoles()](#getallroles)
  - [高级角色查询](#高级角色查询)

- [🔐 通过角色查询权限](#-通过角色查询权限)
  - [获取角色权限](#获取角色权限)
    - [获取角色的所有权限](#获取角色的所有权限)
    - [检查角色是否有特定权限](#检查角色是否有特定权限)
  - [通过用户角色查询权限](#通过用户角色查询权限)
    - [获取用户通过角色获得的权限](#获取用户通过角色获得的权限)
    - [区分直接权限和角色权限](#区分直接权限和角色权限)
  - [跨团队角色权限查询](#跨团队角色权限查询)
    - [查询用户在所有团队的角色权限](#查询用户在所有团队的角色权限)
    - [查询特定团队的角色权限](#查询特定团队的角色权限)
  - [角色权限查询服务](#角色权限查询服务)
    - [创建角色权限查询服务](#创建角色权限查询服务)
  - [权限继承查询](#权限继承查询)
    - [查询权限继承关系](#查询权限继承关系)
  - [权限查询优化](#权限查询优化)
    - [批量权限查询](#批量权限查询)

- [🎯 角色管理最佳实践](#-角色管理最佳实践)
  - [角色分配策略](#角色分配策略)
  - [角色变更通知](#角色变更通知)
  - [角色权限验证](#角色权限验证)

---

## 🎭 角色分配

### 基本角色分配

#### assignRoleSafely()
推荐的角色分配方法，自动使用用户的当前团队。

```php
$user = User::find(1);

// 分配单个角色到当前团队
$user->assignRoleSafely('creator');

// 分配多个角色
$user->assignRoleSafely(['creator', 'editor']);

// 链式调用
$user->assignRoleSafely('creator')
     ->assignRoleSafely('approver');

// 验证角色分配
if ($user->hasRole('creator')) {
    echo "用户已成功分配creator角色";
}
```

#### 角色分配验证

```php
// 带验证的角色分配
function assignRoleWithValidation(User $user, string $role): bool
{
    try {
        // 检查角色是否存在于用户当前团队
        $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
            ->where('team_id', $user->current_team_id)
            ->exists();
        
        if (!$roleExists) {
            throw new InvalidArgumentException("角色 '{$role}' 在团队 {$user->current_team_id} 中不存在");
        }
        
        // 检查用户是否已有该角色
        if ($user->hasRole($role)) {
            echo "用户已经拥有 '{$role}' 角色";
            return true;
        }
        
        // 分配角色
        $user->assignRoleSafely($role);
        
        Log::info('角色分配成功', [
            'user_id' => $user->id,
            'role' => $role,
            'team_id' => $user->current_team_id
        ]);
        
        return true;
        
    } catch (Exception $e) {
        Log::error('角色分配失败', [
            'user_id' => $user->id,
            'role' => $role,
            'error' => $e->getMessage()
        ]);
        
        return false;
    }
}

// 使用验证函数
$success = assignRoleWithValidation($user, 'creator');
if ($success) {
    echo "角色分配成功";
} else {
    echo "角色分配失败";
}
```

### 跨团队角色分配

#### assignRoleInTeam()
在指定团队中分配角色给用户。

```php
// 在团队5中分配viewer角色
$user->assignRoleInTeam(5, 'viewer');

// 在团队7中分配多个角色
$user->assignRoleInTeam(7, ['editor', 'approver']);

// 批量跨团队分配
$teamRoleAssignments = [
    5 => ['viewer'],
    7 => ['editor', 'approver'],
    10 => ['creator']
];

foreach ($teamRoleAssignments as $teamId => $roles) {
    $user->assignRoleInTeam($teamId, $roles);
    echo "已在团队 {$teamId} 分配角色: " . implode(', ', $roles) . "\n";
}
```

#### 管理员跨团队分配示例

```php
// 管理员分配用户到多个团队
class TeamManagementService
{
    public function assignUserToMultipleTeams(User $user, array $teamAssignments): array
    {
        $results = [];
        
        foreach ($teamAssignments as $teamId => $role) {
            try {
                // 验证团队存在
                $team = Team::findOrFail($teamId);
                
                // 验证角色存在于该团队
                $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
                    ->where('team_id', $teamId)
                    ->exists();
                
                if (!$roleExists) {
                    throw new Exception("角色 '{$role}' 在团队 {$teamId} 中不存在");
                }
                
                // 分配角色
                $user->assignRoleInTeam($teamId, $role);
                
                $results[$teamId] = [
                    'success' => true,
                    'message' => "成功分配角色 '{$role}' 到团队 '{$team->name}'"
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
}

// 使用服务
$service = new TeamManagementService();
$assignments = [
    5 => 'viewer',
    7 => 'editor',
    10 => 'creator'
];

$results = $service->assignUserToMultipleTeams($user, $assignments);
foreach ($results as $teamId => $result) {
    echo "团队 {$teamId}: " . $result['message'] . "\n";
}
```

## 🗑️ 角色移除

### 删除用户角色

#### removeRoleSafely()
安全地删除用户角色（自动使用当前团队上下文）。

```php
// 删除单个角色
$user->removeRoleSafely('creator');

// 删除多个角色
$user->removeRoleSafely(['creator', 'editor']);

// 链式调用
$user->removeRoleSafely('creator')
     ->removeRoleSafely('editor');
```

#### removeRoleInTeam()
在指定团队中删除用户角色。

```php
// 在团队7中删除viewer角色
$user->removeRoleInTeam(7, 'viewer');

// 在团队7中删除多个角色
$user->removeRoleInTeam(7, ['editor', 'approver']);
```

#### 原生删除角色方法
```php
// 需要先设置团队上下文
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);

// 删除单个角色
$user->removeRole('viewer');

// 删除多个角色
foreach (['creator', 'editor'] as $role) {
    $user->removeRole($role);
}
```


### 跨团队角色移除

```php
// 移除指定团队的角色
$user->withTeamContext(5, function($user) {
    $user->removeRole('viewer');
});

// 批量移除跨团队角色
function removeRolesFromTeams(User $user, array $teamRoles): void
{
    foreach ($teamRoles as $teamId => $roles) {
        $user->withTeamContext($teamId, function($user) use ($roles) {
            $user->removeRole($roles);
        });
        
        echo "已从团队 {$teamId} 移除角色: " . implode(', ', (array)$roles) . "\n";
    }
}

// 使用示例
$teamRolesToRemove = [
    5 => 'viewer',
    7 => ['editor', 'approver']
];

removeRolesFromTeams($user, $teamRolesToRemove);
```

### 从角色中删除权限

#### revokePermissionTo()
从角色中删除权限，影响所有拥有该角色的用户。

```php
// 从角色中删除单个权限
$role = \Spatie\Permission\Models\Role::findByName('editor');
$role->revokePermissionTo('delete_orders');

// 从角色中删除多个权限
$role->revokePermissionTo(['delete_orders', 'approve_orders']);

// 删除权限对象
$permission = \Spatie\Permission\Models\Permission::findByName('delete_orders');
$role->revokePermissionTo($permission);

// 在指定团队上下文中删除角色权限
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$role = \Spatie\Permission\Models\Role::find(22);
$role->revokePermissionTo('view_orders');
```

#### 批量删除角色权限
```php
// 批量删除角色的多个权限
function batchRevokeRolePermissions(string $roleName, array $permissions, int $teamId): array
{
    // 设置团队上下文
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->first();
    
    if (!$role) {
        throw new \Exception("角色 {$roleName} 在团队 {$teamId} 中不存在");
    }
    
    $revokedPermissions = [];
    foreach ($permissions as $permission) {
        if ($role->hasPermissionTo($permission)) {
            $role->revokePermissionTo($permission);
            $revokedPermissions[] = $permission;
        }
    }
    
    // 清除权限缓存
    app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
    
    return $revokedPermissions;
}

// 使用示例
$revokedPermissions = batchRevokeRolePermissions('editor', ['delete_orders', 'approve_orders'], 7);
echo "已从编辑者角色删除权限: " . implode(', ', $revokedPermissions) . "\n";
```

#### 安全删除角色权限
```php
// 安全删除角色权限（带验证）
function safeRevokeRolePermission(string $roleName, string $permission, int $teamId): bool
{
    try {
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            echo "角色 {$roleName} 在团队 {$teamId} 中不存在\n";
            return false;
        }
        
        // 检查角色是否有该权限
        if (!$role->hasPermissionTo($permission)) {
            echo "角色 {$roleName} 没有权限 {$permission}\n";
            return false;
        }
        
        // 检查是否是关键权限（如团队所有者的管理权限）
        $criticalPermissions = ['manage_team', 'delete_team', 'manage_team_members'];
        if (in_array($permission, $criticalPermissions) && $roleName === 'owner') {
            echo "无法删除团队所有者的关键权限 {$permission}\n";
            return false;
        }
        
        // 执行删除
        $role->revokePermissionTo($permission);
        
        // 清除缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        echo "成功从角色 {$roleName} 删除权限 {$permission}\n";
        return true;
        
    } catch (\Exception $e) {
        echo "删除权限失败: " . $e->getMessage() . "\n";
        return false;
    }
}

// 使用安全删除方法
$success = safeRevokeRolePermission('editor', 'delete_orders', 7);
```

### 角色权限同步删除

#### syncPermissions()
同步角色权限（替换角色的所有权限）。

```php
// 设置角色的所有权限（替换现有权限）
$role = \Spatie\Permission\Models\Role::findByName('editor');
$role->syncPermissions(['view_orders', 'edit_orders', 'create_orders']);

// 清空角色的所有权限
$role->syncPermissions([]);

// 在指定团队上下文中同步角色权限
app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId(7);
$role = \Spatie\Permission\Models\Role::find(22);
$role->syncPermissions(['view_orders']); // 只保留查看权限
```

### 角色权限删除服务

#### 创建角色权限删除服务
```php
class RolePermissionRevocationService
{
    /**
     * 从角色中删除特定权限
     */
    public function revokePermissionsFromRole(string $roleName, array $permissions, int $teamId): array
    {
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            throw new \Exception("角色 {$roleName} 在团队 {$teamId} 中不存在");
        }
        
        $revokedPermissions = [];
        $skippedPermissions = [];
        
        foreach ($permissions as $permission) {
            if ($role->hasPermissionTo($permission)) {
                $role->revokePermissionTo($permission);
                $revokedPermissions[] = $permission;
            } else {
                $skippedPermissions[] = $permission;
            }
        }
        
        // 清除缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'revoked' => $revokedPermissions,
            'skipped' => $skippedPermissions,
            'role' => $roleName,
            'team_id' => $teamId
        ];
    }
    
    /**
     * 批量从多个角色删除权限
     */
    public function bulkRevokePermissionsFromRoles(array $rolePermissions, int $teamId): array
    {
        $results = [];
        
        foreach ($rolePermissions as $roleName => $permissions) {
            try {
                $result = $this->revokePermissionsFromRole($roleName, $permissions, $teamId);
                $results[$roleName] = $result;
            } catch (\Exception $e) {
                $results[$roleName] = [
                    'error' => $e->getMessage(),
                    'role' => $roleName,
                    'team_id' => $teamId
                ];
            }
        }
        
        return $results;
    }
    
    /**
     * 降级角色权限
     */
    public function downgradeRolePermissions(string $roleName, int $teamId): array
    {
        // 定义权限等级
        $permissionLevels = [
            'delete' => 5,    // 删除权限
            'approve' => 4,   // 审批权限
            'edit' => 3,      // 编辑权限
            'create' => 2,    // 创建权限
            'view' => 1       // 查看权限
        ];
        
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            throw new \Exception("角色 {$roleName} 在团队 {$teamId} 中不存在");
        }
        
        $currentPermissions = $role->permissions->pluck('name')->toArray();
        $revokedPermissions = [];
        
        // 根据角色类型确定要删除的权限等级
        $maxLevel = match($roleName) {
            'viewer' => 1,      // 只保留查看权限
            'creator' => 2,     // 保留查看和创建权限
            'editor' => 3,      // 保留查看、创建和编辑权限
            'approver' => 4,    // 保留查看、创建、编辑和审批权限
            default => 5        // 保留所有权限
        };
        
        foreach ($currentPermissions as $permission) {
            // 解析权限等级
            $level = 1; // 默认为查看权限
            foreach ($permissionLevels as $action => $actionLevel) {
                if (str_contains($permission, $action)) {
                    $level = $actionLevel;
                    break;
                }
            }
            
            // 如果权限等级超过角色允许的最大等级，则删除
            if ($level > $maxLevel) {
                $role->revokePermissionTo($permission);
                $revokedPermissions[] = $permission;
            }
        }
        
        // 清除缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'role' => $roleName,
            'team_id' => $teamId,
            'max_level' => $maxLevel,
            'revoked_permissions' => $revokedPermissions,
            'remaining_permissions' => array_diff($currentPermissions, $revokedPermissions)
        ];
    }
    
    /**
     * 清理过期权限
     */
    public function cleanupExpiredRolePermissions(int $teamId): array
    {
        // 假设权限有过期时间字段
        $expiredPermissions = \Spatie\Permission\Models\Permission::where('team_id', $teamId)
            ->where('expires_at', '<', now())
            ->get();
        
        $results = [];
        
        foreach ($expiredPermissions as $permission) {
            $rolesWithPermission = \Spatie\Permission\Models\Role::whereHas('permissions', function($query) use ($permission) {
                $query->where('id', $permission->id);
            })->where('team_id', $teamId)->get();
            
            foreach ($rolesWithPermission as $role) {
                $role->revokePermissionTo($permission);
                
                if (!isset($results[$role->name])) {
                    $results[$role->name] = [];
                }
                $results[$role->name][] = $permission->name;
            }
        }
        
        // 清除缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
}

// 使用角色权限删除服务
$revocationService = new RolePermissionRevocationService();

// 从单个角色删除权限
$result = $revocationService->revokePermissionsFromRole('editor', ['delete_orders', 'approve_orders'], 7);
echo "从编辑者角色删除的权限: " . implode(', ', $result['revoked']) . "\n";

// 批量从多个角色删除权限
$rolePermissions = [
    'editor' => ['delete_orders', 'approve_orders'],
    'creator' => ['delete_orders'],
    'viewer' => ['edit_orders', 'create_orders']
];
$results = $revocationService->bulkRevokePermissionsFromRoles($rolePermissions, 7);

foreach ($results as $roleName => $result) {
    if (isset($result['error'])) {
        echo "角色 {$roleName} 删除失败: {$result['error']}\n";
    } else {
        echo "角色 {$roleName} 删除的权限: " . implode(', ', $result['revoked']) . "\n";
    }
}

// 降级角色权限
$downgradeResult = $revocationService->downgradeRolePermissions('editor', 7);
echo "编辑者角色降级，删除的权限: " . implode(', ', $downgradeResult['revoked_permissions']) . "\n";

// 清理过期权限
$cleanupResults = $revocationService->cleanupExpiredRolePermissions(7);
foreach ($cleanupResults as $roleName => $expiredPermissions) {
    echo "角色 {$roleName} 清理的过期权限: " . implode(', ', $expiredPermissions) . "\n";
}
```

### 多团队角色权限删除

#### 跨团队批量删除角色权限
```php
// 跨多个团队删除角色权限
function revokeRolePermissionsAcrossTeams(string $roleName, array $permissions, array $teamIds): array
{
    $results = [];
    
    foreach ($teamIds as $teamId) {
        try {
            // 设置团队上下文
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $teamId)
                ->first();
            
            if (!$role) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => "角色 {$roleName} 在团队 {$teamId} 中不存在"
                ];
                continue;
            }
            
            $revokedPermissions = [];
            foreach ($permissions as $permission) {
                if ($role->hasPermissionTo($permission)) {
                    $role->revokePermissionTo($permission);
                    $revokedPermissions[] = $permission;
                }
            }
            
            $results[$teamId] = [
                'success' => true,
                'role' => $roleName,
                'revoked_permissions' => $revokedPermissions,
                'message' => "成功删除 " . count($revokedPermissions) . " 个权限"
            ];
            
        } catch (\Exception $e) {
            $results[$teamId] = [
                'success' => false,
                'message' => $e->getMessage()
            ];
        }
    }
    
    // 清除权限缓存
    app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
    
    return $results;
}

// 使用示例
$teamIds = [5, 7, 10, 15];
$permissions = ['delete_orders', 'approve_orders'];
$results = revokeRolePermissionsAcrossTeams('editor', $permissions, $teamIds);

foreach ($results as $teamId => $result) {
    if ($result['success']) {
        echo "团队 {$teamId}: {$result['message']}\n";
        echo "  删除的权限: " . implode(', ', $result['revoked_permissions']) . "\n";
    } else {
        echo "团队 {$teamId}: 失败 - {$result['message']}\n";
    }
}
```

#### 多团队角色权限管理服务
```php
class MultiTeamRolePermissionService
{
    /**
     * 在所有团队中删除角色的特定权限
     */
    public function revokePermissionFromRoleGlobally(string $roleName, array $permissions): array
    {
        $teams = Team::all();
        $results = [];
        
        foreach ($teams as $team) {
            try {
                // 设置团队上下文
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($team->id);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $team->id)
                    ->first();
                
                if (!$role) {
                    $results[$team->id] = [
                        'team_name' => $team->name,
                        'success' => false,
                        'message' => "角色不存在"
                    ];
                    continue;
                }
                
                $revokedPermissions = [];
                foreach ($permissions as $permission) {
                    if ($role->hasPermissionTo($permission)) {
                        $role->revokePermissionTo($permission);
                        $revokedPermissions[] = $permission;
                    }
                }
                
                $results[$team->id] = [
                    'team_name' => $team->name,
                    'success' => true,
                    'revoked_permissions' => $revokedPermissions,
                    'count' => count($revokedPermissions)
                ];
                
            } catch (\Exception $e) {
                $results[$team->id] = [
                    'team_name' => $team->name,
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // 清除权限缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * 在指定团队中同步角色权限
     */
    public function syncRolePermissionsAcrossTeams(string $roleName, array $permissions, array $teamIds): array
    {
        $results = [];
        
        foreach ($teamIds as $teamId) {
            try {
                // 设置团队上下文
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $teamId)
                    ->first();
                
                if (!$role) {
                    $results[$teamId] = [
                        'success' => false,
                        'message' => "角色不存在"
                    ];
                    continue;
                }
                
                // 获取当前权限
                $currentPermissions = $role->permissions->pluck('name')->toArray();
                
                // 同步权限
                $role->syncPermissions($permissions);
                
                $results[$teamId] = [
                    'success' => true,
                    'previous_permissions' => $currentPermissions,
                    'new_permissions' => $permissions,
                    'added' => array_diff($permissions, $currentPermissions),
                    'removed' => array_diff($currentPermissions, $permissions)
                ];
                
            } catch (\Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // 清除权限缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * 批量降级多个团队的角色权限
     */
    public function bulkDowngradeRolePermissions(string $roleName, array $teamIds, int $maxPermissionLevel = 3): array
    {
        $permissionLevels = [
            'delete' => 5,
            'approve' => 4,
            'edit' => 3,
            'create' => 2,
            'view' => 1
        ];
        
        $results = [];
        
        foreach ($teamIds as $teamId) {
            try {
                // 设置团队上下文
                app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
                
                $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                    ->where('team_id', $teamId)
                    ->first();
                
                if (!$role) {
                    $results[$teamId] = [
                        'success' => false,
                        'message' => "角色不存在"
                    ];
                    continue;
                }
                
                $currentPermissions = $role->permissions->pluck('name')->toArray();
                $revokedPermissions = [];
                
                foreach ($currentPermissions as $permission) {
                    $level = 1; // 默认为查看权限
                    foreach ($permissionLevels as $action => $actionLevel) {
                        if (str_contains($permission, $action)) {
                            $level = $actionLevel;
                            break;
                        }
                    }
                    
                    if ($level > $maxPermissionLevel) {
                        $role->revokePermissionTo($permission);
                        $revokedPermissions[] = $permission;
                    }
                }
                
                $results[$teamId] = [
                    'success' => true,
                    'max_level' => $maxPermissionLevel,
                    'revoked_permissions' => $revokedPermissions,
                    'remaining_permissions' => array_diff($currentPermissions, $revokedPermissions)
                ];
                
            } catch (\Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'message' => $e->getMessage()
                ];
            }
        }
        
        // 清除权限缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return $results;
    }
    
    /**
     * 获取角色在所有团队的权限差异报告
     */
    public function getRolePermissionDifferenceReport(string $roleName): array
    {
        $teams = Team::all();
        $report = [
            'role_name' => $roleName,
            'teams' => [],
            'permission_summary' => []
        ];
        
        $allPermissions = collect();
        
        foreach ($teams as $team) {
            // 设置团队上下文
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($team->id);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $team->id)
                ->first();
            
            if ($role) {
                $permissions = $role->permissions->pluck('name')->toArray();
                $report['teams'][$team->id] = [
                    'team_name' => $team->name,
                    'permissions' => $permissions,
                    'permission_count' => count($permissions)
                ];
                
                $allPermissions = $allPermissions->merge($permissions);
            } else {
                $report['teams'][$team->id] = [
                    'team_name' => $team->name,
                    'permissions' => [],
                    'permission_count' => 0,
                    'note' => '角色不存在'
                ];
            }
        }
        
        // 生成权限摘要
        $uniquePermissions = $allPermissions->unique()->values()->toArray();
        $report['permission_summary'] = [
            'total_unique_permissions' => count($uniquePermissions),
            'permissions' => $uniquePermissions,
            'teams_with_role' => count(array_filter($report['teams'], function($team) {
                return !isset($team['note']);
            }))
        ];
        
        return $report;
    }
}

// 使用多团队角色权限管理服务
$multiTeamService = new MultiTeamRolePermissionService();

// 全局删除角色权限
$globalResults = $multiTeamService->revokePermissionFromRoleGlobally('editor', ['delete_orders']);
echo "全局删除编辑者角色的删除权限:\n";
foreach ($globalResults as $teamId => $result) {
    if ($result['success']) {
        echo "  团队 {$result['team_name']}: 删除了 {$result['count']} 个权限\n";
    } else {
        echo "  团队 {$result['team_name']}: 失败 - {$result['message']}\n";
    }
}

// 跨团队同步角色权限
$syncResults = $multiTeamService->syncRolePermissionsAcrossTeams(
    'editor', 
    ['view_orders', 'edit_orders', 'create_orders'], 
    [5, 7, 10]
);
echo "\n跨团队同步编辑者角色权限:\n";
foreach ($syncResults as $teamId => $result) {
    if ($result['success']) {
        echo "  团队 {$teamId}:\n";
        echo "    添加权限: " . implode(', ', $result['added']) . "\n";
        echo "    删除权限: " . implode(', ', $result['removed']) . "\n";
    }
}

// 批量降级角色权限
$downgradeResults = $multiTeamService->bulkDowngradeRolePermissions('editor', [5, 7, 10], 3);
echo "\n批量降级编辑者角色权限（最高等级3）:\n";
foreach ($downgradeResults as $teamId => $result) {
    if ($result['success']) {
        echo "  团队 {$teamId}: 删除了 " . count($result['revoked_permissions']) . " 个高级权限\n";
    }
}

// 获取角色权限差异报告
$report = $multiTeamService->getRolePermissionDifferenceReport('editor');
echo "\n编辑者角色权限差异报告:\n";
echo "总计唯一权限: {$report['permission_summary']['total_unique_permissions']}\n";
echo "拥有该角色的团队数: {$report['permission_summary']['teams_with_role']}\n";
```

#### 多团队权限删除的最佳实践

##### 1. 批量操作前的预检查
```php
// 多团队操作前的预检查
function preCheckMultiTeamRolePermissionRevocation(string $roleName, array $permissions, array $teamIds): array
{
    $checkResults = [];
    
    foreach ($teamIds as $teamId) {
        $team = Team::find($teamId);
        if (!$team) {
            $checkResults[$teamId] = [
                'valid' => false,
                'message' => '团队不存在'
            ];
            continue;
        }
        
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $role = \Spatie\Permission\Models\Role::where('name', $roleName)
            ->where('team_id', $teamId)
            ->first();
        
        if (!$role) {
            $checkResults[$teamId] = [
                'valid' => false,
                'team_name' => $team->name,
                'message' => '角色不存在'
            ];
            continue;
        }
        
        $existingPermissions = [];
        $missingPermissions = [];
        
        foreach ($permissions as $permission) {
            if ($role->hasPermissionTo($permission)) {
                $existingPermissions[] = $permission;
            } else {
                $missingPermissions[] = $permission;
            }
        }
        
        $checkResults[$teamId] = [
            'valid' => !empty($existingPermissions),
            'team_name' => $team->name,
            'role_exists' => true,
            'existing_permissions' => $existingPermissions,
            'missing_permissions' => $missingPermissions,
            'can_revoke_count' => count($existingPermissions)
        ];
    }
    
    return $checkResults;
}

// 使用预检查
$preCheckResults = preCheckMultiTeamRolePermissionRevocation('editor', ['delete_orders', 'approve_orders'], [5, 7, 10]);
foreach ($preCheckResults as $teamId => $result) {
    echo "团队 {$teamId} ({$result['team_name']}): ";
    if ($result['valid']) {
        echo "可删除 {$result['can_revoke_count']} 个权限\n";
    } else {
        echo "无法操作 - {$result['message']}\n";
    }
}
```

##### 2. 多团队操作的事务处理
```php
// 多团队权限删除的事务处理
function transactionalMultiTeamRolePermissionRevocation(string $roleName, array $permissions, array $teamIds): array
{
    DB::beginTransaction();
    
    try {
        $results = [];
        $rollbackData = [];
        
        foreach ($teamIds as $teamId) {
            // 设置团队上下文
            app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
            
            $role = \Spatie\Permission\Models\Role::where('name', $roleName)
                ->where('team_id', $teamId)
                ->first();
            
            if (!$role) {
                continue;
            }
            
            // 记录当前权限用于回滚
            $currentPermissions = $role->permissions->pluck('name')->toArray();
            $rollbackData[$teamId] = $currentPermissions;
            
            // 删除权限
            $revokedPermissions = [];
            foreach ($permissions as $permission) {
                if ($role->hasPermissionTo($permission)) {
                    $role->revokePermissionTo($permission);
                    $revokedPermissions[] = $permission;
                }
            }
            
            $results[$teamId] = [
                'success' => true,
                'revoked_permissions' => $revokedPermissions
            ];
        }
        
        DB::commit();
        
        // 清除权限缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        return [
            'success' => true,
            'results' => $results,
            'rollback_data' => $rollbackData
        ];
        
    } catch (\Exception $e) {
        DB::rollback();
        
        return [
            'success' => false,
            'message' => $e->getMessage(),
            'rollback_data' => $rollbackData ?? []
        ];
    }
}
```

### 角色权限删除的最佳实践

#### 1. 删除前验证
```php
// 删除角色权限前的安全检查
function validateRolePermissionRevocation(string $roleName, string $permission, int $teamId): bool
{
    // 检查角色是否存在
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->first();
    
    if (!$role) {
        throw new \Exception("角色 {$roleName} 不存在");
    }
    
    // 检查权限是否存在
    $permissionExists = \Spatie\Permission\Models\Permission::where('name', $permission)
        ->where('team_id', $teamId)
        ->exists();
    
    if (!$permissionExists) {
        throw new \Exception("权限 {$permission} 不存在");
    }
    
    // 检查角色是否有该权限
    if (!$role->hasPermissionTo($permission)) {
        throw new \Exception("角色 {$roleName} 没有权限 {$permission}");
    }
    
    // 检查是否是关键权限
    $criticalPermissions = ['manage_team', 'delete_team'];
    if (in_array($permission, $criticalPermissions) && $roleName === 'owner') {
        throw new \Exception("不能删除团队所有者的关键权限");
    }
    
    return true;
}
```

#### 2. 删除权限日志记录
```php
// 记录角色权限删除操作
function logRolePermissionRevocation(string $roleName, string $permission, int $teamId, User $operator): void
{
    Log::info('Role permission revoked', [
        'role_name' => $roleName,
        'permission' => $permission,
        'team_id' => $teamId,
        'operator_id' => $operator->id,
        'operator_name' => $operator->name,
        'timestamp' => now(),
        'ip_address' => request()->ip()
    ]);
}

// 在删除权限时调用
$role->revokePermissionTo('delete_orders');
logRolePermissionRevocation('editor', 'delete_orders', 7, auth()->user());
```

#### 3. 影响用户通知
```php
// 通知受影响的用户
function notifyUsersOfRolePermissionRevocation(string $roleName, array $revokedPermissions, int $teamId): void
{
    // 查找拥有该角色的所有用户
    $affectedUsers = User::whereHas('roles', function($query) use ($roleName, $teamId) {
        $query->where('name', $roleName)->where('team_id', $teamId);
    })->get();
    
    foreach ($affectedUsers as $user) {
        $user->notify(new RolePermissionRevokedNotification([
            'role_name' => $roleName,
            'revoked_permissions' => $revokedPermissions,
            'team_id' => $teamId,
            'revoked_at' => now()
        ]));
    }
    
    echo "已通知 " . $affectedUsers->count() . " 个用户角色权限变更\n";
}

// 使用示例
$revokedPermissions = ['delete_orders', 'approve_orders'];
notifyUsersOfRolePermissionRevocation('editor', $revokedPermissions, 7);
```

#### 4. 权限删除回滚
```php
// 权限删除回滚功能
class RolePermissionRevocationRollback
{
    private array $revocationHistory = [];
    
    public function recordRevocation(string $roleName, array $permissions, int $teamId): string
    {
        $rollbackId = uniqid('rollback_');
        $this->revocationHistory[$rollbackId] = [
            'role_name' => $roleName,
            'permissions' => $permissions,
            'team_id' => $teamId,
            'revoked_at' => now(),
            'operator_id' => auth()->id()
        ];
        
        return $rollbackId;
    }
    
    public function rollback(string $rollbackId): bool
    {
        if (!isset($this->revocationHistory[$rollbackId])) {
            throw new \Exception("回滚记录不存在");
        }
        
        $record = $this->revocationHistory[$rollbackId];
        
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($record['team_id']);
        
        $role = \Spatie\Permission\Models\Role::where('name', $record['role_name'])
            ->where('team_id', $record['team_id'])
            ->first();
        
        if (!$role) {
            throw new \Exception("角色不存在，无法回滚");
        }
        
        // 重新分配权限
        $role->givePermissionTo($record['permissions']);
        
        // 清除缓存
        app(\Spatie\Permission\PermissionRegistrar::class)->forgetCachedPermissions();
        
        // 记录回滚操作
        Log::info('Role permission revocation rolled back', [
            'rollback_id' => $rollbackId,
            'role_name' => $record['role_name'],
            'permissions' => $record['permissions'],
            'team_id' => $record['team_id'],
            'rolled_back_by' => auth()->id()
        ]);
        
        return true;
    }
}

// 使用回滚功能
$rollbackService = new RolePermissionRevocationRollback();

// 记录删除操作
$rollbackId = $rollbackService->recordRevocation('editor', ['delete_orders', 'approve_orders'], 7);

// 执行删除
$role->revokePermissionTo(['delete_orders', 'approve_orders']);

// 如果需要回滚
// $rollbackService->rollback($rollbackId);
```

## 🔄 角色同步

### syncRolesSafely()
替换用户在当前团队的所有角色。

```php
// 同步角色（替换当前团队的所有角色）
$user->syncRolesSafely(['editor', 'approver']);

// 清空当前团队的所有角色
$user->syncRolesSafely([]);

// 条件性角色同步
function syncUserRoles(User $user, array $newRoles): array
{
    $currentRoles = $user->getRoleNames()->toArray();
    
    // 比较角色变化
    $addedRoles = array_diff($newRoles, $currentRoles);
    $removedRoles = array_diff($currentRoles, $newRoles);
    
    // 执行同步
    $user->syncRolesSafely($newRoles);
    
    return [
        'added' => $addedRoles,
        'removed' => $removedRoles,
        'current' => $newRoles
    ];
}

// 使用示例
$changes = syncUserRoles($user, ['creator', 'approver']);
echo "添加的角色: " . implode(', ', $changes['added']) . "\n";
echo "移除的角色: " . implode(', ', $changes['removed']) . "\n";
```

### 跨团队角色同步

```php
// 同步用户在所有团队的角色
class UserRoleSyncService
{
    public function syncUserRolesAcrossTeams(User $user, array $teamRoles): array
    {
        $results = [];
        
        foreach ($teamRoles as $teamId => $roles) {
            try {
                $user->withTeamContext($teamId, function($user) use ($roles) {
                    $user->syncRoles($roles);
                });
                
                $results[$teamId] = [
                    'success' => true,
                    'roles' => $roles
                ];
                
            } catch (Exception $e) {
                $results[$teamId] = [
                    'success' => false,
                    'error' => $e->getMessage()
                ];
            }
        }
        
        return $results;
    }
}

// 使用服务
$syncService = new UserRoleSyncService();
$teamRoles = [
    5 => ['viewer'],
    7 => ['editor', 'approver'],
    10 => ['creator', 'editor']
];

$results = $syncService->syncUserRolesAcrossTeams($user, $teamRoles);
```

## 🔍 角色查询

### 基本角色查询

```php
// 获取当前团队的角色
$currentRoles = $user->roles;
foreach ($currentRoles as $role) {
    echo "角色: {$role->name} (团队: {$role->team_id})\n";
}

// 获取角色名称
$roleNames = $user->getRoleNames();
echo "当前团队角色: " . $roleNames->implode(', ');

// 检查是否有特定角色
if ($user->hasRole('creator')) {
    echo "用户是创建者";
}

// 检查是否有任意角色
if ($user->hasAnyRole(['creator', 'editor', 'approver'])) {
    echo "用户是内容管理者";
}

// 检查是否有所有角色
if ($user->hasAllRoles(['creator', 'editor'])) {
    echo "用户既是创建者又是编辑者";
}
```

### 跨团队角色查询

#### getRolesInTeam()
获取用户在指定团队中的角色。

```php
// 获取用户在团队5中的角色
$team5Roles = $user->getRolesInTeam(5);
foreach ($team5Roles as $role) {
    echo "团队5角色: {$role->name}\n";
}

// 检查用户在指定团队是否有特定角色
function hasRoleInTeam(User $user, int $teamId, string $roleName): bool
{
    $rolesInTeam = $user->getRolesInTeam($teamId);
    return $rolesInTeam->contains('name', $roleName);
}

// 使用示例
if (hasRoleInTeam($user, 5, 'viewer')) {
    echo "用户在团队5是查看者";
}
```

#### getAllRoles()
获取用户在所有团队中的角色。

```php
// 获取用户的所有角色
$allRoles = $user->getAllRoles();
foreach ($allRoles as $role) {
    echo "角色: {$role->name} (团队: {$role->pivot_team_id})\n";
}

// 按团队分组角色
$rolesByTeam = $allRoles->groupBy('pivot_team_id');
foreach ($rolesByTeam as $teamId => $roles) {
    echo "团队 {$teamId}: " . $roles->pluck('name')->implode(', ') . "\n";
}

// 统计角色信息
$roleStats = [
    'total_roles' => $allRoles->count(),
    'unique_roles' => $allRoles->pluck('name')->unique()->count(),
    'teams_count' => $allRoles->pluck('pivot_team_id')->unique()->count()
];

echo "角色统计: " . json_encode($roleStats, JSON_UNESCAPED_UNICODE);
```

### 高级角色查询

```php
// 创建角色查询服务
class RoleQueryService
{
    public function getUserRoleMatrix(User $user): array
    {
        $allRoles = $user->getAllRoles();
        $teams = Team::all();
        $roleTypes = ['owner', 'viewer', 'creator', 'approver', 'editor'];
        
        $matrix = [];
        foreach ($teams as $team) {
            $matrix[$team->id] = [
                'team_name' => $team->name,
                'roles' => []
            ];
            
            foreach ($roleTypes as $roleType) {
                $hasRole = $allRoles->where('pivot_team_id', $team->id)
                    ->where('name', $roleType)
                    ->isNotEmpty();
                    
                $matrix[$team->id]['roles'][$roleType] = $hasRole;
            }
        }
        
        return $matrix;
    }
    
    public function findUsersWithRole(string $roleName, int $teamId = null): Collection
    {
        $query = User::whereHas('roles', function($q) use ($roleName, $teamId) {
            $q->where('name', $roleName);
            if ($teamId) {
                $q->where('team_id', $teamId);
            }
        });
        
        return $query->get();
    }
    
    public function getRoleHierarchy(User $user, int $teamId): array
    {
        $rolesInTeam = $user->getRolesInTeam($teamId);
        
        // 定义角色层次（权重越高权限越大）
        $hierarchy = [
            'owner' => 5,
            'approver' => 4,
            'editor' => 3,
            'creator' => 2,
            'viewer' => 1
        ];
        
        $userRoles = $rolesInTeam->pluck('name')->toArray();
        $maxWeight = 0;
        $highestRole = null;
        
        foreach ($userRoles as $role) {
            if (isset($hierarchy[$role]) && $hierarchy[$role] > $maxWeight) {
                $maxWeight = $hierarchy[$role];
                $highestRole = $role;
            }
        }
        
        return [
            'roles' => $userRoles,
            'highest_role' => $highestRole,
            'weight' => $maxWeight
        ];
    }
}

// 使用角色查询服务
$queryService = new RoleQueryService();

// 获取用户角色矩阵
$matrix = $queryService->getUserRoleMatrix($user);
foreach ($matrix as $teamId => $teamData) {
    echo "团队: {$teamData['team_name']}\n";
    foreach ($teamData['roles'] as $role => $hasRole) {
        echo "  {$role}: " . ($hasRole ? '✓' : '✗') . "\n";
    }
}

// 查找拥有特定角色的用户
$creators = $queryService->findUsersWithRole('creator', 10);
echo "团队10的创建者: " . $creators->pluck('name')->implode(', ');

// 获取角色层次
$hierarchy = $queryService->getRoleHierarchy($user, 10);
echo "用户在团队10的最高角色: {$hierarchy['highest_role']} (权重: {$hierarchy['weight']})";
```

## 🔐 通过角色查询权限

### 获取角色权限

#### 获取角色的所有权限
```php
// 获取指定角色的所有权限
$role = \Spatie\Permission\Models\Role::findByName('editor');
$permissions = $role->permissions;

foreach ($permissions as $permission) {
    echo "权限: {$permission->name} (团队: {$permission->team_id})\n";
}

// 获取权限名称数组
$permissionNames = $role->permissions->pluck('name')->toArray();
echo "编辑者权限: " . implode(', ', $permissionNames);
```

#### 检查角色是否有特定权限
```php
// 检查角色是否有特定权限
$role = \Spatie\Permission\Models\Role::findByName('editor');

if ($role->hasPermissionTo('edit_orders')) {
    echo "编辑者角色有编辑订单权限";
}

// 检查角色是否有任意权限
$orderPermissions = ['view_orders', 'edit_orders', 'create_orders'];
if ($role->hasAnyPermission($orderPermissions)) {
    echo "编辑者角色有订单相关权限";
}

// 检查角色是否有所有权限
if ($role->hasAllPermissions($orderPermissions)) {
    echo "编辑者角色有所有订单权限";
}
```

### 通过用户角色查询权限

#### 获取用户通过角色获得的权限
```php
// 获取用户通过角色获得的所有权限
$user = User::find(1);

// 方法1：通过角色关联获取
$rolePermissions = collect();
foreach ($user->roles as $role) {
    $rolePermissions = $rolePermissions->merge($role->permissions);
}

// 去重并显示
$uniquePermissions = $rolePermissions->unique('id');
echo "通过角色获得的权限数量: " . $uniquePermissions->count() . "\n";

// 方法2：使用查询构建器
$rolePermissions = \Spatie\Permission\Models\Permission::whereHas('roles', function($query) use ($user) {
    $query->whereIn('id', $user->roles->pluck('id'));
})->get();

foreach ($rolePermissions as $permission) {
    echo "角色权限: {$permission->name}\n";
}
```

#### 区分直接权限和角色权限
```php
// 区分用户的直接权限和角色权限
function analyzeUserPermissions(User $user): array
{
    // 获取直接权限
    $directPermissions = $user->getDirectPermissions();
    
    // 获取通过角色获得的权限
    $rolePermissions = collect();
    foreach ($user->roles as $role) {
        $rolePermissions = $rolePermissions->merge($role->permissions);
    }
    $rolePermissions = $rolePermissions->unique('id');
    
    // 获取所有权限
    $allPermissions = $user->getAllPermissions();
    
    return [
        'direct_permissions' => $directPermissions->pluck('name')->toArray(),
        'role_permissions' => $rolePermissions->pluck('name')->toArray(),
        'all_permissions' => $allPermissions->pluck('name')->toArray(),
        'direct_count' => $directPermissions->count(),
        'role_count' => $rolePermissions->count(),
        'total_count' => $allPermissions->count()
    ];
}

// 使用分析函数
$analysis = analyzeUserPermissions($user);
echo "直接权限 ({$analysis['direct_count']}): " . implode(', ', $analysis['direct_permissions']) . "\n";
echo "角色权限 ({$analysis['role_count']}): " . implode(', ', $analysis['role_permissions']) . "\n";
echo "总权限 ({$analysis['total_count']}): " . implode(', ', $analysis['all_permissions']) . "\n";
```

### 跨团队角色权限查询

#### 查询用户在所有团队的角色权限
```php
// 获取用户在所有团队的角色权限
function getUserRolePermissionsAcrossTeams(User $user): array
{
    $allRoles = $user->getAllRoles();
    $teamPermissions = [];
    
    foreach ($allRoles as $role) {
        $teamId = $role->pivot_team_id;
        
        if (!isset($teamPermissions[$teamId])) {
            $teamPermissions[$teamId] = [
                'team_id' => $teamId,
                'roles' => [],
                'permissions' => collect()
            ];
        }
        
        $teamPermissions[$teamId]['roles'][] = $role->name;
        $teamPermissions[$teamId]['permissions'] = $teamPermissions[$teamId]['permissions']
            ->merge($role->permissions);
    }
    
    // 去重权限
    foreach ($teamPermissions as $teamId => &$data) {
        $data['permissions'] = $data['permissions']->unique('id')->pluck('name')->toArray();
        $data['permission_count'] = count($data['permissions']);
    }
    
    return $teamPermissions;
}

// 使用示例
$teamPermissions = getUserRolePermissionsAcrossTeams($user);
foreach ($teamPermissions as $teamId => $data) {
    echo "团队 {$teamId}:\n";
    echo "  角色: " . implode(', ', $data['roles']) . "\n";
    echo "  权限数量: {$data['permission_count']}\n";
    echo "  权限列表: " . implode(', ', $data['permissions']) . "\n\n";
}
```

#### 查询特定团队的角色权限
```php
// 查询用户在指定团队通过角色获得的权限
function getUserRolePermissionsInTeam(User $user, int $teamId): array
{
    $rolesInTeam = $user->getRolesInTeam($teamId);
    $permissions = collect();
    
    foreach ($rolesInTeam as $role) {
        $permissions = $permissions->merge($role->permissions);
    }
    
    $uniquePermissions = $permissions->unique('id');
    
    return [
        'team_id' => $teamId,
        'roles' => $rolesInTeam->pluck('name')->toArray(),
        'permissions' => $uniquePermissions->pluck('name')->toArray(),
        'permission_objects' => $uniquePermissions->toArray()
    ];
}

// 使用示例
$teamRolePermissions = getUserRolePermissionsInTeam($user, 7);
echo "团队7角色权限分析:\n";
echo "角色: " . implode(', ', $teamRolePermissions['roles']) . "\n";
echo "权限: " . implode(', ', $teamRolePermissions['permissions']) . "\n";
```

### 角色权限查询服务

#### 创建角色权限查询服务
```php
class RolePermissionQueryService
{
    /**
     * 获取角色的权限矩阵
     */
    public function getRolePermissionMatrix(int $teamId): array
    {
        $roles = \Spatie\Permission\Models\Role::where('team_id', $teamId)->get();
        $permissions = \Spatie\Permission\Models\Permission::where('team_id', $teamId)->get();
        
        $matrix = [];
        foreach ($roles as $role) {
            $matrix[$role->name] = [];
            foreach ($permissions as $permission) {
                $matrix[$role->name][$permission->name] = $role->hasPermissionTo($permission);
            }
        }
        
        return $matrix;
    }
    
    /**
     * 查找拥有特定权限的角色
     */
    public function findRolesWithPermission(string $permissionName, int $teamId = null): Collection
    {
        $query = \Spatie\Permission\Models\Role::whereHas('permissions', function($q) use ($permissionName) {
            $q->where('name', $permissionName);
        });
        
        if ($teamId) {
            $query->where('team_id', $teamId);
        }
        
        return $query->get();
    }
    
    /**
     * 获取角色权限差异
     */
    public function compareRolePermissions(string $role1, string $role2, int $teamId): array
    {
        $roleObj1 = \Spatie\Permission\Models\Role::where('name', $role1)
            ->where('team_id', $teamId)->first();
        $roleObj2 = \Spatie\Permission\Models\Role::where('name', $role2)
            ->where('team_id', $teamId)->first();
        
        if (!$roleObj1 || !$roleObj2) {
            throw new \Exception('角色不存在');
        }
        
        $permissions1 = $roleObj1->permissions->pluck('name')->toArray();
        $permissions2 = $roleObj2->permissions->pluck('name')->toArray();
        
        return [
            'role1' => $role1,
            'role2' => $role2,
            'role1_only' => array_diff($permissions1, $permissions2),
            'role2_only' => array_diff($permissions2, $permissions1),
            'common' => array_intersect($permissions1, $permissions2),
            'role1_permissions' => $permissions1,
            'role2_permissions' => $permissions2
        ];
    }
    
    /**
     * 获取用户权限来源分析
     */
    public function analyzeUserPermissionSources(User $user, int $teamId): array
    {
        // 设置团队上下文
        app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        $directPermissions = $user->getDirectPermissions();
        $rolesInTeam = $user->getRolesInTeam($teamId);
        
        $analysis = [
            'team_id' => $teamId,
            'direct_permissions' => $directPermissions->pluck('name')->toArray(),
            'roles' => [],
            'permission_sources' => []
        ];
        
        // 分析每个角色的权限
        foreach ($rolesInTeam as $role) {
            $rolePermissions = $role->permissions->pluck('name')->toArray();
            $analysis['roles'][$role->name] = $rolePermissions;
        }
        
        // 分析每个权限的来源
        $allPermissions = $user->getAllPermissions();
        foreach ($allPermissions as $permission) {
            $sources = [];
            
            // 检查是否是直接权限
            if ($directPermissions->contains('id', $permission->id)) {
                $sources[] = 'direct';
            }
            
            // 检查来自哪些角色
            foreach ($rolesInTeam as $role) {
                if ($role->hasPermissionTo($permission)) {
                    $sources[] = "role:{$role->name}";
                }
            }
            
            $analysis['permission_sources'][$permission->name] = $sources;
        }
        
        return $analysis;
    }
    
    /**
     * 获取角色权限统计
     */
    public function getRolePermissionStats(int $teamId): array
    {
        $roles = \Spatie\Permission\Models\Role::where('team_id', $teamId)->with('permissions')->get();
        $stats = [];
        
        foreach ($roles as $role) {
            $permissions = $role->permissions;
            $permissionsByModule = $permissions->groupBy(function($permission) {
                // 假设权限格式为 action_module
                $parts = explode('_', $permission->name);
                return count($parts) > 1 ? $parts[1] : 'other';
            });
            
            $stats[$role->name] = [
                'total_permissions' => $permissions->count(),
                'permissions_by_module' => $permissionsByModule->map->count()->toArray(),
                'permission_list' => $permissions->pluck('name')->toArray()
            ];
        }
        
        return $stats;
    }
}

// 使用角色权限查询服务
$queryService = new RolePermissionQueryService();

// 获取角色权限矩阵
$matrix = $queryService->getRolePermissionMatrix(7);
echo "团队7角色权限矩阵:\n";
foreach ($matrix as $roleName => $permissions) {
    echo "角色 {$roleName}:\n";
    foreach ($permissions as $permissionName => $hasPermission) {
        echo "  {$permissionName}: " . ($hasPermission ? '✓' : '✗') . "\n";
    }
}

// 查找拥有特定权限的角色
$rolesWithEditPermission = $queryService->findRolesWithPermission('edit_orders', 7);
echo "拥有编辑订单权限的角色: " . $rolesWithEditPermission->pluck('name')->implode(', ') . "\n";

// 比较角色权限
$comparison = $queryService->compareRolePermissions('editor', 'creator', 7);
echo "编辑者独有权限: " . implode(', ', $comparison['role1_only']) . "\n";
echo "创建者独有权限: " . implode(', ', $comparison['role2_only']) . "\n";
echo "共同权限: " . implode(', ', $comparison['common']) . "\n";

// 分析用户权限来源
$analysis = $queryService->analyzeUserPermissionSources($user, 7);
echo "用户权限来源分析:\n";
echo "直接权限: " . implode(', ', $analysis['direct_permissions']) . "\n";
foreach ($analysis['permission_sources'] as $permission => $sources) {
    echo "权限 {$permission} 来源: " . implode(', ', $sources) . "\n";
}

// 获取角色权限统计
$stats = $queryService->getRolePermissionStats(7);
foreach ($stats as $roleName => $data) {
    echo "角色 {$roleName}: {$data['total_permissions']} 个权限\n";
    foreach ($data['permissions_by_module'] as $module => $count) {
        echo "  {$module} 模块: {$count} 个权限\n";
    }
}
```

### 权限继承查询

#### 查询权限继承关系
```php
// 查询用户权限的继承关系
function tracePermissionInheritance(User $user, string $permissionName, int $teamId): array
{
    $inheritance = [
        'permission' => $permissionName,
        'team_id' => $teamId,
        'has_permission' => false,
        'sources' => []
    ];
    
    // 设置团队上下文
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    // 检查用户是否有该权限
    $inheritance['has_permission'] = $user->hasPermissionTo($permissionName);
    
    if (!$inheritance['has_permission']) {
        return $inheritance;
    }
    
    // 检查直接权限
    if ($user->hasDirectPermission($permissionName)) {
        $inheritance['sources'][] = [
            'type' => 'direct',
            'source' => 'user',
            'granted_at' => null // 可以从数据库获取
        ];
    }
    
    // 检查角色权限
    $rolesInTeam = $user->getRolesInTeam($teamId);
    foreach ($rolesInTeam as $role) {
        if ($role->hasPermissionTo($permissionName)) {
            $inheritance['sources'][] = [
                'type' => 'role',
                'source' => $role->name,
                'role_id' => $role->id,
                'granted_at' => null // 可以从数据库获取
            ];
        }
    }
    
    return $inheritance;
}

// 使用权限继承查询
$inheritance = tracePermissionInheritance($user, 'edit_orders', 7);
echo "权限 {$inheritance['permission']} 继承关系:\n";
echo "拥有权限: " . ($inheritance['has_permission'] ? '是' : '否') . "\n";

if ($inheritance['has_permission']) {
    echo "权限来源:\n";
    foreach ($inheritance['sources'] as $source) {
        if ($source['type'] === 'direct') {
            echo "  - 直接权限\n";
        } else {
            echo "  - 角色权限: {$source['source']}\n";
        }
    }
}
```

### 权限查询优化

#### 批量权限查询
```php
// 批量查询用户权限状态
function batchCheckUserPermissions(User $user, array $permissions, int $teamId): array
{
    // 设置团队上下文
    app(\Spatie\Permission\PermissionRegistrar::class)->setPermissionsTeamId($teamId);
    
    // 预加载用户权限和角色
    $user->load(['permissions', 'roles.permissions']);
    
    $results = [];
    foreach ($permissions as $permission) {
        $results[$permission] = $user->hasPermissionTo($permission);
    }
    
    return $results;
}

// 批量查询角色权限状态
function batchCheckRolePermissions(string $roleName, array $permissions, int $teamId): array
{
    $role = \Spatie\Permission\Models\Role::where('name', $roleName)
        ->where('team_id', $teamId)
        ->with('permissions')
        ->first();
    
    if (!$role) {
        throw new \Exception("角色 {$roleName} 在团队 {$teamId} 中不存在");
    }
    
    $results = [];
    foreach ($permissions as $permission) {
        $results[$permission] = $role->hasPermissionTo($permission);
    }
    
    return $results;
}

// 使用批量查询
$permissionsToCheck = ['view_orders', 'edit_orders', 'create_orders', 'delete_orders', 'approve_orders'];

// 批量检查用户权限
$userPermissions = batchCheckUserPermissions($user, $permissionsToCheck, 7);
echo "用户权限状态:\n";
foreach ($userPermissions as $permission => $hasPermission) {
    echo "  {$permission}: " . ($hasPermission ? '✓' : '✗') . "\n";
}

// 批量检查角色权限
$rolePermissions = batchCheckRolePermissions('editor', $permissionsToCheck, 7);
echo "\n编辑者角色权限状态:\n";
foreach ($rolePermissions as $permission => $hasPermission) {
    echo "  {$permission}: " . ($hasPermission ? '✓' : '✗') . "\n";
}
```

## 🎯 角色管理最佳实践

### 角色分配策略

```php
// 创建角色管理策略
class RoleManagementStrategy
{
    public function assignNewUserRole(User $user, Team $team, string $defaultRole = 'viewer'): bool
    {
        try {
            // 更新用户当前团队
            $user->update(['current_team_id' => $team->id]);
            
            // 分配默认角色
            $user->assignRoleSafely($defaultRole);
            
            // 记录日志
            Log::info('新用户角色分配', [
                'user_id' => $user->id,
                'team_id' => $team->id,
                'role' => $defaultRole
            ]);
            
            return true;
            
        } catch (Exception $e) {
            Log::error('新用户角色分配失败', [
                'user_id' => $user->id,
                'team_id' => $team->id,
                'error' => $e->getMessage()
            ]);
            
            return false;
        }
    }
    
    public function promoteUser(User $user, int $teamId, string $newRole): bool
    {
        try {
            $currentRoles = $user->getRolesInTeam($teamId);
            
            // 检查是否已有更高权限
            $hierarchy = ['viewer' => 1, 'creator' => 2, 'editor' => 3, 'approver' => 4, 'owner' => 5];
            $currentMaxWeight = 0;
            
            foreach ($currentRoles as $role) {
                if (isset($hierarchy[$role->name])) {
                    $currentMaxWeight = max($currentMaxWeight, $hierarchy[$role->name]);
                }
            }
            
            $newWeight = $hierarchy[$newRole] ?? 0;
            
            if ($newWeight <= $currentMaxWeight) {
                throw new Exception("用户已有相同或更高权限的角色");
            }
            
            // 执行晋升
            $user->assignRoleInTeam($teamId, $newRole);
            
            Log::info('用户晋升成功', [
                'user_id' => $user->id,
                'team_id' => $teamId,
                'new_role' => $newRole,
                'previous_max_weight' => $currentMaxWeight
            ]);
            
            return true;
            
        } catch (Exception $e) {
            Log::error('用户晋升失败', [
                'user_id' => $user->id,
                'team_id' => $teamId,
                'new_role' => $newRole,
                'error' => $e->getMessage()
            ]);
            
            return false;
        }
    }
}
```

### 角色变更通知

```php
// 创建角色变更通知系统
class RoleChangeNotificationService
{
    public function notifyRoleChange(User $user, int $teamId, array $changes): void
    {
        $team = Team::find($teamId);
        
        // 发送邮件通知
        if (!empty($changes['added'])) {
            Mail::to($user->email)->send(new RoleAssignedMail($user, $team, $changes['added']));
        }
        
        if (!empty($changes['removed'])) {
            Mail::to($user->email)->send(new RoleRemovedMail($user, $team, $changes['removed']));
        }
        
        // 发送系统通知
        $user->notify(new RoleChangeNotification($team, $changes));
        
        // 记录审计日志
        AuditLog::create([
            'user_id' => $user->id,
            'team_id' => $teamId,
            'action' => 'role_change',
            'details' => $changes,
            'performed_by' => auth()->id()
        ]);
    }
}

// 在角色变更时使用通知服务
class User extends Authenticatable
{
    public function assignRoleSafely($roles): self
    {
        $beforeRoles = $this->getRoleNames()->toArray();
        
        parent::assignRoleSafely($roles);
        
        $afterRoles = $this->getRoleNames()->toArray();
        $changes = [
            'added' => array_diff($afterRoles, $beforeRoles),
            'removed' => array_diff($beforeRoles, $afterRoles)
        ];
        
        if (!empty($changes['added']) || !empty($changes['removed'])) {
            app(RoleChangeNotificationService::class)
                ->notifyRoleChange($this, $this->current_team_id, $changes);
        }
        
        return $this;
    }
}
```

### 角色权限验证

```php
// 创建角色权限验证器
class RolePermissionValidator
{
    public function validateRoleAssignment(User $assigner, User $target, int $teamId, string $role): bool
    {
        // 检查分配者是否有权限管理该团队
        if (!$assigner->hasPermissionInTeam($teamId, 'manage_team_members')) {
            throw new UnauthorizedException('您没有管理该团队成员的权限');
        }
        
        // 检查角色是否存在
        $roleExists = \Spatie\Permission\Models\Role::where('name', $role)
            ->where('team_id', $teamId)
            ->exists();
            
        if (!$roleExists) {
            throw new InvalidArgumentException("角色 '{$role}' 在该团队中不存在");
        }
        
        // 检查是否尝试分配比自己更高的权限
        $assignerHierarchy = $this->getUserRoleHierarchy($assigner, $teamId);
        $targetRoleWeight = $this->getRoleWeight($role);
        
        if ($targetRoleWeight >= $assignerHierarchy['weight'] && !$assigner->hasRole('super_admin')) {
            throw new UnauthorizedException('您不能分配比自己权限更高或相等的角色');
        }
        
        return true;
    }
    
    private function getRoleWeight(string $role): int
    {
        $weights = [
            'viewer' => 1,
            'creator' => 2,
            'editor' => 3,
            'approver' => 4,
            'owner' => 5
        ];
        
        return $weights[$role] ?? 0;
    }
    
    private function getUserRoleHierarchy(User $user, int $teamId): array
    {
        $roles = $user->getRolesInTeam($teamId);
        $maxWeight = 0;
        
        foreach ($roles as $role) {
            $weight = $this->getRoleWeight($role->name);
            $maxWeight = max($maxWeight, $weight);
        }
        
        return ['weight' => $maxWeight];
    }
}

// 在控制器中使用验证器
class TeamMemberController extends Controller
{
    protected RolePermissionValidator $validator;
    
    public function __construct(RolePermissionValidator $validator)
    {
        $this->validator = $validator;
    }
    
    public function assignRole(Request $request)
    {
        $validated = $request->validate([
            'user_id' => 'required|exists:users,id',
            'team_id' => 'required|exists:teams,id',
            'role' => 'required|string'
        ]);
        
        $assigner = auth()->user();
        $target = User::find($validated['user_id']);
        
        try {
            // 验证角色分配权限
            $this->validator->validateRoleAssignment(
                $assigner,
                $target,
                $validated['team_id'],
                $validated['role']
            );
            
            // 执行角色分配
            $target->assignRoleInTeam($validated['team_id'], $validated['role']);
            
            return response()->json([
                'success' => true,
                'message' => '角色分配成功'
            ]);
            
        } catch (Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage()
            ], 403);
        }
    }
}
```

通过这些角色管理方法和最佳实践，您可以实现一个完整、安全、易维护的角色管理系统。记住始终使用安全方法，进行适当的验证，并实施必要的通知和审计机制。 