# MESåç«¯Redisç¼“å­˜æœåŠ¡é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†MESåç«¯ç³»ç»ŸRedisç¼“å­˜æœåŠ¡çš„å®‰è£…ã€é…ç½®å’Œä¼˜åŒ–æ–¹æ³•ï¼Œæ¶µç›–å•æœºéƒ¨ç½²ã€é›†ç¾¤é…ç½®å’Œé«˜å¯ç”¨æ–¹æ¡ˆã€‚

## ğŸ”§ Rediså®‰è£…

### Ubuntu/Debianç¯å¢ƒ

```bash
# æ›´æ–°åŒ…åˆ—è¡¨
sudo apt update

# å®‰è£…RedisæœåŠ¡å™¨
sudo apt install -y redis-server

# æˆ–è€…å®‰è£…æœ€æ–°ç‰ˆæœ¬
curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
sudo apt update
sudo apt install -y redis

# å¯åŠ¨å¹¶å¯ç”¨RedisæœåŠ¡
sudo systemctl start redis-server
sudo systemctl enable redis-server

# éªŒè¯å®‰è£…
redis-cli ping
```

### CentOS/RHELç¯å¢ƒ

```bash
# å®‰è£…EPELä»“åº“
sudo dnf install -y epel-release

# å®‰è£…Redis
sudo dnf install -y redis

# æˆ–è€…ç¼–è¯‘å®‰è£…æœ€æ–°ç‰ˆæœ¬
wget http://download.redis.io/redis-stable.tar.gz
tar xzf redis-stable.tar.gz
cd redis-stable
make
sudo make install

# å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡
sudo systemctl start redis
sudo systemctl enable redis

# éªŒè¯å®‰è£…
redis-cli ping
```

### macOSç¯å¢ƒ

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install redis

# å¯åŠ¨æœåŠ¡
brew services start redis

# éªŒè¯å®‰è£…
redis-cli ping
```

### Dockeréƒ¨ç½²

```bash
# å•æœºéƒ¨ç½²
docker run -d --name redis-server -p 6379:6379 redis:7-alpine

# ä½¿ç”¨é…ç½®æ–‡ä»¶
docker run -d --name redis-server \
  -p 6379:6379 \
  -v /path/to/redis.conf:/usr/local/etc/redis/redis.conf \
  redis:7-alpine redis-server /usr/local/etc/redis/redis.conf

# æŒä¹…åŒ–æ•°æ®
docker run -d --name redis-server \
  -p 6379:6379 \
  -v redis-data:/data \
  redis:7-alpine redis-server --appendonly yes
```

## âš™ï¸ åŸºç¡€é…ç½®

### 1. Redisé…ç½®æ–‡ä»¶

```bash
# ç¼–è¾‘Redisé…ç½®æ–‡ä»¶
sudo nano /etc/redis/redis.conf
```

### 2. ç½‘ç»œé…ç½®

```conf
# redis.conf ç½‘ç»œç›¸å…³é…ç½®

# ç»‘å®šåœ°å€
bind 127.0.0.1               # ä»…æœ¬åœ°è®¿é—®
# bind 127.0.0.1 10.0.0.1    # å¤šç½‘å¡ç»‘å®š
# bind 0.0.0.0               # æ‰€æœ‰åœ°å€ï¼ˆä¸å®‰å…¨ï¼Œä»…æµ‹è¯•ç¯å¢ƒï¼‰

# ç«¯å£é…ç½®
port 6379                    # é»˜è®¤ç«¯å£

# ä¿æŠ¤æ¨¡å¼
protected-mode yes           # å¯ç”¨ä¿æŠ¤æ¨¡å¼

# TCPè¿æ¥é…ç½®
tcp-backlog 511              # TCPè¿æ¥é˜Ÿåˆ—é•¿åº¦
tcp-keepalive 300            # TCP Keep-Aliveæ—¶é—´

# è¶…æ—¶é…ç½®
timeout 300                  # å®¢æˆ·ç«¯ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
```

### 3. å®‰å…¨é…ç½®

```conf
# å¯†ç è®¤è¯
requirepass mes_redis_secure_password

# é‡å‘½åå±é™©å‘½ä»¤
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_MES_2024"
rename-command SHUTDOWN "SHUTDOWN_MES_2024"
rename-command DEBUG ""
rename-command EVAL ""

# ç”¨æˆ·ACLé…ç½®ï¼ˆRedis 6.0+ï¼‰
# user mes_app on >mes_app_password ~* &* -@dangerous +@all
# user mes_readonly on >readonly_password ~* +@read -@write -@dangerous
```

### 4. å†…å­˜é…ç½®

```conf
# æœ€å¤§å†…å­˜é™åˆ¶
maxmemory 2gb                # è®¾ç½®æœ€å¤§å†…å­˜ä½¿ç”¨é‡

# å†…å­˜æ·˜æ±°ç­–ç•¥
maxmemory-policy allkeys-lru # LRUæ·˜æ±°ç­–ç•¥
# å¯é€‰ç­–ç•¥ï¼š
# volatile-lru     # å¯¹è®¾ç½®äº†TTLçš„keyä½¿ç”¨LRU
# allkeys-lru      # å¯¹æ‰€æœ‰keyä½¿ç”¨LRU
# volatile-lfu     # å¯¹è®¾ç½®äº†TTLçš„keyä½¿ç”¨LFU
# allkeys-lfu      # å¯¹æ‰€æœ‰keyä½¿ç”¨LFU
# volatile-random  # éšæœºåˆ é™¤è®¾ç½®äº†TTLçš„key
# allkeys-random   # éšæœºåˆ é™¤æ‰€æœ‰key
# volatile-ttl     # åˆ é™¤æœ€æ¥è¿‘è¿‡æœŸçš„key
# noeviction       # ä¸åˆ é™¤ï¼Œè¿”å›é”™è¯¯

# å†…å­˜é‡‡æ ·ç²¾åº¦
maxmemory-samples 5          # é‡‡æ ·æ•°é‡ï¼Œè¶Šå¤§è¶Šç²¾ç¡®ä½†æ¶ˆè€—æ›´å¤šCPU
```

### 5. æŒä¹…åŒ–é…ç½®

```conf
# RDBå¿«ç…§é…ç½®
save 900 1                   # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 300 10                  # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 60 10000                # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜

# RDBæ–‡ä»¶é…ç½®
dbfilename dump.rdb          # RDBæ–‡ä»¶å
dir /var/lib/redis           # æ•°æ®æ–‡ä»¶ç›®å½•
rdbcompression yes           # å¯ç”¨RDBå‹ç¼©
rdbchecksum yes              # å¯ç”¨RDBæ ¡éªŒå’Œ

# AOFæŒä¹…åŒ–é…ç½®
appendonly yes               # å¯ç”¨AOFæŒä¹…åŒ–
appendfilename "appendonly.aof"  # AOFæ–‡ä»¶å
appendfsync everysec         # AOFåˆ·ç›˜ç­–ç•¥
# appendfsync always         # æ¯æ¬¡å†™å…¥éƒ½åˆ·ç›˜ï¼ˆæœ€å®‰å…¨ï¼Œæ€§èƒ½æœ€ä½ï¼‰
# appendfsync no             # ç”±OSå†³å®šä½•æ—¶åˆ·ç›˜ï¼ˆæ€§èƒ½æœ€é«˜ï¼Œå®‰å…¨æ€§æœ€ä½ï¼‰

# AOFé‡å†™é…ç½®
auto-aof-rewrite-percentage 100  # AOFæ–‡ä»¶å¢é•¿100%æ—¶è§¦å‘é‡å†™
auto-aof-rewrite-min-size 64mb   # AOFæ–‡ä»¶æœ€å°64MBæ—¶æ‰è€ƒè™‘é‡å†™
aof-load-truncated yes           # å¯åŠ¨æ—¶åŠ è½½è¢«æˆªæ–­çš„AOFæ–‡ä»¶
```

### 6. æ—¥å¿—é…ç½®

```conf
# æ—¥å¿—çº§åˆ«
loglevel notice              # debug, verbose, notice, warning

# æ—¥å¿—æ–‡ä»¶
logfile /var/log/redis/redis-server.log

# ç³»ç»Ÿæ—¥å¿—
syslog-enabled yes           # å¯ç”¨ç³»ç»Ÿæ—¥å¿—
syslog-ident redis          # ç³»ç»Ÿæ—¥å¿—æ ‡è¯†ç¬¦
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®

### 1. CPUå’Œçº¿ç¨‹é…ç½®

```conf
# I/Oçº¿ç¨‹é…ç½®ï¼ˆRedis 6.0+ï¼‰
io-threads 4                 # I/Oçº¿ç¨‹æ•°é‡ï¼ˆå»ºè®®ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰
io-threads-do-reads yes      # å¯ç”¨è¯»æ“ä½œå¤šçº¿ç¨‹

# äº‹ä»¶å¾ªç¯é…ç½®
hz 10                        # åå°ä»»åŠ¡æ‰§è¡Œé¢‘ç‡ï¼ˆ1-500ï¼‰

# å»¶è¿Ÿç›‘æ§
latency-monitor-threshold 100 # ç›‘æ§è¶…è¿‡100æ¯«ç§’çš„æ“ä½œ
```

### 2. å†…å­˜ä¼˜åŒ–

```conf
# å“ˆå¸Œè¡¨ä¼˜åŒ–
hash-max-ziplist-entries 512  # å“ˆå¸Œå‹ç¼©åˆ—è¡¨æœ€å¤§æ¡ç›®æ•°
hash-max-ziplist-value 64     # å“ˆå¸Œå‹ç¼©åˆ—è¡¨æœ€å¤§å€¼å¤§å°

# åˆ—è¡¨ä¼˜åŒ–
list-max-ziplist-size -2      # åˆ—è¡¨å‹ç¼©é…ç½®
list-compress-depth 0         # åˆ—è¡¨å‹ç¼©æ·±åº¦

# é›†åˆä¼˜åŒ–
set-max-intset-entries 512    # æ•´æ•°é›†åˆæœ€å¤§æ¡ç›®æ•°

# æœ‰åºé›†åˆä¼˜åŒ–
zset-max-ziplist-entries 128  # æœ‰åºé›†åˆå‹ç¼©åˆ—è¡¨æœ€å¤§æ¡ç›®æ•°
zset-max-ziplist-value 64     # æœ‰åºé›†åˆå‹ç¼©åˆ—è¡¨æœ€å¤§å€¼å¤§å°

# HyperLogLogä¼˜åŒ–
hll-sparse-max-bytes 3000     # HyperLogLogç¨€ç–è¡¨ç¤ºæœ€å¤§å­—èŠ‚æ•°
```

### 3. ç½‘ç»œä¼˜åŒ–

```conf
# TCPé…ç½®ä¼˜åŒ–
tcp-backlog 511              # TCPç›‘å¬é˜Ÿåˆ—é•¿åº¦
tcp-keepalive 300            # TCPä¿æ´»æ—¶é—´

# å®¢æˆ·ç«¯è¿æ¥ä¼˜åŒ–
maxclients 10000             # æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°
timeout 300                  # å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´

# æ…¢æ—¥å¿—é…ç½®
slowlog-log-slower-than 10000  # è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡10msçš„å‘½ä»¤
slowlog-max-len 128             # æ…¢æ—¥å¿—æœ€å¤§é•¿åº¦
```

## ğŸ—ï¸ é«˜å¯ç”¨é…ç½®

### 1. ä¸»ä»å¤åˆ¶é…ç½®

#### ä¸»æœåŠ¡å™¨é…ç½®

```conf
# redis-master.conf

# åŸºç¡€é…ç½®
port 6379
bind 0.0.0.0
requirepass master_password

# å¤åˆ¶é…ç½®
replica-serve-stale-data yes    # ä»æœåŠ¡å™¨åœ¨åŒæ­¥æœŸé—´å¯ä»¥å“åº”è¯»è¯·æ±‚
replica-read-only yes           # ä»æœåŠ¡å™¨åªè¯»æ¨¡å¼

# å¤åˆ¶å®‰å…¨é…ç½®
masterauth master_password      # ä¸»æœåŠ¡å™¨å¯†ç ï¼ˆå¦‚æœä¸»æœåŠ¡å™¨æœ‰å¯†ç ï¼‰
replica-priority 100            # å¤åˆ¶ä¼˜å…ˆçº§

# å¤åˆ¶è¶…æ—¶é…ç½®
repl-timeout 60                 # å¤åˆ¶è¶…æ—¶æ—¶é—´
repl-ping-replica-period 10     # ä¸»ä»å¿ƒè·³é—´éš”
repl-backlog-size 1mb           # å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°
repl-backlog-ttl 3600           # å¤åˆ¶ç§¯å‹ç¼“å†²åŒºTTL
```

#### ä»æœåŠ¡å™¨é…ç½®

```conf
# redis-replica.conf

# åŸºç¡€é…ç½®
port 6380
bind 0.0.0.0
requirepass replica_password

# å¤åˆ¶é…ç½®
replicaof 192.168.1.100 6379    # ä¸»æœåŠ¡å™¨åœ°å€å’Œç«¯å£
masterauth master_password      # ä¸»æœåŠ¡å™¨å¯†ç 

# ä»æœåŠ¡å™¨ç‰¹å®šé…ç½®
replica-serve-stale-data yes    # åœ¨åŒæ­¥æœŸé—´æä¾›æ—§æ•°æ®
replica-read-only yes           # åªè¯»æ¨¡å¼
replica-priority 90             # å¤åˆ¶ä¼˜å…ˆçº§
```

### 2. Redis Sentinelé…ç½®

#### Sentinelé…ç½®æ–‡ä»¶

```conf
# sentinel.conf

# åŸºç¡€é…ç½®
port 26379
bind 0.0.0.0

# ç›‘æ§ä¸»æœåŠ¡å™¨
sentinel monitor mymaster 192.168.1.100 6379 2

# è®¤è¯é…ç½®
sentinel auth-pass mymaster master_password

# æ•…éšœè½¬ç§»é…ç½®
sentinel down-after-milliseconds mymaster 30000    # åˆ¤æ–­ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶é—´
sentinel parallel-syncs mymaster 1                 # åŒæ—¶åŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡
sentinel failover-timeout mymaster 180000          # æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´

# é€šçŸ¥è„šæœ¬
sentinel notification-script mymaster /etc/redis/notify.sh
sentinel client-reconfig-script mymaster /etc/redis/reconfig.sh

# å…¶ä»–é…ç½®
sentinel deny-scripts-reconfig yes                 # ç¦æ­¢åœ¨è¿è¡Œæ—¶é‡æ–°é…ç½®è„šæœ¬
```

#### å¯åŠ¨SentinelæœåŠ¡

```bash
# åˆ›å»ºSentinelæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/redis-sentinel.service << 'EOF'
[Unit]
Description=Redis Sentinel
After=network.target

[Service]
Type=notify
ExecStart=/usr/bin/redis-sentinel /etc/redis/sentinel.conf --supervised systemd
ExecStop=/bin/kill -s QUIT $MAINPID
TimeoutStopSec=0
Restart=always
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl start redis-sentinel
sudo systemctl enable redis-sentinel
```

### 3. Redis Clusteré›†ç¾¤é…ç½®

#### é›†ç¾¤èŠ‚ç‚¹é…ç½®

```conf
# redis-cluster.conf

# åŸºç¡€é…ç½®
port 7000
bind 0.0.0.0
requirepass cluster_password

# é›†ç¾¤é…ç½®
cluster-enabled yes                     # å¯ç”¨é›†ç¾¤æ¨¡å¼
cluster-config-file nodes-7000.conf    # é›†ç¾¤é…ç½®æ–‡ä»¶
cluster-node-timeout 15000             # èŠ‚ç‚¹è¶…æ—¶æ—¶é—´
cluster-replica-validity-factor 10     # ä»èŠ‚ç‚¹æœ‰æ•ˆæ€§å› å­

# é›†ç¾¤æ•…éšœè½¬ç§»é…ç½®
cluster-migration-barrier 1            # è¿ç§»å±éšœ
cluster-require-full-coverage no       # ä¸è¦æ±‚å®Œæ•´è¦†ç›–

# å…¶ä»–é›†ç¾¤é…ç½®
cluster-replica-no-failover no         # å…è®¸ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»
```

#### åˆ›å»ºé›†ç¾¤è„šæœ¬

```bash
# åˆ›å»º6èŠ‚ç‚¹é›†ç¾¤ï¼ˆ3ä¸»3ä»ï¼‰
cat > create-cluster.sh << 'EOF'
#!/bin/bash

# å¯åŠ¨6ä¸ªRediså®ä¾‹
for port in 7000 7001 7002 7003 7004 7005; do
    redis-server /etc/redis/redis-cluster-${port}.conf --daemonize yes
done

# ç­‰å¾…å®ä¾‹å¯åŠ¨
sleep 5

# åˆ›å»ºé›†ç¾¤
redis-cli --cluster create \
    127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
    127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 \
    --cluster-replicas 1 \
    --cluster-yes
EOF

chmod +x create-cluster.sh
./create-cluster.sh
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰

```bash
# Redis 6.0+ ACLé…ç½®

# è¿æ¥åˆ°Redis
redis-cli -a mes_redis_secure_password

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
127.0.0.1:6379> ACL SETUSER mes_app on >mes_app_password ~mes:* +@all -@dangerous

# åˆ›å»ºåªè¯»ç”¨æˆ·
127.0.0.1:6379> ACL SETUSER mes_readonly on >readonly_password ~mes:* +@read -@write -@dangerous

# åˆ›å»ºç›‘æ§ç”¨æˆ·
127.0.0.1:6379> ACL SETUSER mes_monitor on >monitor_password ~* +ping +info +client +config|get

# æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
127.0.0.1:6379> ACL LIST

# ä¿å­˜ACLé…ç½®
127.0.0.1:6379> ACL SAVE
```

### 2. ç½‘ç»œå®‰å…¨

```bash
# é˜²ç«å¢™é…ç½®
sudo ufw allow from 192.168.1.0/24 to any port 6379
sudo ufw deny 6379

# æˆ–ä½¿ç”¨iptables
sudo iptables -A INPUT -p tcp --dport 6379 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 6379 -j DROP
```

### 3. TLS/SSLé…ç½®

```conf
# redis.conf TLSé…ç½®

# å¯ç”¨TLS
tls-port 6380
port 0                          # ç¦ç”¨éåŠ å¯†ç«¯å£

# è¯ä¹¦é…ç½®
tls-cert-file /etc/redis/tls/redis.crt
tls-key-file /etc/redis/tls/redis.key
tls-ca-cert-file /etc/redis/tls/ca.crt

# TLSåè®®é…ç½®
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256"
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256"

# å®¢æˆ·ç«¯è®¤è¯
tls-auth-clients yes
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§å‘½ä»¤

```bash
# è¿æ¥Redis
redis-cli -a mes_redis_secure_password

# æŸ¥çœ‹æœåŠ¡å™¨ä¿¡æ¯
127.0.0.1:6379> INFO server
127.0.0.1:6379> INFO memory
127.0.0.1:6379> INFO stats
127.0.0.1:6379> INFO replication
127.0.0.1:6379> INFO persistence

# æŸ¥çœ‹å®¢æˆ·ç«¯è¿æ¥
127.0.0.1:6379> CLIENT LIST

# æŸ¥çœ‹æ…¢æ—¥å¿—
127.0.0.1:6379> SLOWLOG GET 10

# æŸ¥çœ‹å»¶è¿Ÿä¿¡æ¯
127.0.0.1:6379> LATENCY LATEST

# å†…å­˜ä½¿ç”¨åˆ†æ
127.0.0.1:6379> MEMORY STATS
127.0.0.1:6379> MEMORY USAGE keyname
```

### 2. ç›‘æ§è„šæœ¬

```bash
# åˆ›å»ºRedisç›‘æ§è„šæœ¬
cat > /usr/local/bin/redis_monitor.sh << 'EOF'
#!/bin/bash

REDIS_CLI="redis-cli -a mes_redis_secure_password"
LOG_FILE="/var/log/redis/monitor.log"

echo "$(date): Redisç›‘æ§å¼€å§‹" >> $LOG_FILE

# æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
if ! $REDIS_CLI ping > /dev/null 2>&1; then
    echo "$(date): RedisæœåŠ¡ä¸å¯ç”¨" >> $LOG_FILE
    exit 1
fi

# è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
MEMORY_USED=$($REDIS_CLI INFO memory | grep used_memory_human | cut -d: -f2 | tr -d '\r')
MEMORY_MAX=$($REDIS_CLI CONFIG GET maxmemory | tail -1)

echo "$(date): å†…å­˜ä½¿ç”¨: $MEMORY_USED / $(($MEMORY_MAX/1024/1024))MB" >> $LOG_FILE

# è·å–è¿æ¥æ•°
CONNECTED_CLIENTS=$($REDIS_CLI INFO clients | grep connected_clients | cut -d: -f2 | tr -d '\r')
echo "$(date): è¿æ¥æ•°: $CONNECTED_CLIENTS" >> $LOG_FILE

# è·å–æ“ä½œç»Ÿè®¡
OPS_PER_SEC=$($REDIS_CLI INFO stats | grep instantaneous_ops_per_sec | cut -d: -f2 | tr -d '\r')
echo "$(date): æ¯ç§’æ“ä½œæ•°: $OPS_PER_SEC" >> $LOG_FILE

echo "$(date): Redisç›‘æ§å®Œæˆ" >> $LOG_FILE
EOF

chmod +x /usr/local/bin/redis_monitor.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
echo "*/5 * * * * /usr/local/bin/redis_monitor.sh" | sudo crontab -u redis -
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# åˆ›å»ºRediså¤‡ä»½è„šæœ¬
cat > /usr/local/bin/redis_backup.sh << 'EOF'
#!/bin/bash

REDIS_CLI="redis-cli -a mes_redis_secure_password"
BACKUP_DIR="/var/backups/redis"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# RDBå¤‡ä»½
echo "å¼€å§‹RDBå¤‡ä»½..."
$REDIS_CLI BGSAVE
sleep 10

# ç­‰å¾…å¤‡ä»½å®Œæˆ
while [ $($REDIS_CLI LASTSAVE) -eq $($REDIS_CLI LASTSAVE) ]; do
    sleep 1
done

# å¤åˆ¶RDBæ–‡ä»¶
cp /var/lib/redis/dump.rdb "$BACKUP_DIR/dump_$DATE.rdb"

# å¦‚æœå¯ç”¨äº†AOFï¼Œä¹Ÿå¤‡ä»½AOFæ–‡ä»¶
if [ -f /var/lib/redis/appendonly.aof ]; then
    cp /var/lib/redis/appendonly.aof "$BACKUP_DIR/appendonly_$DATE.aof"
fi

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip "$BACKUP_DIR/dump_$DATE.rdb"
if [ -f "$BACKUP_DIR/appendonly_$DATE.aof" ]; then
    gzip "$BACKUP_DIR/appendonly_$DATE.aof"
fi

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "$(date): Rediså¤‡ä»½å®Œæˆ"
EOF

chmod +x /usr/local/bin/redis_backup.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼‰
echo "0 3 * * * /usr/local/bin/redis_backup.sh >> /var/log/redis/backup.log 2>&1" | sudo crontab -u redis -
```

## ğŸ”§ Laravelé›†æˆé…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®

```env
# .envæ–‡ä»¶Redisé…ç½®

# åŸºç¡€Redisé…ç½®
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=mes_redis_secure_password
REDIS_PORT=6379
REDIS_DB=0

# Redisé›†ç¾¤é…ç½®ï¼ˆå¦‚æœä½¿ç”¨é›†ç¾¤ï¼‰
REDIS_CLUSTER=true
REDIS_CLUSTER_NODES="127.0.0.1:7000,127.0.0.1:7001,127.0.0.1:7002"

# ç¼“å­˜é…ç½®
CACHE_DRIVER=redis
CACHE_PREFIX=mes_cache_

# ä¼šè¯é…ç½®
SESSION_DRIVER=redis
SESSION_LIFETIME=120
SESSION_CONNECTION=session

# é˜Ÿåˆ—é…ç½®
QUEUE_CONNECTION=redis
REDIS_QUEUE=default

# å¹¿æ’­é…ç½®
BROADCAST_DRIVER=redis
```

### 2. Laravel Redisé…ç½®

```php
// config/database.php
'redis' => [
    'client' => env('REDIS_CLIENT', 'phpredis'),

    'options' => [
        'cluster' => env('REDIS_CLUSTER', false),
        'prefix' => env('REDIS_PREFIX', Str::slug(env('APP_NAME', 'laravel'), '_').'_database_'),
    ],

    'default' => [
        'url' => env('REDIS_URL'),
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'password' => env('REDIS_PASSWORD'),
        'port' => env('REDIS_PORT', '6379'),
        'database' => env('REDIS_DB', '0'),
        'read_timeout' => 60,
        'context' => [
            // 'auth' => ['username', 'secret'],
            // 'stream' => ['verify_peer' => false],
        ],
    ],

    'cache' => [
        'url' => env('REDIS_URL'),
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'password' => env('REDIS_PASSWORD'),
        'port' => env('REDIS_PORT', '6379'),
        'database' => env('REDIS_CACHE_DB', '1'),
    ],

    'session' => [
        'url' => env('REDIS_URL'),
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'password' => env('REDIS_PASSWORD'),
        'port' => env('REDIS_PORT', '6379'),
        'database' => env('REDIS_SESSION_DB', '2'),
    ],

    'queue' => [
        'url' => env('REDIS_URL'),
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'password' => env('REDIS_PASSWORD'),
        'port' => env('REDIS_PORT', '6379'),
        'database' => env('REDIS_QUEUE_DB', '3'),
    ],
],

// Redisé›†ç¾¤é…ç½®
'redis_cluster' => [
    'client' => env('REDIS_CLIENT', 'phpredis'),
    'options' => [
        'cluster' => 'redis',
    ],
    'clusters' => [
        'default' => [
            [
                'host' => env('REDIS_HOST', '127.0.0.1'),
                'password' => env('REDIS_PASSWORD'),
                'port' => env('REDIS_PORT', '7000'),
                'database' => 0,
            ],
            [
                'host' => env('REDIS_HOST', '127.0.0.1'),
                'password' => env('REDIS_PASSWORD'),
                'port' => env('REDIS_PORT', '7001'),
                'database' => 0,
            ],
            [
                'host' => env('REDIS_HOST', '127.0.0.1'),
                'password' => env('REDIS_PASSWORD'),
                'port' => env('REDIS_PORT', '7002'),
                'database' => 0,
            ],
        ],
    ],
],
```

### 3. ç¼“å­˜é…ç½®

```php
// config/cache.php
'stores' => [
    'redis' => [
        'driver' => 'redis',
        'connection' => 'cache',
        'lock_connection' => 'default',
    ],
    
    'redis_cluster' => [
        'driver' => 'redis',
        'connection' => 'cluster',
    ],
],
```

### 4. æµ‹è¯•Redisè¿æ¥

```bash
# Laravel Artisanå‘½ä»¤æµ‹è¯•
php artisan tinker

# æµ‹è¯•Redisè¿æ¥
>>> Illuminate\Support\Facades\Redis::connection()->ping();
=> "+PONG"

# æµ‹è¯•ç¼“å­˜
>>> Cache::put('test_key', 'test_value', 60);
=> true
>>> Cache::get('test_key');
=> "test_value"

# æµ‹è¯•ä¼šè¯
>>> session(['test_session' => 'session_value']);
>>> session('test_session');
=> "session_value"
```

## ğŸš¨ æ•…éšœæ’é™¤

### 1. å¸¸è§è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
sudo systemctl status redis-server

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 6379

# æ£€æŸ¥Redisæ—¥å¿—
sudo tail -f /var/log/redis/redis-server.log

# æµ‹è¯•æœ¬åœ°è¿æ¥
redis-cli ping

# æµ‹è¯•å¸¦å¯†ç è¿æ¥
redis-cli -a mes_redis_secure_password ping

# æ£€æŸ¥é…ç½®
redis-cli -a mes_redis_secure_password CONFIG GET "*"
```

### 2. å†…å­˜é—®é¢˜

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
redis-cli -a mes_redis_secure_password INFO memory

# æŸ¥çœ‹å¤§key
redis-cli -a mes_redis_secure_password --bigkeys

# å†…å­˜ä½¿ç”¨åˆ†æ
redis-cli -a mes_redis_secure_password MEMORY DOCTOR

# æ‰‹åŠ¨è§¦å‘å†…å­˜å›æ”¶
redis-cli -a mes_redis_secure_password MEMORY PURGE
```

### 3. æ€§èƒ½é—®é¢˜

```bash
# æŸ¥çœ‹æ…¢æŸ¥è¯¢
redis-cli -a mes_redis_secure_password SLOWLOG GET 20

# å®æ—¶ç›‘æ§å‘½ä»¤
redis-cli -a mes_redis_secure_password MONITOR

# æŸ¥çœ‹å»¶è¿Ÿ
redis-cli -a mes_redis_secure_password --latency
redis-cli -a mes_redis_secure_password --latency-history

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
redis-cli -a mes_redis_secure_password INFO stats
```

### 4. é›†ç¾¤é—®é¢˜

```bash
# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
redis-cli -c -h 127.0.0.1 -p 7000 -a cluster_password CLUSTER INFO

# æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹
redis-cli -c -h 127.0.0.1 -p 7000 -a cluster_password CLUSTER NODES

# ä¿®å¤é›†ç¾¤
redis-cli --cluster fix 127.0.0.1:7000 -a cluster_password

# æ£€æŸ¥é›†ç¾¤
redis-cli --cluster check 127.0.0.1:7000 -a cluster_password
```

### 5. æ•°æ®æ¢å¤

```bash
# ä»RDBæ–‡ä»¶æ¢å¤
sudo systemctl stop redis-server
sudo cp /var/backups/redis/dump_20231201_030000.rdb.gz /tmp/
gunzip /tmp/dump_20231201_030000.rdb.gz
sudo mv /tmp/dump_20231201_030000.rdb /var/lib/redis/dump.rdb
sudo chown redis:redis /var/lib/redis/dump.rdb
sudo systemctl start redis-server

# ä»AOFæ–‡ä»¶æ¢å¤
sudo systemctl stop redis-server
sudo cp /var/backups/redis/appendonly_20231201_030000.aof.gz /tmp/
gunzip /tmp/appendonly_20231201_030000.aof.gz
sudo mv /tmp/appendonly_20231201_030000.aof /var/lib/redis/appendonly.aof
sudo chown redis:redis /var/lib/redis/appendonly.aof
sudo systemctl start redis-server
```

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜å»ºè®®

### 1. ç³»ç»Ÿçº§ä¼˜åŒ–

```bash
# å†…æ ¸å‚æ•°ä¼˜åŒ–
echo 'vm.overcommit_memory = 1' >> /etc/sysctl.conf
echo 'net.core.somaxconn = 65535' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 65535' >> /etc/sysctl.conf

# åº”ç”¨å‚æ•°
sysctl -p

# ç¦ç”¨é€æ˜å¤§é¡µ
echo 'never' > /sys/kernel/mm/transparent_hugepage/enabled
echo 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' >> /etc/rc.local
```

### 2. Redisé…ç½®ä¼˜åŒ–

```conf
# é’ˆå¯¹é«˜å¹¶å‘åœºæ™¯çš„ä¼˜åŒ–é…ç½®
maxclients 20000
tcp-backlog 511
tcp-keepalive 300
timeout 0

# å†…å­˜ä¼˜åŒ–
maxmemory-policy allkeys-lru
maxmemory-samples 10

# I/Oä¼˜åŒ–ï¼ˆRedis 6.0+ï¼‰
io-threads 4
io-threads-do-reads yes

# æŒä¹…åŒ–ä¼˜åŒ–
save 900 1
save 300 10
save 60 10000
appendfsync everysec
no-appendfsync-on-rewrite yes
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

---

**ğŸ“‹ ä¸‹ä¸€æ­¥**ï¼šRedisé…ç½®å®Œæˆåï¼Œå‚è€ƒ [7. é˜Ÿåˆ—é…ç½®.md](./7.%20é˜Ÿåˆ—é…ç½®.md) é…ç½®é˜Ÿåˆ—æœåŠ¡ã€‚ 