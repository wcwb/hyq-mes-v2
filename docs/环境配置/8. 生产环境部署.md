# MESåç«¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†MESåç«¯ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²å’Œé…ç½®è¿‡ç¨‹ã€‚ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦è€ƒè™‘å®‰å…¨æ€§ã€å¯é æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ç­‰å¤šä¸ªæ–¹é¢ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿç¨³å®šè¿è¡Œå¹¶æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1. ç”Ÿäº§ç¯å¢ƒæ¶æ„

```
[Internet] 
    â†“
[Load Balancer / CDN]
    â†“
[Nginx (åå‘ä»£ç†/é™æ€æ–‡ä»¶)]
    â†“
[PHP-FPM (Laravelåº”ç”¨)]
    â†“
[PostgreSQLä¸»ä»é›†ç¾¤] â† â†’ [Redisé›†ç¾¤]
    â†“
[é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹ (Workers)]
    â†“
[ç›‘æ§ç³»ç»Ÿ (Grafana + Prometheus)]
```

### 2. æœåŠ¡å™¨é…ç½®å»ºè®®

| ç»„ä»¶ | æœ€å°é…ç½® | æ¨èé…ç½® | é«˜æ€§èƒ½é…ç½® |
|------|----------|----------|------------|
| **WebæœåŠ¡å™¨** | 2CPU, 4GB RAM | 4CPU, 8GB RAM | 8CPU, 16GB RAM |
| **æ•°æ®åº“** | 2CPU, 8GB RAM | 4CPU, 16GB RAM | 8CPU, 32GB RAM |
| **Redis** | 1CPU, 2GB RAM | 2CPU, 4GB RAM | 4CPU, 8GB RAM |
| **é˜Ÿåˆ—å¤„ç†** | 1CPU, 2GB RAM | 2CPU, 4GB RAM | 4CPU, 8GB RAM |

## ğŸ–¥ï¸ æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1. æ“ä½œç³»ç»Ÿé…ç½®

#### Ubuntu 22.04 LTS (æ¨è)

```bash
# ç³»ç»Ÿæ›´æ–°
sudo apt update && sudo apt upgrade -y

# è®¾ç½®æ—¶åŒº
sudo timedatectl set-timezone Asia/Shanghai

# é…ç½®é˜²ç«å¢™
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443

# é…ç½®ä¸»æœºå
sudo hostnamectl set-hostname mes-backend-prod
```

#### CentOS 9 Stream

```bash
# ç³»ç»Ÿæ›´æ–°
sudo dnf update -y

# è®¾ç½®æ—¶åŒº
sudo timedatectl set-timezone Asia/Shanghai

# é…ç½®é˜²ç«å¢™
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# é…ç½®SELinux (å¯é€‰ï¼Œå»ºè®®ä¿æŒå¯ç”¨)
sudo setsebool -P httpd_can_network_connect 1
sudo setsebool -P httpd_execmem 1
```

### 2. å¿…è¦è½¯ä»¶å®‰è£…

#### PHP 8.2+ å®‰è£…

```bash
# Ubuntu
sudo apt install software-properties-common
sudo add-apt-repository ppa:ondrej/php
sudo apt update
sudo apt install php8.2-fpm php8.2-cli php8.2-common \
    php8.2-curl php8.2-zip php8.2-gd php8.2-mbstring \
    php8.2-xml php8.2-pgsql php8.2-redis php8.2-bcmath \
    php8.2-intl php8.2-opcache php8.2-apcu

# CentOS (ä½¿ç”¨Remiä»“åº“)
sudo dnf install epel-release
sudo dnf install https://rpms.remirepo.net/enterprise/remi-release-9.rpm
sudo dnf module enable php:remi-8.2
sudo dnf install php php-fpm php-cli php-common \
    php-curl php-zip php-gd php-mbstring \
    php-xml php-pgsql php-redis php-bcmath \
    php-intl php-opcache php-apcu
```

#### Nginx å®‰è£…

```bash
# Ubuntu
sudo apt install nginx

# CentOS
sudo dnf install nginx

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨
sudo systemctl enable nginx
sudo systemctl start nginx
```

#### Composer å®‰è£…

```bash
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
```

### 3. ç”¨æˆ·å’Œæƒé™é…ç½®

```bash
# åˆ›å»ºåº”ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash mes
sudo usermod -a -G www-data mes

# åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www/mes-backend
sudo chown mes:www-data /var/www/mes-backend
sudo chmod 755 /var/www/mes-backend
```

## ğŸ“¦ ä»£ç éƒ¨ç½²

### 1. Gitä»“åº“é…ç½®

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - mes

# å…‹éš†ä»£ç ä»“åº“
cd /var/www
git clone https://github.com/your-org/mes-backend.git
cd mes-backend

# é…ç½®Git (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨éƒ¨ç½²å¯†é’¥)
git config user.name "MES Production"
git config user.email "ops@yourcompany.com"
```

### 2. ä¾èµ–å®‰è£…

```bash
# å®‰è£…Composerä¾èµ– (ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–)
composer install --no-dev --optimize-autoloader --no-interaction

# ç”Ÿæˆåº”ç”¨å¯†é’¥
php artisan key:generate --force

# åˆ›å»ºç¬¦å·é“¾æ¥ (å¦‚æœä½¿ç”¨æœ¬åœ°å­˜å‚¨)
php artisan storage:link
```

### 3. ç¯å¢ƒé…ç½®

#### åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env.example .env.production
```

#### `.env.production` é…ç½®ç¤ºä¾‹

```env
# åŸºç¡€é…ç½®
APP_NAME="MESåç«¯ç³»ç»Ÿ"
APP_ENV=production
APP_KEY=base64:your-generated-key-here
APP_DEBUG=false
APP_URL=https://mes-api.yourcompany.com
APP_TIMEZONE=Asia/Shanghai

# æ•°æ®åº“é…ç½® (PostgreSQL)
DB_CONNECTION=pgsql
DB_HOST=10.0.1.100  # å†…ç½‘IP
DB_PORT=5432
DB_DATABASE=mes_production
DB_USERNAME=mes_user
DB_PASSWORD=secure-random-password

# Redisé…ç½®
REDIS_HOST=10.0.1.101
REDIS_PASSWORD=redis-secure-password
REDIS_PORT=6379
REDIS_DB=0
REDIS_CACHE_DB=1
REDIS_SESSION_DB=2
REDIS_QUEUE_DB=3

# é˜Ÿåˆ—é…ç½®
QUEUE_CONNECTION=redis
REDIS_QUEUE=mes_jobs_default
REDIS_RETRY_AFTER=90

# é‚®ä»¶é…ç½®
MAIL_MAILER=smtp
MAIL_HOST=smtp.yourcompany.com
MAIL_PORT=587
MAIL_USERNAME=noreply@yourcompany.com
MAIL_PASSWORD=mail-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourcompany.com
MAIL_FROM_NAME="MESç³»ç»Ÿ"

# æ—¥å¿—é…ç½®
LOG_CHANNEL=daily
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=info

# ä¼šè¯é…ç½®
SESSION_DRIVER=redis
SESSION_LIFETIME=120
SESSION_ENCRYPT=true
SESSION_PATH=/
SESSION_DOMAIN=.yourcompany.com

# ç¼“å­˜é…ç½®
CACHE_DRIVER=redis
BROADCAST_DRIVER=redis

# æ–‡ä»¶å­˜å‚¨é…ç½®
FILESYSTEM_DISK=s3  # æˆ–local
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_DEFAULT_REGION=cn-north-1
AWS_BUCKET=mes-storage
AWS_URL=https://mes-storage.s3.cn-north-1.amazonaws.com.cn

# APIé™æµé…ç½®
RATE_LIMIT_PER_MINUTE=60

# ç›‘æ§é…ç½®
TELESCOPE_ENABLED=false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­æˆ–é™åˆ¶è®¿é—®

# å®‰å…¨é…ç½®
SANCTUM_STATEFUL_DOMAINS=mes.yourcompany.com,localhost,127.0.0.1
CSRF_COOKIE_NAME=XSRF-TOKEN
CSRF_HEADER_NAME=X-XSRF-TOKEN
```

### 4. æƒé™é…ç½®

```bash
# è®¾ç½®ç›®å½•æƒé™
sudo chown -R mes:www-data /var/www/mes-backend
sudo find /var/www/mes-backend -type f -exec chmod 644 {} \;
sudo find /var/www/mes-backend -type d -exec chmod 755 {} \;

# è®¾ç½®å­˜å‚¨ç›®å½•æƒé™
sudo chmod -R 775 /var/www/mes-backend/storage
sudo chmod -R 775 /var/www/mes-backend/bootstrap/cache

# è®¾ç½®ç¯å¢ƒæ–‡ä»¶æƒé™
sudo chmod 600 /var/www/mes-backend/.env.production
```

## ğŸ—ƒï¸ æ•°æ®åº“éƒ¨ç½²

### 1. æ•°æ®åº“è¿ç§»

```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
php artisan migrate --env=production --force

# å¡«å……åŸºç¡€æ•°æ® (å¦‚æœæœ‰)
php artisan db:seed --class=ProductionSeeder --env=production --force
```

### 2. æ•°æ®åº“ä¼˜åŒ–

```bash
# ä¼˜åŒ–æ•°æ®åº“è¿æ¥
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

## ğŸŒ WebæœåŠ¡å™¨é…ç½®

### 1. Nginxé…ç½®

#### ä¸»é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/mes-backend`

```nginx
# MESåç«¯ç³»ç»ŸNginxé…ç½®
server {
    listen 80;
    server_name mes-api.yourcompany.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name mes-api.yourcompany.com;
    root /var/www/mes-backend/public;
    index index.php;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/ssl/certs/mes-api.yourcompany.com.crt;
    ssl_certificate_key /etc/ssl/private/mes-api.yourcompany.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # å­—ç¬¦é›†
    charset utf-8;
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/mes-backend-access.log;
    error_log /var/log/nginx/mes-backend-error.log;
    
    # è¯·æ±‚ä½“å¤§å°é™åˆ¶
    client_max_body_size 100M;
    
    # æ–‡ä»¶ä¸Šä¼ é…ç½®
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHPå¤„ç†
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
        
        # PHP-FPMè¶…æ—¶é…ç½®
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_connect_timeout 300;
    }
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # éšè—æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
    }
    
    location ~ ^/(\.env|composer\.(json|lock)|package\.json|\.git) {
        deny all;
        access_log off;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

#### å¯ç”¨ç«™ç‚¹é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/mes-backend /etc/nginx/sites-enabled/

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½Nginx
sudo systemctl reload nginx
```

### 2. PHP-FPMé…ç½®ä¼˜åŒ–

#### `/etc/php/8.2/fpm/pool.d/mes-backend.conf`

```ini
[mes-backend]
user = mes
group = www-data
listen = /var/run/php/mes-backend.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; è¿›ç¨‹ç®¡ç†
pm = dynamic
pm.max_children = 50         ; æœ€å¤§å­è¿›ç¨‹æ•°
pm.start_servers = 5         ; å¯åŠ¨æ—¶çš„è¿›ç¨‹æ•°
pm.min_spare_servers = 5     ; æœ€å°ç©ºé—²è¿›ç¨‹æ•°
pm.max_spare_servers = 10    ; æœ€å¤§ç©ºé—²è¿›ç¨‹æ•°
pm.max_requests = 1000       ; æ¯ä¸ªè¿›ç¨‹å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°

; è¶…æ—¶é…ç½®
request_terminate_timeout = 300
request_slowlog_timeout = 10s
slowlog = /var/log/php/mes-backend-slow.log

; å†…å­˜å’Œæ‰§è¡Œæ—¶é—´é™åˆ¶
php_admin_value[memory_limit] = 512M
php_admin_value[max_execution_time] = 300
php_admin_value[upload_max_filesize] = 100M
php_admin_value[post_max_size] = 100M

; é”™è¯¯æ—¥å¿—
php_admin_value[error_log] = /var/log/php/mes-backend-error.log
php_admin_flag[log_errors] = on

; ä¼šè¯é…ç½®
php_value[session.save_handler] = redis
php_value[session.save_path] = "tcp://10.0.1.101:6379?auth=redis-password&database=2"

; OPcacheé…ç½®
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 32
php_admin_value[opcache.max_accelerated_files] = 10000
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.save_comments] = 0
php_admin_value[opcache.fast_shutdown] = 1
```

## ğŸ” SSLè¯ä¹¦é…ç½®

### 1. Let's Encryptè¯ä¹¦ (æ¨è)

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx  # Ubuntu
sudo dnf install certbot python3-certbot-nginx  # CentOS

# è·å–è¯ä¹¦
sudo certbot --nginx -d mes-api.yourcompany.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer

# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

### 2. å•†ä¸šè¯ä¹¦é…ç½®

```bash
# åˆ›å»ºè¯ä¹¦ç›®å½•
sudo mkdir -p /etc/ssl/certs
sudo mkdir -p /etc/ssl/private

# å¤åˆ¶è¯ä¹¦æ–‡ä»¶
sudo cp mes-api.yourcompany.com.crt /etc/ssl/certs/
sudo cp mes-api.yourcompany.com.key /etc/ssl/private/

# è®¾ç½®æƒé™
sudo chmod 644 /etc/ssl/certs/mes-api.yourcompany.com.crt
sudo chmod 600 /etc/ssl/private/mes-api.yourcompany.com.key
```

## ğŸ”§ é˜Ÿåˆ—å’Œå®šæ—¶ä»»åŠ¡é…ç½®

### 1. Supervisoré…ç½®é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹

#### `/etc/supervisor/conf.d/mes-queue.conf`

```ini
[program:mes-queue]
process_name=%(program_name)s_%(process_num)02d
command=/usr/bin/php /var/www/mes-backend/artisan queue:work redis --sleep=3 --tries=3 --timeout=300 --max-jobs=1000 --max-time=3600
autostart=true
autorestart=true
user=mes
numprocs=4
redirect_stderr=true
stdout_logfile=/var/log/supervisor/mes-queue.log
stdout_logfile_maxbytes=100MB
stdout_logfile_backups=10
stopwaitsecs=3600
killasgroup=true
priority=999
```

#### å¯åŠ¨SupervisoræœåŠ¡

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start mes-queue:*
```

### 2. Cronå®šæ—¶ä»»åŠ¡

```bash
# ä¸ºmesç”¨æˆ·æ·»åŠ å®šæ—¶ä»»åŠ¡
sudo crontab -u mes -e

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
* * * * * cd /var/www/mes-backend && php artisan schedule:run >> /var/log/mes-cron.log 2>&1
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—è½®è½¬é…ç½®

#### `/etc/logrotate.d/mes-backend`

```
/var/log/nginx/mes-backend-*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data adm
    postrotate
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}

/var/www/mes-backend/storage/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 mes www-data
}

/var/log/php/mes-backend-*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 mes www-data
    postrotate
        /usr/lib/php/php8.2-fpm-reopenlogs
    endscript
}
```

### 2. åº”ç”¨ç›‘æ§è„šæœ¬

#### `/usr/local/bin/mes-health-check.sh`

```bash
#!/bin/bash
# MESç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬

LOG_FILE="/var/log/mes-health-check.log"
ALERT_EMAIL="ops@yourcompany.com"

# æ£€æŸ¥WebæœåŠ¡å“åº”
check_web_service() {
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://mes-api.yourcompany.com/health)
    if [ "$HTTP_CODE" != "200" ]; then
        echo "$(date): WebæœåŠ¡æ£€æŸ¥å¤±è´¥ - HTTPçŠ¶æ€ç : $HTTP_CODE" >> $LOG_FILE
        return 1
    fi
    return 0
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database() {
    cd /var/www/mes-backend
    php artisan tinker --execute="DB::connection()->getPdo();" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "$(date): æ•°æ®åº“è¿æ¥æ£€æŸ¥å¤±è´¥" >> $LOG_FILE
        return 1
    fi
    return 0
}

# æ£€æŸ¥Redisè¿æ¥
check_redis() {
    cd /var/www/mes-backend
    php artisan tinker --execute="Redis::ping();" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "$(date): Redisè¿æ¥æ£€æŸ¥å¤±è´¥" >> $LOG_FILE
        return 1
    fi
    return 0
}

# æ£€æŸ¥é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹
check_queue_workers() {
    WORKER_COUNT=$(supervisorctl status mes-queue:* | grep RUNNING | wc -l)
    if [ "$WORKER_COUNT" -eq 0 ]; then
        echo "$(date): é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹æœªè¿è¡Œ" >> $LOG_FILE
        supervisorctl start mes-queue:*
        return 1
    fi
    return 0
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$DISK_USAGE" -gt 85 ]; then
        echo "$(date): ç£ç›˜ç©ºé—´ä¸è¶³ - ä½¿ç”¨ç‡: ${DISK_USAGE}%" >> $LOG_FILE
        return 1
    fi
    return 0
}

# ä¸»æ£€æŸ¥å‡½æ•°
main() {
    ERRORS=0
    
    check_web_service || ((ERRORS++))
    check_database || ((ERRORS++))
    check_redis || ((ERRORS++))
    check_queue_workers || ((ERRORS++))
    check_disk_space || ((ERRORS++))
    
    if [ "$ERRORS" -gt 0 ]; then
        echo "$(date): å¥åº·æ£€æŸ¥å‘ç° $ERRORS ä¸ªé—®é¢˜" >> $LOG_FILE
        # å‘é€å‘Šè­¦é‚®ä»¶ (éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡)
        mail -s "MESç³»ç»Ÿå¥åº·æ£€æŸ¥å‘Šè­¦" $ALERT_EMAIL < $LOG_FILE
        exit 1
    else
        echo "$(date): ç³»ç»Ÿå¥åº·æ£€æŸ¥æ­£å¸¸" >> $LOG_FILE
        exit 0
    fi
}

main
```

#### è®¾ç½®ç›‘æ§å®šæ—¶ä»»åŠ¡

```bash
# è®¾ç½®æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/mes-health-check.sh

# æ·»åŠ åˆ°cron (æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡)
echo "*/5 * * * * /usr/local/bin/mes-health-check.sh" | sudo crontab -
```

## ğŸ”„ å¤‡ä»½ç­–ç•¥

### 1. æ•°æ®åº“å¤‡ä»½è„šæœ¬

#### `/usr/local/bin/mes-backup.sh`

```bash
#!/bin/bash
# MESæ•°æ®åº“å¤‡ä»½è„šæœ¬

BACKUP_DIR="/var/backups/mes"
DB_NAME="mes_production"
DB_USER="mes_user"
DB_HOST="10.0.1.100"
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
BACKUP_FILE="$BACKUP_DIR/mes-db-$(date +%Y%m%d_%H%M%S).sql.gz"

# æ‰§è¡Œå¤‡ä»½
PGPASSWORD=$DB_PASSWORD pg_dump -h $DB_HOST -U $DB_USER -d $DB_NAME | gzip > $BACKUP_FILE

# æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
    echo "$(date): æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
    
    # åˆ é™¤è¶…è¿‡ä¿ç•™æœŸçš„å¤‡ä»½æ–‡ä»¶
    find $BACKUP_DIR -name "mes-db-*.sql.gz" -mtime +$RETENTION_DAYS -delete
    
    # å¯é€‰: ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    # aws s3 cp $BACKUP_FILE s3://your-backup-bucket/database/
else
    echo "$(date): æ•°æ®åº“å¤‡ä»½å¤±è´¥"
    exit 1
fi
```

### 2. æ–‡ä»¶å¤‡ä»½ç­–ç•¥

```bash
# ä½¿ç”¨rsyncè¿›è¡Œæ–‡ä»¶å¤‡ä»½
rsync -av --delete /var/www/mes-backend/storage/app/ /var/backups/mes/storage/

# é…ç½®å®šæ—¶å¤‡ä»½
echo "0 2 * * * /usr/local/bin/mes-backup.sh" | sudo crontab -
echo "0 3 * * * rsync -av --delete /var/www/mes-backend/storage/app/ /var/backups/mes/storage/" | sudo crontab -
```

## ğŸš€ éƒ¨ç½²è‡ªåŠ¨åŒ–

### 1. éƒ¨ç½²è„šæœ¬ç¤ºä¾‹

#### `/usr/local/bin/deploy-mes.sh`

```bash
#!/bin/bash
# MESè‡ªåŠ¨éƒ¨ç½²è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

APP_DIR="/var/www/mes-backend"
BACKUP_DIR="/var/backups/mes/deployments"
USER="mes"

# è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
echo "å¼€å§‹éƒ¨ç½²: $(date)"

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo -u $USER bash << 'EOF'
cd /var/www/mes-backend

# 1. å¤‡ä»½å½“å‰ç‰ˆæœ¬
BACKUP_NAME="deployment-$(date +%Y%m%d_%H%M%S)"
mkdir -p /var/backups/mes/deployments
tar -czf "/var/backups/mes/deployments/$BACKUP_NAME.tar.gz" \
    --exclude=node_modules \
    --exclude=.git \
    --exclude=storage/logs \
    .

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git fetch origin
git reset --hard origin/main

# 3. å®‰è£…/æ›´æ–°ä¾èµ–
composer install --no-dev --optimize-autoloader --no-interaction

# 4. æ¸…é™¤ç¼“å­˜
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# 5. è¿è¡Œæ•°æ®åº“è¿ç§»
php artisan migrate --force

# 6. é‡æ–°ç¼“å­˜é…ç½®
php artisan config:cache
php artisan route:cache
php artisan view:cache

# 7. é‡å¯é˜Ÿåˆ—å·¥ä½œè¿›ç¨‹
php artisan queue:restart
EOF

# 8. é‡æ–°åŠ è½½PHP-FPM
sudo systemctl reload php8.2-fpm

# 9. é‡å¯Supervisorç®¡ç†çš„é˜Ÿåˆ—è¿›ç¨‹
sudo supervisorctl restart mes-queue:*

echo "éƒ¨ç½²å®Œæˆ: $(date)"

# 10. éªŒè¯éƒ¨ç½²
sleep 5
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://mes-api.yourcompany.com/health)
if [ "$HTTP_CODE" = "200" ]; then
    echo "éƒ¨ç½²éªŒè¯æˆåŠŸ"
else
    echo "éƒ¨ç½²éªŒè¯å¤±è´¥ï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
    echo "è¯·æ£€æŸ¥åº”ç”¨çŠ¶æ€"
    exit 1
fi
```

### 2. GitHub Actions CI/CDç¤ºä¾‹

#### `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_pgsql, redis
        
    - name: Install dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction
      
    - name: Run tests
      run: php artisan test
      
    - name: Deploy to production
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          /usr/local/bin/deploy-mes.sh
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. PHPä¼˜åŒ–é…ç½®

#### `/etc/php/8.2/fpm/php.ini`

```ini
; å†…å­˜é…ç½®
memory_limit = 512M
max_execution_time = 300
max_input_time = 300

; æ–‡ä»¶ä¸Šä¼ 
upload_max_filesize = 100M
post_max_size = 100M
max_file_uploads = 20

; OPcacheä¼˜åŒ–
opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=32
opcache.max_accelerated_files=10000
opcache.validate_timestamps=0
opcache.save_comments=0
opcache.fast_shutdown=1
opcache.enable_file_override=1

; APCuç¼“å­˜
apc.enabled=1
apc.shm_size=128M
apc.ttl=3600

; æ—¥æœŸæ—¶åŒº
date.timezone = Asia/Shanghai

; å®æ—¶å‹ç¼©
zlib.output_compression = On
zlib.output_compression_level = 6
```

### 2. æ•°æ®åº“è¿æ¥æ± é…ç½®

#### Laravelä¸­çš„æ•°æ®åº“è¿æ¥ä¼˜åŒ–

```php
// config/database.php
'pgsql' => [
    // ... å…¶ä»–é…ç½®
    'options' => [
        PDO::ATTR_PERSISTENT => true,  // æŒä¹…è¿æ¥
        PDO::ATTR_EMULATE_PREPARES => false,
    ],
    'pool' => [
        'max_connections' => 20,  // æœ€å¤§è¿æ¥æ•°
        'min_connections' => 5,   // æœ€å°è¿æ¥æ•°
    ],
],
```

### 3. Redisä¼˜åŒ–é…ç½®

#### `/etc/redis/redis.conf`

```conf
# å†…å­˜ä¼˜åŒ–
maxmemory 2gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–ä¼˜åŒ–
save 900 1
save 300 10
save 60 10000

# ç½‘ç»œä¼˜åŒ–
tcp-keepalive 300
timeout 0

# å¹¶å‘ä¼˜åŒ–
tcp-backlog 511
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ç³»ç»Ÿå®‰å…¨åŠ å›º

```bash
# 1. æ›´æ–°ç³»ç»ŸåŒ…
sudo apt update && sudo apt upgrade -y

# 2. é…ç½®é˜²ç«å¢™
sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw --force enable

# 3. ç¦ç”¨ä¸å¿…è¦çš„æœåŠ¡
sudo systemctl disable bluetooth
sudo systemctl disable cups
sudo systemctl disable avahi-daemon

# 4. é…ç½®SSHå®‰å…¨
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# 5. è®¾ç½®fail2ban
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 2. åº”ç”¨å®‰å…¨é…ç½®

#### Nginxå®‰å…¨å¤´é…ç½® (å·²åŒ…å«åœ¨ä¸Šé¢çš„é…ç½®ä¸­)

```nginx
# å·²åŒ…å«åœ¨å‰é¢çš„Nginxé…ç½®ä¸­
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

#### Laravelå®‰å…¨é…ç½®

```php
// config/cors.php - CORSé…ç½®
'allowed_origins' => ['https://mes.yourcompany.com'],
'allowed_origins_patterns' => [],
'allowed_headers' => ['*'],
'allowed_methods' => ['*'],
'exposed_headers' => [],
'max_age' => 0,
'supports_credentials' => true,
```

## ğŸš¨ æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜è¯Šæ–­

#### æœåŠ¡çŠ¶æ€æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
sudo systemctl status php8.2-fpm
sudo systemctl status postgresql
sudo systemctl status redis
sudo supervisorctl status

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443
sudo netstat -tlnp | grep :5432
sudo netstat -tlnp | grep :6379

# æ£€æŸ¥æ—¥å¿—
sudo tail -f /var/log/nginx/mes-backend-error.log
sudo tail -f /var/log/php/mes-backend-error.log
sudo tail -f /var/www/mes-backend/storage/logs/laravel.log
sudo tail -f /var/log/supervisor/mes-queue.log
```

#### æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
# æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
htop
iotop
iftop

# æ£€æŸ¥PHPè¿›ç¨‹
sudo ps aux | grep php
sudo ps aux | grep nginx

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
sudo -u postgres psql -c "SELECT * FROM pg_stat_activity;"

# æ£€æŸ¥RedisçŠ¶æ€
redis-cli info
redis-cli monitor
```

### 2. åº”æ€¥æ¢å¤æµç¨‹

#### æ•°æ®åº“æ¢å¤

```bash
# 1. åœæ­¢åº”ç”¨
sudo supervisorctl stop mes-queue:*
sudo systemctl stop nginx

# 2. æ¢å¤æ•°æ®åº“
gunzip < /var/backups/mes/mes-db-YYYYMMDD_HHMMSS.sql.gz | psql -h localhost -U mes_user -d mes_production

# 3. é‡å¯æœåŠ¡
sudo systemctl start nginx
sudo supervisorctl start mes-queue:*
```

#### ä»£ç å›æ»š

```bash
# 1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
cd /var/www/mes-backend
git reset --hard HEAD~1

# 2. é‡æ–°å®‰è£…ä¾èµ–
composer install --no-dev --optimize-autoloader

# 3. æ¸…é™¤å¹¶é‡æ–°ç¼“å­˜
php artisan config:clear
php artisan cache:clear
php artisan config:cache
php artisan route:cache

# 4. é‡å¯æœåŠ¡
sudo systemctl reload php8.2-fpm
php artisan queue:restart
```

### 3. ç›‘æ§å‘Šè­¦é…ç½®

#### ç³»ç»Ÿç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# ç³»ç»Ÿèµ„æºç›‘æ§è„šæœ¬
THRESHOLD_CPU=80
THRESHOLD_MEM=85
THRESHOLD_DISK=85

CPU_USAGE=$(top -bn1 | grep load | awk '{printf "%.2f", $(NF-2)}')
MEM_USAGE=$(free | grep Mem | awk '{printf("%.2f", $3/$2 * 100.0)}')
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')

if (( $(echo "$CPU_USAGE > $THRESHOLD_CPU" | bc -l) )); then
    echo "CPUä½¿ç”¨ç‡è¿‡é«˜: ${CPU_USAGE}%"
fi

if (( $(echo "$MEM_USAGE > $THRESHOLD_MEM" | bc -l) )); then
    echo "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEM_USAGE}%"
fi

if [ "$DISK_USAGE" -gt "$THRESHOLD_DISK" ]; then
    echo "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%"
fi
```

---

**ğŸ“‹ æ€»ç»“**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œéœ€è¦è€ƒè™‘å®‰å…¨æ€§ã€å¯é æ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚å®šæœŸå¤‡ä»½ã€ç›‘æ§å’Œç»´æŠ¤æ˜¯ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œçš„å…³é”®ã€‚å»ºè®®åœ¨éƒ¨ç½²å‰åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†éªŒè¯æ‰€æœ‰é…ç½®å’Œæµç¨‹ã€‚

**ğŸ”„ æŒç»­æ”¹è¿›**ï¼šéšç€ä¸šåŠ¡å‘å±•ï¼Œåº”å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–ç³»ç»Ÿæ¶æ„ã€æ€§èƒ½é…ç½®å’Œå®‰å…¨ç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ»¡è¶³ä¸æ–­å¢é•¿çš„ä¸šåŠ¡éœ€æ±‚ã€‚ 