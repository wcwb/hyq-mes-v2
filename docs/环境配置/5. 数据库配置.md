# MESåç«¯PostgreSQLæ•°æ®åº“é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†MESåç«¯ç³»ç»ŸPostgreSQLæ•°æ®åº“çš„å®‰è£…ã€é…ç½®å’Œä¼˜åŒ–æ–¹æ³•ï¼Œæ¶µç›–å¼€å‘ã€æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®éœ€æ±‚ã€‚

## ğŸ”§ PostgreSQLå®‰è£…

### Ubuntu/Debianç¯å¢ƒ

```bash
# æ·»åŠ PostgreSQLå®˜æ–¹APTä»“åº“
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list

# æ›´æ–°åŒ…åˆ—è¡¨
sudo apt update

# å®‰è£…PostgreSQL 15
sudo apt install -y postgresql-15 postgresql-client-15 postgresql-contrib-15

# å¯åŠ¨å¹¶å¯ç”¨PostgreSQLæœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# éªŒè¯å®‰è£…
sudo -u postgres psql -c "SELECT version();"
```

### CentOS/RHELç¯å¢ƒ

```bash
# å®‰è£…PostgreSQL 15ä»“åº“
sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm

# å®‰è£…PostgreSQL
sudo dnf install -y postgresql15-server postgresql15-contrib

# åˆå§‹åŒ–æ•°æ®åº“
sudo /usr/pgsql-15/bin/postgresql-15-setup initdb

# å¯åŠ¨å¹¶å¯ç”¨æœåŠ¡
sudo systemctl start postgresql-15
sudo systemctl enable postgresql-15
```

### macOSç¯å¢ƒ

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install postgresql@15

# å¯åŠ¨æœåŠ¡
brew services start postgresql@15

# åˆ›å»ºæ•°æ®åº“é›†ç¾¤ï¼ˆå¦‚æœéœ€è¦ï¼‰
initdb /opt/homebrew/var/postgresql@15
```

## âš™ï¸ åŸºç¡€é…ç½®

### 1. è®¾ç½®postgresç”¨æˆ·å¯†ç 

```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

-- åœ¨PostgreSQLå‘½ä»¤è¡Œä¸­è®¾ç½®å¯†ç 
ALTER USER postgres PASSWORD 'your_secure_password';

-- é€€å‡º
\q
```

### 2. åˆ›å»ºåº”ç”¨æ•°æ®åº“å’Œç”¨æˆ·

```sql
-- è¿æ¥åˆ°PostgreSQL
sudo -u postgres psql

-- åˆ›å»ºåº”ç”¨æ•°æ®åº“
CREATE DATABASE mes_backend 
    WITH ENCODING 'UTF8' 
    LC_COLLATE='zh_CN.UTF-8' 
    LC_CTYPE='zh_CN.UTF-8'
    TEMPLATE template0;

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER mes_user WITH PASSWORD 'mes_secure_password';

-- æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE mes_backend TO mes_user;

-- è¿æ¥åˆ°åº”ç”¨æ•°æ®åº“
\c mes_backend

-- æˆäºˆschemaæƒé™
GRANT ALL PRIVILEGES ON SCHEMA public TO mes_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO mes_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO mes_user;

-- è®¾ç½®é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO mes_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO mes_user;

-- é€€å‡º
\q
```

### 3. é…ç½®è¿æ¥è®¤è¯

```bash
# ç¼–è¾‘pg_hba.confæ–‡ä»¶
sudo nano /etc/postgresql/15/main/pg_hba.conf

# æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆåœ¨æ–‡ä»¶æœ«å°¾ï¼‰
# æœ¬åœ°è¿æ¥é…ç½®
local   all             mes_user                                md5
host    all             mes_user        127.0.0.1/32            md5
host    all             mes_user        ::1/128                 md5

# å¦‚æœéœ€è¦è¿œç¨‹è¿æ¥ï¼ˆä»…å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰
# host    all             mes_user        192.168.1.0/24          md5
```

### 4. é…ç½®ç½‘ç»œè¿æ¥

```bash
# ç¼–è¾‘postgresql.confæ–‡ä»¶
sudo nano /etc/postgresql/15/main/postgresql.conf

# ä¿®æ”¹ç›‘å¬åœ°å€
listen_addresses = 'localhost'          # ä»…æœ¬åœ°è¿æ¥
# listen_addresses = '*'                 # å…è®¸æ‰€æœ‰åœ°å€ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰

# ä¿®æ”¹ç«¯å£ï¼ˆå¯é€‰ï¼‰
port = 5432
```

### 5. é‡å¯PostgreSQLæœåŠ¡

```bash
# é‡å¯æœåŠ¡ä»¥åº”ç”¨é…ç½®
sudo systemctl restart postgresql

# éªŒè¯æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# æµ‹è¯•è¿æ¥
psql -U mes_user -d mes_backend -h localhost -W
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®

### 1. å†…å­˜é…ç½®

```ini
# postgresql.conf å†…å­˜ç›¸å…³é…ç½®

# å…±äº«ç¼“å†²åŒºï¼ˆæ¨èï¼šç‰©ç†å†…å­˜çš„25%ï¼‰
shared_buffers = 256MB              # å¯¹äº1GBå†…å­˜çš„æœåŠ¡å™¨
shared_buffers = 1GB                # å¯¹äº4GBå†…å­˜çš„æœåŠ¡å™¨
shared_buffers = 4GB                # å¯¹äº16GBå†…å­˜çš„æœåŠ¡å™¨

# æœ‰æ•ˆç¼“å­˜å¤§å°ï¼ˆæ¨èï¼šç‰©ç†å†…å­˜çš„75%ï¼‰
effective_cache_size = 768MB        # å¯¹äº1GBå†…å­˜çš„æœåŠ¡å™¨
effective_cache_size = 3GB          # å¯¹äº4GBå†…å­˜çš„æœåŠ¡å™¨
effective_cache_size = 12GB         # å¯¹äº16GBå†…å­˜çš„æœåŠ¡å™¨

# å·¥ä½œå†…å­˜ï¼ˆå•ä¸ªæŸ¥è¯¢æ“ä½œå¯ç”¨å†…å­˜ï¼‰
work_mem = 4MB                      # å¼€å‘ç¯å¢ƒ
work_mem = 8MB                      # ç”Ÿäº§ç¯å¢ƒ

# ç»´æŠ¤å·¥ä½œå†…å­˜ï¼ˆç´¢å¼•åˆ›å»ºã€VACUUMç­‰æ“ä½œï¼‰
maintenance_work_mem = 64MB         # å¼€å‘ç¯å¢ƒ
maintenance_work_mem = 256MB        # ç”Ÿäº§ç¯å¢ƒ
```

### 2. WALï¼ˆWrite-Ahead Loggingï¼‰é…ç½®

```ini
# WALé…ç½®
wal_level = replica                 # æ”¯æŒæµå¤åˆ¶
max_wal_size = 2GB                  # æœ€å¤§WALæ–‡ä»¶å¤§å°
min_wal_size = 80MB                 # æœ€å°WALæ–‡ä»¶å¤§å°

# æ£€æŸ¥ç‚¹é…ç½®
checkpoint_completion_target = 0.9   # æ£€æŸ¥ç‚¹å®Œæˆç›®æ ‡
checkpoint_timeout = 5min           # æ£€æŸ¥ç‚¹è¶…æ—¶æ—¶é—´

# WALå†™å…¥é…ç½®
wal_sync_method = fdatasync         # WALåŒæ­¥æ–¹æ³•
synchronous_commit = on             # åŒæ­¥æäº¤ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
# synchronous_commit = off          # å¼‚æ­¥æäº¤ï¼ˆæµ‹è¯•ç¯å¢ƒï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰

# WALç¼“å†²åŒº
wal_buffers = 16MB                  # WALç¼“å†²åŒºå¤§å°
```

### 3. è¿æ¥å’Œå¹¶å‘é…ç½®

```ini
# è¿æ¥é…ç½®
max_connections = 100               # æœ€å¤§è¿æ¥æ•°ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
max_connections = 200               # æœ€å¤§è¿æ¥æ•°ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

# è¿›ç¨‹é…ç½®
max_worker_processes = 8            # æœ€å¤§å·¥ä½œè¿›ç¨‹æ•°
max_parallel_workers = 4            # æœ€å¤§å¹¶è¡Œå·¥ä½œè€…
max_parallel_workers_per_gather = 2 # æ¯ä¸ªæŸ¥è¯¢çš„æœ€å¤§å¹¶è¡Œå·¥ä½œè€…

# è¶…æ—¶é…ç½®
statement_timeout = 0               # è¯­å¥è¶…æ—¶ï¼ˆ0è¡¨ç¤ºæ— é™åˆ¶ï¼‰
lock_timeout = 0                    # é”ç­‰å¾…è¶…æ—¶
idle_in_transaction_session_timeout = 0  # äº‹åŠ¡ç©ºé—²è¶…æ—¶
```

### 4. æŸ¥è¯¢ä¼˜åŒ–é…ç½®

```ini
# æŸ¥è¯¢è§„åˆ’å™¨é…ç½®
random_page_cost = 1.1              # éšæœºé¡µé¢æˆæœ¬ï¼ˆSSDä¼˜åŒ–ï¼‰
seq_page_cost = 1.0                 # é¡ºåºé¡µé¢æˆæœ¬
cpu_tuple_cost = 0.01               # CPUå…ƒç»„æˆæœ¬
cpu_index_tuple_cost = 0.005        # CPUç´¢å¼•å…ƒç»„æˆæœ¬
cpu_operator_cost = 0.0025          # CPUæ“ä½œç¬¦æˆæœ¬

# ç»Ÿè®¡ä¿¡æ¯é…ç½®
default_statistics_target = 100     # é»˜è®¤ç»Ÿè®¡ç›®æ ‡
constraint_exclusion = partition    # çº¦æŸæ’é™¤
```

### 5. æ—¥å¿—é…ç½®

```ini
# æ—¥å¿—é…ç½®
logging_collector = on              # å¯ç”¨æ—¥å¿—æ”¶é›†å™¨
log_destination = 'stderr,csvlog'   # æ—¥å¿—ç›®æ ‡

# æ—¥å¿—æ–‡ä»¶é…ç½®
log_directory = 'log'               # æ—¥å¿—ç›®å½•
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # æ—¥å¿—æ–‡ä»¶åæ ¼å¼
log_file_mode = 0600                # æ—¥å¿—æ–‡ä»¶æƒé™

# æ—¥å¿—è½®è½¬
log_rotation_age = 1d               # æ—¥å¿—è½®è½¬å‘¨æœŸ
log_rotation_size = 100MB           # æ—¥å¿—è½®è½¬å¤§å°

# æ…¢æŸ¥è¯¢æ—¥å¿—
log_min_duration_statement = 1000   # è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_statement = 'none'              # è®°å½•è¯­å¥ç±»å‹
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# é”ç­‰å¾…æ—¥å¿—
log_lock_waits = on                 # è®°å½•é”ç­‰å¾…
deadlock_timeout = 1s               # æ­»é”æ£€æµ‹è¶…æ—¶
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. ç”¨æˆ·æƒé™ç®¡ç†

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER mes_readonly WITH PASSWORD 'readonly_password';
GRANT CONNECT ON DATABASE mes_backend TO mes_readonly;
GRANT USAGE ON SCHEMA public TO mes_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO mes_readonly;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO mes_readonly;

-- åˆ›å»ºå¤‡ä»½ç”¨æˆ·
CREATE USER mes_backup WITH PASSWORD 'backup_password';
GRANT CONNECT ON DATABASE mes_backend TO mes_backup;
GRANT USAGE ON SCHEMA public TO mes_backup;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO mes_backup;

-- æ’¤é”€public schemaçš„publicæƒé™
REVOKE CREATE ON SCHEMA public FROM PUBLIC;
```

### 2. SSLé…ç½®

```ini
# postgresql.conf SSLé…ç½®
ssl = on                            # å¯ç”¨SSL
ssl_cert_file = 'server.crt'       # SSLè¯ä¹¦æ–‡ä»¶
ssl_key_file = 'server.key'        # SSLç§é’¥æ–‡ä»¶
ssl_ca_file = 'ca.crt'             # CAè¯ä¹¦æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'  # SSLåŠ å¯†å¥—ä»¶
ssl_prefer_server_ciphers = on      # ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨åŠ å¯†å¥—ä»¶
```

### 3. é˜²ç«å¢™é…ç½®

```bash
# é…ç½®iptablesè§„åˆ™
sudo iptables -A INPUT -p tcp --dport 5432 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 5432 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 5432 -j DROP

# ä¿å­˜è§„åˆ™
sudo netfilter-persistent save
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT pid, usename, application_name, client_addr, state, query_start, query 
FROM pg_stat_activity 
WHERE state = 'active';

-- æŸ¥çœ‹æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
SELECT datname, numbackends, xact_commit, xact_rollback, blks_read, blks_hit 
FROM pg_stat_database 
WHERE datname = 'mes_backend';

-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SELECT schemaname, tablename, seq_scan, seq_tup_read, idx_scan, idx_tup_fetch, n_tup_ins, n_tup_upd, n_tup_del
FROM pg_stat_user_tables 
ORDER BY seq_scan DESC;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes 
ORDER BY idx_scan DESC;
```

### 2. å®šæœŸç»´æŠ¤ä»»åŠ¡

```bash
# åˆ›å»ºç»´æŠ¤è„šæœ¬
cat > /usr/local/bin/postgres_maintenance.sh << 'EOF'
#!/bin/bash

DATABASE="mes_backend"
USER="mes_user"

echo "$(date): å¼€å§‹PostgreSQLç»´æŠ¤ä»»åŠ¡"

# æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
psql -U $USER -d $DATABASE -c "ANALYZE;"

# æ¸…ç†æ­»å…ƒç»„
psql -U $USER -d $DATABASE -c "VACUUM ANALYZE;"

# é‡å»ºç´¢å¼•ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œä¼šé”è¡¨ï¼‰
# psql -U $USER -d $DATABASE -c "REINDEX DATABASE $DATABASE;"

echo "$(date): PostgreSQLç»´æŠ¤ä»»åŠ¡å®Œæˆ"
EOF

chmod +x /usr/local/bin/postgres_maintenance.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å‘¨æ‰§è¡Œä¸€æ¬¡ï¼‰
echo "0 2 * * 0 /usr/local/bin/postgres_maintenance.sh >> /var/log/postgres_maintenance.log 2>&1" | sudo crontab -u postgres -
```

### 3. å¤‡ä»½ç­–ç•¥

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /usr/local/bin/postgres_backup.sh << 'EOF'
#!/bin/bash

DATABASE="mes_backend"
USER="mes_backup"
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
pg_dump -U $USER -h localhost -d $DATABASE -f "$BACKUP_DIR/mes_backend_$DATE.sql"

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip "$BACKUP_DIR/mes_backend_$DATE.sql"

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "$(date): å¤‡ä»½å®Œæˆ - mes_backend_$DATE.sql.gz"
EOF

chmod +x /usr/local/bin/postgres_backup.sh

# æ·»åŠ åˆ°crontabï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
echo "0 2 * * * /usr/local/bin/postgres_backup.sh >> /var/log/postgres_backup.log 2>&1" | sudo crontab -u postgres -
```

## ğŸ”§ Laravelé›†æˆé…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®

```env
# .envæ–‡ä»¶é…ç½®
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=mes_backend
DB_USERNAME=mes_user
DB_PASSWORD=mes_secure_password
DB_CHARSET=utf8
DB_SCHEMA=public
```

### 2. Laravelæ•°æ®åº“é…ç½®

```php
// config/database.php
'pgsql' => [
    'driver' => 'pgsql',
    'url' => env('DATABASE_URL'),
    'host' => env('DB_HOST', '127.0.0.1'),
    'port' => env('DB_PORT', '5432'),
    'database' => env('DB_DATABASE', 'forge'),
    'username' => env('DB_USERNAME', 'forge'),
    'password' => env('DB_PASSWORD', ''),
    'charset' => env('DB_CHARSET', 'utf8'),
    'prefix' => '',
    'prefix_indexes' => true,
    'search_path' => 'public',
    'sslmode' => 'prefer',
],
```

### 3. æµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
# Laravel Artisanå‘½ä»¤æµ‹è¯•
php artisan db:show

# Tinkeræµ‹è¯•
php artisan tinker
>>> DB::connection()->select('SELECT version() as version');
>>> DB::table('pg_database')->where('datname', 'mes_backend')->first();
```

## ğŸš¨ æ•…éšœæ’é™¤

### 1. å¸¸è§è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep 5432

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
sudo tail -f /var/log/postgresql/postgresql-15-main.log

# æµ‹è¯•æœ¬åœ°è¿æ¥
psql -U mes_user -d mes_backend -h localhost

# æ£€æŸ¥pg_hba.confé…ç½®
sudo cat /etc/postgresql/15/main/pg_hba.conf | grep -v "^#" | grep -v "^$"
```

### 2. æ€§èƒ½é—®é¢˜è¯Šæ–­

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time 
FROM pg_stat_statements 
ORDER BY total_time DESC 
LIMIT 10;

-- æŸ¥çœ‹è¡¨è†¨èƒ€
SELECT schemaname, tablename, 
       pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
       pg_stat_get_tuples_inserted(c.oid) as inserts,
       pg_stat_get_tuples_updated(c.oid) as updates,
       pg_stat_get_tuples_deleted(c.oid) as deletes
FROM pg_tables pt
JOIN pg_class c ON c.relname = pt.tablename
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹é”ç­‰å¾…
SELECT pid, mode, locktype, database, relation::regclass, page, tuple, virtualxid, transactionid, virtualtransaction, granted, fastpath
FROM pg_locks 
WHERE NOT granted;
```

### 3. æ¢å¤å’Œä¿®å¤

```bash
# ä»å¤‡ä»½æ¢å¤
createdb mes_backend_restore
psql -U mes_user -d mes_backend_restore -f /var/backups/postgresql/mes_backend_20231201_020000.sql

# æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
sudo -u postgres postgres --single -D /var/lib/postgresql/15/main mes_backend <<< "VACUUM FULL ANALYZE;"

# é‡å»ºæŸåçš„ç´¢å¼•
psql -U mes_user -d mes_backend -c "REINDEX DATABASE mes_backend;"
```

---

**ğŸ“‹ ä¸‹ä¸€æ­¥**ï¼šæ•°æ®åº“é…ç½®å®Œæˆåï¼Œå‚è€ƒ [6. Redisé…ç½®.md](./6.%20Redisé…ç½®.md) é…ç½®ç¼“å­˜æœåŠ¡ã€‚ 