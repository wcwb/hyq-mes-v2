# MES è®¤è¯ç³»ç»Ÿå¼€å‘è€…æŒ‡å—

æœ¬æŒ‡å—ä¸ºå¼€å‘è€…æä¾›åœ¨MESç³»ç»Ÿä¸­æ‰©å±•å’Œç»´æŠ¤è®¤è¯åŠŸèƒ½çš„è¯¦ç»†æŒ‡å¯¼ï¼ŒåŒ…æ‹¬æƒé™ç®¡ç†ã€Policyåˆ›å»ºã€å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†å’Œæµ‹è¯•ç­–ç•¥ã€‚

## ğŸ“‹ ç›®å½•
- [æƒé™ç³»ç»Ÿæ‰©å±•](#æƒé™ç³»ç»Ÿæ‰©å±•)
- [Policyå¼€å‘æŒ‡å—](#policyå¼€å‘æŒ‡å—)
- [å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†](#å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†)
- [è®¤è¯æµ‹è¯•æŒ‡å—](#è®¤è¯æµ‹è¯•æŒ‡å—)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜è§£å†³](#å¸¸è§é—®é¢˜è§£å†³)

## ğŸ” æƒé™ç³»ç»Ÿæ‰©å±•

### 1. æ·»åŠ æ–°æƒé™

#### æ­¥éª¤1ï¼šå®šä¹‰æƒé™å¸¸é‡
åœ¨ `database/seeders/ModulePermissionSeeder.php` ä¸­æ·»åŠ æ–°çš„æƒé™å®šä¹‰ï¼š

```php
<?php
// database/seeders/ModulePermissionSeeder.php

class ModulePermissionSeeder extends Seeder
{
    public function run()
    {
        // ç°æœ‰æƒé™...
        
        // æ–°å¢è´¨é‡ç®¡ç†æƒé™
        $qualityPermissions = [
            'quality.view' => 'æŸ¥çœ‹è´¨é‡æ•°æ®',
            'quality.create' => 'åˆ›å»ºè´¨é‡æ£€æµ‹è®°å½•',
            'quality.edit' => 'ç¼–è¾‘è´¨é‡æ•°æ®',
            'quality.delete' => 'åˆ é™¤è´¨é‡è®°å½•',
            'quality.approve' => 'å®¡æ‰¹è´¨é‡æŠ¥å‘Š',
            'quality.export' => 'å¯¼å‡ºè´¨é‡æ•°æ®',
        ];

        foreach ($qualityPermissions as $name => $description) {
            Permission::firstOrCreate(
                ['name' => $name],
                [
                    'guard_name' => 'sanctum',
                    'description' => $description,
                    'team_id' => null, // å…¨å±€æƒé™ï¼Œç”±å›¢é˜Ÿçº§æƒé™ç»§æ‰¿
                ]
            );
        }
    }
}
```

#### æ­¥éª¤2ï¼šè¿è¡ŒSeeder
```bash
php artisan db:seed --class=ModulePermissionSeeder
```

#### æ­¥éª¤3ï¼šä¸ºè§’è‰²åˆ†é…æƒé™
```php
// åœ¨DatabaseSeederæˆ–ç›¸å…³seederä¸­
$productionRole = Role::where('name', 'Production Manager')->first();
$productionRole->givePermissionTo([
    'quality.view',
    'quality.create',
    'quality.edit'
]);
```

### 2. æƒé™å‘½åçº¦å®š

éµå¾ªç»Ÿä¸€çš„æƒé™å‘½åæ ¼å¼ï¼š`æ¨¡å—.æ“ä½œ`

```php
// æ¨èçš„æƒé™å‘½åæ¨¡å¼
$permissions = [
    // è®¢å•ç®¡ç†
    'orders.view',
    'orders.create', 
    'orders.edit',
    'orders.delete',
    'orders.approve',
    
    // ç”Ÿäº§ç®¡ç†
    'production.view',
    'production.plan',
    'production.execute',
    'production.monitor',
    
    // è´¨é‡ç®¡ç†
    'quality.inspect',
    'quality.report',
    'quality.analyze',
    
    // ç³»ç»Ÿç®¡ç†
    'system.users.manage',
    'system.teams.manage',
    'system.permissions.manage',
];
```

### 3. åŠ¨æ€æƒé™æ£€æŸ¥

#### åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;

class QualityController extends Controller
{
    public function index(Request $request)
    {
        // æ–¹å¼1ï¼šä½¿ç”¨authorizeæ–¹æ³•
        $this->authorize('quality.view');
        
        // æ–¹å¼2ï¼šä½¿ç”¨canæ–¹æ³•
        if (!$request->user()->can('quality.view')) {
            abort(403, 'æ‚¨æ²¡æœ‰æŸ¥çœ‹è´¨é‡æ•°æ®çš„æƒé™');
        }
        
        // ä¸šåŠ¡é€»è¾‘...
    }
    
    public function store(Request $request)
    {
        $this->authorize('quality.create');
        
        // åˆ›å»ºé€»è¾‘...
    }
}
```

#### åœ¨è§†å›¾ä¸­ä½¿ç”¨ï¼ˆBladeæ¨¡æ¿ï¼‰
```php
@can('quality.create')
    <button class="btn btn-primary">åˆ›å»ºè´¨é‡æ£€æµ‹</button>
@endcan

@cannot('quality.delete')
    <p class="text-muted">æ‚¨æ²¡æœ‰åˆ é™¤æƒé™</p>
@endcannot
```

---

## ğŸ›¡ï¸ Policyå¼€å‘æŒ‡å—

### 1. åˆ›å»ºPolicyç±»

```bash
php artisan make:policy QualityPolicy --model=Quality
```

### 2. Policyå®ç°ç¤ºä¾‹

```php
<?php

namespace App\Policies;

use App\Models\User;
use App\Models\Quality;
use Illuminate\Auth\Access\HandlesAuthorization;
use Spatie\Permission\PermissionRegistrar;

/**
 * è´¨é‡ç®¡ç†Policy
 * 
 * å¤„ç†è´¨é‡æ•°æ®çš„è®¿é—®æ§åˆ¶ï¼Œç¡®ä¿å›¢é˜Ÿéš”ç¦»å’Œæƒé™éªŒè¯
 * 
 * ä¸šåŠ¡åœºæ™¯ï¼š
 * - ç”¨æˆ·åªèƒ½è®¿é—®å…¶å½“å‰å›¢é˜Ÿçš„è´¨é‡æ•°æ®
 * - è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
 * - ä¸åŒè§’è‰²æœ‰ä¸åŒçš„æ“ä½œæƒé™
 * 
 * å®‰å…¨è€ƒè™‘ï¼š
 * - ä¸¥æ ¼çš„å›¢é˜Ÿè¾¹ç•Œæ£€æŸ¥
 * - é˜²æ­¢è·¨å›¢é˜Ÿæ•°æ®è®¿é—®
 * - å®Œæ•´çš„æƒé™éªŒè¯é“¾
 */
class QualityPolicy
{
    use HandlesAuthorization;

    /**
     * æƒé™é¢„æ£€æŸ¥ - è¶…çº§ç®¡ç†å‘˜ç»•è¿‡
     * 
     * @param User $user
     * @return bool|null
     */
    public function before(User $user): ?bool
    {
        return $user->is_super_admin ? true : null;
    }

    /**
     * æŸ¥çœ‹è´¨é‡æ•°æ®åˆ—è¡¨
     * 
     * @param User $user
     * @return bool
     */
    public function viewAny(User $user): bool
    {
        // è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        if ($user->current_team_id) {
            app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        }
        
        return $user->hasPermissionTo('quality.view');
    }

    /**
     * æŸ¥çœ‹ç‰¹å®šè´¨é‡è®°å½•
     * 
     * @param User $user
     * @param Quality $quality
     * @return bool
     */
    public function view(User $user, Quality $quality): bool
    {
        // å›¢é˜Ÿè¾¹ç•Œæ£€æŸ¥
        if ($user->current_team_id !== $quality->team_id) {
            return false;
        }
        
        // è®¾ç½®æƒé™ä¸Šä¸‹æ–‡
        app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        
        return $user->hasPermissionTo('quality.view');
    }

    /**
     * åˆ›å»ºè´¨é‡è®°å½•
     * 
     * @param User $user
     * @return bool
     */
    public function create(User $user): bool
    {
        if (!$user->current_team_id) {
            return false;
        }
        
        app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        
        return $user->hasPermissionTo('quality.create');
    }

    /**
     * æ›´æ–°è´¨é‡è®°å½•
     * 
     * @param User $user
     * @param Quality $quality
     * @return bool
     */
    public function update(User $user, Quality $quality): bool
    {
        // å›¢é˜Ÿè¾¹ç•Œæ£€æŸ¥
        if ($user->current_team_id !== $quality->team_id) {
            return false;
        }
        
        // åªæœ‰åˆ›å»ºè€…æˆ–æœ‰ç¼–è¾‘æƒé™çš„ç”¨æˆ·å¯ä»¥æ›´æ–°
        if ($quality->creator_id === $user->id) {
            return true;
        }
        
        app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        
        return $user->hasPermissionTo('quality.edit');
    }

    /**
     * åˆ é™¤è´¨é‡è®°å½•
     * 
     * @param User $user
     * @param Quality $quality
     * @return bool
     */
    public function delete(User $user, Quality $quality): bool
    {
        // å›¢é˜Ÿè¾¹ç•Œæ£€æŸ¥
        if ($user->current_team_id !== $quality->team_id) {
            return false;
        }
        
        app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        
        return $user->hasPermissionTo('quality.delete');
    }

    /**
     * å®¡æ‰¹è´¨é‡æŠ¥å‘Š
     * 
     * @param User $user
     * @param Quality $quality
     * @return bool
     */
    public function approve(User $user, Quality $quality): bool
    {
        // å›¢é˜Ÿè¾¹ç•Œæ£€æŸ¥
        if ($user->current_team_id !== $quality->team_id) {
            return false;
        }
        
        // ä¸èƒ½å®¡æ‰¹è‡ªå·±åˆ›å»ºçš„è®°å½•
        if ($quality->creator_id === $user->id) {
            return false;
        }
        
        app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
        
        return $user->hasPermissionTo('quality.approve');
    }
}
```

### 3. Policyæ³¨å†Œ

åœ¨ `AuthServiceProvider.php` ä¸­æ³¨å†ŒPolicyï¼š

```php
<?php

namespace App\Providers;

use App\Models\Quality;
use App\Policies\QualityPolicy;
use Illuminate\Foundation\Support\Providers\AuthServiceProvider as ServiceProvider;
use Illuminate\Support\Facades\Gate;
use App\Models\User;

class AuthServiceProvider extends ServiceProvider
{
    protected $policies = [
        Quality::class => QualityPolicy::class,
        // å…¶ä»–Policy...
    ];

    public function boot()
    {
        $this->registerPolicies();

        // è¶…çº§ç®¡ç†å‘˜å…¨å±€æƒé™ï¼ˆé‡è¦ï¼ï¼‰
        Gate::before(function (User $user) {
            return $user->is_super_admin ? true : null;
        });
    }
}
```

### 4. åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨Policy

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Quality;
use App\Http\Requests\QualityRequest;
use Illuminate\Http\Request;

class QualityController extends Controller
{
    public function index(Request $request)
    {
        $this->authorize('viewAny', Quality::class);
        
        // è·å–å½“å‰å›¢é˜Ÿçš„è´¨é‡æ•°æ®
        $qualities = Quality::where('team_id', $request->user()->current_team_id)
            ->paginate(15);
            
        return response()->json($qualities);
    }
    
    public function show(Quality $quality)
    {
        $this->authorize('view', $quality);
        
        return response()->json($quality);
    }
    
    public function store(QualityRequest $request)
    {
        $this->authorize('create', Quality::class);
        
        $quality = Quality::create([
            'team_id' => $request->user()->current_team_id,
            'creator_id' => $request->user()->id,
            // å…¶ä»–å­—æ®µ...
        ]);
        
        return response()->json($quality, 201);
    }
    
    public function update(QualityRequest $request, Quality $quality)
    {
        $this->authorize('update', $quality);
        
        $quality->update($request->validated());
        $quality->update(['updater_id' => $request->user()->id]);
        
        return response()->json($quality);
    }
    
    public function destroy(Quality $quality)
    {
        $this->authorize('delete', $quality);
        
        $quality->update(['deleter_id' => auth()->id()]);
        $quality->delete();
        
        return response()->json(null, 204);
    }
}
```

---

## ğŸ¢ å›¢é˜Ÿä¸Šä¸‹æ–‡ç®¡ç†

### 1. å›¢é˜Ÿä¸Šä¸‹æ–‡åˆ‡æ¢

#### åˆ›å»ºå›¢é˜Ÿåˆ‡æ¢æœåŠ¡
```php
<?php

namespace App\Services\Auth;

use App\Models\User;
use App\Models\Team;
use Spatie\Permission\PermissionRegistrar;
use Illuminate\Support\Facades\Cache;

/**
 * å›¢é˜Ÿæƒé™ä¸Šä¸‹æ–‡æœåŠ¡
 * 
 * ç®¡ç†ç”¨æˆ·åœ¨ä¸åŒå›¢é˜Ÿé—´çš„æƒé™ä¸Šä¸‹æ–‡åˆ‡æ¢
 */
class TeamPermissionService
{
    /**
     * åˆ·æ–°ç”¨æˆ·å›¢é˜Ÿæƒé™ä¸Šä¸‹æ–‡
     * 
     * @param User $user
     * @param int $teamId
     * @return bool
     */
    public static function refreshUserTeamContext(User $user, int $teamId): bool
    {
        // éªŒè¯ç”¨æˆ·æ˜¯å¦å±äºè¯¥å›¢é˜Ÿ
        if (!$user->teams()->where('teams.id', $teamId)->exists()) {
            return false;
        }
        
        // æ¸…é™¤ç”¨æˆ·çš„æƒé™ç¼“å­˜ï¼ˆé‡è¦ï¼ï¼‰
        $user->unsetRelation('roles')->unsetRelation('permissions');
        
        // è®¾ç½®æ–°çš„å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        // æ›´æ–°ç”¨æˆ·å½“å‰å›¢é˜Ÿ
        $user->update(['current_team_id' => $teamId]);
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        Cache::forget("user_permissions_{$user->id}");
        Cache::forget("user_roles_{$user->id}");
        
        return true;
    }
    
    /**
     * è·å–ç”¨æˆ·åœ¨æŒ‡å®šå›¢é˜Ÿçš„æƒé™
     * 
     * @param User $user
     * @param int $teamId
     * @return array
     */
    public static function getUserTeamPermissions(User $user, int $teamId): array
    {
        // ä¸´æ—¶è®¾ç½®å›¢é˜Ÿä¸Šä¸‹æ–‡
        $originalTeamId = app(PermissionRegistrar::class)->getPermissionsTeamId();
        app(PermissionRegistrar::class)->setPermissionsTeamId($teamId);
        
        // è·å–æƒé™
        $permissions = $user->getPermissionNames()->toArray();
        
        // æ¢å¤åŸå§‹ä¸Šä¸‹æ–‡
        app(PermissionRegistrar::class)->setPermissionsTeamId($originalTeamId);
        
        return $permissions;
    }
}
```

#### å›¢é˜Ÿåˆ‡æ¢æ§åˆ¶å™¨
```php
<?php

namespace App\Http\Controllers\Api\Auth;

use App\Http\Controllers\Controller;
use App\Http\Requests\Auth\SwitchTeamRequest;
use App\Services\Auth\TeamPermissionService;
use App\Http\Helpers\ApiResponse;
use Illuminate\Http\JsonResponse;

class TeamSwitchController extends Controller
{
    /**
     * åˆ‡æ¢ç”¨æˆ·å½“å‰å›¢é˜Ÿ
     * 
     * @param SwitchTeamRequest $request
     * @return JsonResponse
     */
    public function switchTeam(SwitchTeamRequest $request): JsonResponse
    {
        $user = $request->user();
        $teamId = $request->validated()['team_id'];
        
        if (TeamPermissionService::refreshUserTeamContext($user, $teamId)) {
            return ApiResponse::success([
                'current_team_id' => $teamId,
                'permissions' => TeamPermissionService::getUserTeamPermissions($user, $teamId)
            ], 'å›¢é˜Ÿåˆ‡æ¢æˆåŠŸ');
        }
        
        return ApiResponse::error('å›¢é˜Ÿåˆ‡æ¢å¤±è´¥ï¼Œç”¨æˆ·ä¸å±äºè¯¥å›¢é˜Ÿ', [], 403);
    }
    
    /**
     * è·å–ç”¨æˆ·æ‰€å±å›¢é˜Ÿåˆ—è¡¨
     * 
     * @return JsonResponse
     */
    public function getTeams(): JsonResponse
    {
        $user = auth()->user();
        $teams = $user->teams()->withPivot('role')->get();
        
        return ApiResponse::success($teams, 'è·å–å›¢é˜Ÿåˆ—è¡¨æˆåŠŸ');
    }
}
```

### 2. æ¨¡å‹ä¸­çš„å›¢é˜Ÿéš”ç¦»

#### æ¨¡å‹åŸºç±»è®¾ç½®
```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * å›¢é˜Ÿéš”ç¦»æ¨¡å‹åŸºç±»
 * 
 * ä¸ºæ‰€æœ‰ä¸šåŠ¡æ¨¡å‹æä¾›å›¢é˜Ÿéš”ç¦»çš„åŸºç¡€åŠŸèƒ½
 */
abstract class TeamModel extends Model
{
    use SoftDeletes;
    
    /**
     * å›¢é˜Ÿéš”ç¦»å­—æ®µ
     */
    protected $fillable = [
        'team_id',
        'creator_id', 
        'updater_id',
        'deleter_id',
    ];
    
    /**
     * è‡ªåŠ¨è®¾ç½®å›¢é˜Ÿå’Œåˆ›å»ºè€…
     */
    protected static function booted()
    {
        static::creating(function ($model) {
            if (auth()->check()) {
                $model->team_id = auth()->user()->current_team_id;
                $model->creator_id = auth()->id();
            }
        });
        
        static::updating(function ($model) {
            if (auth()->check()) {
                $model->updater_id = auth()->id();
            }
        });
        
        static::deleting(function ($model) {
            if (auth()->check()) {
                $model->deleter_id = auth()->id();
            }
        });
    }
    
    /**
     * å›¢é˜Ÿå…³è”
     */
    public function team()
    {
        return $this->belongsTo(Team::class);
    }
    
    /**
     * åˆ›å»ºè€…å…³è”
     */
    public function creator()
    {
        return $this->belongsTo(User::class, 'creator_id');
    }
    
    /**
     * æ›´æ–°è€…å…³è”
     */
    public function updater()
    {
        return $this->belongsTo(User::class, 'updater_id');
    }
    
    /**
     * åˆ é™¤è€…å…³è”
     */
    public function deleter()
    {
        return $this->belongsTo(User::class, 'deleter_id');
    }
    
    /**
     * å›¢é˜ŸèŒƒå›´æŸ¥è¯¢
     */
    public function scopeForTeam($query, $teamId = null)
    {
        $teamId = $teamId ?? auth()->user()->current_team_id ?? null;
        
        if ($teamId) {
            return $query->where('team_id', $teamId);
        }
        
        return $query;
    }
}
```

### 3. å›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­é—´ä»¶

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Spatie\Permission\PermissionRegistrar;

/**
 * å›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­é—´ä»¶
 * 
 * ç¡®ä¿æ¯ä¸ªè¯·æ±‚éƒ½åœ¨æ­£ç¡®çš„å›¢é˜Ÿä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
 */
class TeamContext
{
    public function handle(Request $request, Closure $next)
    {
        if (auth()->check()) {
            $user = auth()->user();
            
            // è®¾ç½®å½“å‰ç”¨æˆ·çš„å›¢é˜Ÿä¸Šä¸‹æ–‡
            if ($user->current_team_id) {
                app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);
            }
        }
        
        return $next($request);
    }
}
```

---

## ğŸ§ª è®¤è¯æµ‹è¯•æŒ‡å—

### 1. å•å…ƒæµ‹è¯•ç¤ºä¾‹

#### Policyæµ‹è¯•
```php
<?php

namespace Tests\Unit\Policies;

use Tests\TestCase;
use App\Models\User;
use App\Models\Quality;
use App\Models\Team;
use App\Policies\QualityPolicy;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class QualityPolicyTest extends TestCase
{
    use RefreshDatabase;
    
    protected function setUp(): void
    {
        parent::setUp();
        
        // åˆ›å»ºæƒé™
        Permission::create(['name' => 'quality.view', 'guard_name' => 'sanctum']);
        Permission::create(['name' => 'quality.create', 'guard_name' => 'sanctum']);
        Permission::create(['name' => 'quality.edit', 'guard_name' => 'sanctum']);
        Permission::create(['name' => 'quality.delete', 'guard_name' => 'sanctum']);
    }
    
    public function test_super_admin_can_access_everything()
    {
        $superAdmin = User::factory()->create(['is_super_admin' => true]);
        $team = Team::factory()->create();
        $quality = Quality::factory()->create(['team_id' => $team->id]);
        
        $policy = new QualityPolicy();
        
        $this->assertTrue($policy->view($superAdmin, $quality));
        $this->assertTrue($policy->create($superAdmin));
        $this->assertTrue($policy->update($superAdmin, $quality));
        $this->assertTrue($policy->delete($superAdmin, $quality));
    }
    
    public function test_user_can_only_access_own_team_data()
    {
        $team1 = Team::factory()->create();
        $team2 = Team::factory()->create();
        
        $user = User::factory()->create(['current_team_id' => $team1->id]);
        $user->teams()->attach($team1->id);
        
        $role = Role::create(['name' => 'Quality Manager', 'guard_name' => 'sanctum']);
        $role->givePermissionTo(['quality.view', 'quality.create']);
        $user->assignRole($role);
        
        $ownQuality = Quality::factory()->create(['team_id' => $team1->id]);
        $otherQuality = Quality::factory()->create(['team_id' => $team2->id]);
        
        $policy = new QualityPolicy();
        
        // å¯ä»¥è®¿é—®è‡ªå·±å›¢é˜Ÿçš„æ•°æ®
        $this->assertTrue($policy->view($user, $ownQuality));
        
        // ä¸èƒ½è®¿é—®å…¶ä»–å›¢é˜Ÿçš„æ•°æ®
        $this->assertFalse($policy->view($user, $otherQuality));
    }
    
    public function test_user_without_team_cannot_access_data()
    {
        $user = User::factory()->create(['current_team_id' => null]);
        $quality = Quality::factory()->create();
        
        $policy = new QualityPolicy();
        
        $this->assertFalse($policy->view($user, $quality));
        $this->assertFalse($policy->create($user));
    }
}
```

### 2. åŠŸèƒ½æµ‹è¯•ç¤ºä¾‹

#### APIç«¯ç‚¹æµ‹è¯•
```php
<?php

namespace Tests\Feature\Auth;

use Tests\TestCase;
use App\Models\User;
use App\Models\Team;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Laravel\Sanctum\Sanctum;

class AuthenticationTest extends TestCase
{
    use RefreshDatabase;
    
    public function test_user_can_login_with_email()
    {
        $user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password'),
        ]);
        
        $response = $this->postJson('/api/auth/login', [
            'user' => 'test@example.com',
            'password' => 'password',
            'device_name' => 'Test Device'
        ]);
        
        $response->assertStatus(200)
                 ->assertJsonStructure([
                     'success',
                     'data' => [
                         'user',
                         'token',
                         'expires_at',
                         'token_type'
                     ]
                 ]);
    }
    
    public function test_user_can_access_protected_route()
    {
        $user = User::factory()->create();
        Sanctum::actingAs($user);
        
        $response = $this->getJson('/api/auth/user');
        
        $response->assertStatus(200)
                 ->assertJson([
                     'success' => true,
                     'data' => [
                         'id' => $user->id,
                         'email' => $user->email,
                     ]
                 ]);
    }
    
    public function test_user_cannot_access_protected_route_without_token()
    {
        $response = $this->getJson('/api/auth/user');
        
        $response->assertStatus(401);
    }
    
    public function test_team_context_is_set_correctly()
    {
        $team = Team::factory()->create();
        $user = User::factory()->create(['current_team_id' => $team->id]);
        $user->teams()->attach($team->id);
        
        Sanctum::actingAs($user);
        
        $response = $this->getJson('/api/auth/user');
        
        $response->assertStatus(200)
                 ->assertJson([
                     'data' => [
                         'current_team_id' => $team->id,
                     ]
                 ]);
    }
}
```

### 3. æ€§èƒ½æµ‹è¯•

#### æƒé™æ£€æŸ¥æ€§èƒ½æµ‹è¯•
```php
<?php

namespace Tests\Feature\Performance;

use Tests\TestCase;
use App\Models\User;
use App\Models\Team;
use App\Services\Auth\PerformanceMonitoringService;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Laravel\Sanctum\Sanctum;

class AuthPerformanceTest extends TestCase
{
    use RefreshDatabase;
    
    public function test_permission_check_performance()
    {
        $team = Team::factory()->create();
        $user = User::factory()->create(['current_team_id' => $team->id]);
        $user->teams()->attach($team->id);
        
        Sanctum::actingAs($user);
        
        $monitor = app(PerformanceMonitoringService::class);
        
        // æ‰§è¡Œå¤šæ¬¡æƒé™æ£€æŸ¥æµ‹è¯•
        $startTime = microtime(true);
        
        for ($i = 0; $i < 100; $i++) {
            $user->can('quality.view');
        }
        
        $endTime = microtime(true);
        $totalTime = ($endTime - $startTime) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
        
        // å¹³å‡æ¯æ¬¡æƒé™æ£€æŸ¥åº”è¯¥åœ¨1msä»¥å†…
        $avgTime = $totalTime / 100;
        $this->assertLessThan(1.0, $avgTime, 'æƒé™æ£€æŸ¥æ€§èƒ½è¶…å‡ºé¢„æœŸ');
        
        // æ£€æŸ¥æ€§èƒ½ç›‘æ§æ•°æ®
        $stats = $monitor->getPerformanceStats('permission_check');
        $this->assertIsArray($stats);
    }
    
    public function test_token_validation_performance()
    {
        $user = User::factory()->create();
        $token = $user->createToken('Test Token')->plainTextToken;
        
        $startTime = microtime(true);
        
        for ($i = 0; $i < 50; $i++) {
            $response = $this->withHeaders([
                'Authorization' => 'Bearer ' . $token,
            ])->getJson('/api/auth/user');
            
            $response->assertStatus(200);
        }
        
        $endTime = microtime(true);
        $totalTime = ($endTime - $startTime) * 1000;
        $avgTime = $totalTime / 50;
        
        // å¹³å‡æ¯æ¬¡TokenéªŒè¯åº”è¯¥åœ¨5msä»¥å†…
        $this->assertLessThan(5.0, $avgTime, 'TokenéªŒè¯æ€§èƒ½è¶…å‡ºé¢„æœŸ');
    }
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æƒé™è®¾è®¡åŸåˆ™

#### æœ€å°æƒé™åŸåˆ™
```php
// âœ… å¥½çš„åšæ³•ï¼šç»†ç²’åº¦æƒé™
$permissions = [
    'orders.view',      // æŸ¥çœ‹è®¢å•
    'orders.create',    // åˆ›å»ºè®¢å•
    'orders.edit',      // ç¼–è¾‘è®¢å•
    'orders.delete',    // åˆ é™¤è®¢å•
    'orders.approve',   // å®¡æ‰¹è®¢å•
];

// âŒ é¿å…ï¼šè¿‡äºå®½æ³›çš„æƒé™
$permissions = [
    'orders.all',       // è¿‡äºå®½æ³›
    'admin.everything', // éå¸¸å±é™©
];
```

#### è§’è‰²å±‚æ¬¡è®¾è®¡
```php
// å»ºè®®çš„è§’è‰²å±‚æ¬¡ç»“æ„
$roles = [
    'Super Admin',           // ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜
    'Team Admin',            // å›¢é˜Ÿç®¡ç†å‘˜
    'Production Manager',    // ç”Ÿäº§ç»ç†
    'Quality Inspector',     // è´¨æ£€å‘˜
    'Operator',             // æ“ä½œå‘˜
    'Viewer',               // åªè¯»ç”¨æˆ·
];
```

### 2. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æƒé™ç¼“å­˜ä¼˜åŒ–
```php
// åœ¨Useræ¨¡å‹ä¸­æ·»åŠ æƒé™ç¼“å­˜
class User extends Authenticatable
{
    use HasRoles;
    
    /**
     * è·å–ç¼“å­˜çš„æƒé™åˆ—è¡¨
     */
    public function getCachedPermissions(): array
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        
        return Cache::remember($cacheKey, 3600, function () {
            return $this->getPermissionNames()->toArray();
        });
    }
    
    /**
     * æ¸…é™¤æƒé™ç¼“å­˜
     */
    public function clearPermissionCache(): void
    {
        $cacheKey = "user_permissions_{$this->id}_{$this->current_team_id}";
        Cache::forget($cacheKey);
    }
}
```

#### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```php
// âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨loadMissingé¿å…N+1æŸ¥è¯¢
public function getUserWithPermissions(int $userId): User
{
    $user = User::find($userId);
    $user->loadMissing(['roles', 'permissions', 'teams']);
    
    return $user;
}

// âŒ é¿å…ï¼šå¤šæ¬¡æŸ¥è¯¢
public function getUserWithPermissionsBad(int $userId): User
{
    $user = User::find($userId);
    $roles = $user->roles; // è§¦å‘æŸ¥è¯¢
    $permissions = $user->permissions; // è§¦å‘æŸ¥è¯¢
    $teams = $user->teams; // è§¦å‘æŸ¥è¯¢
    
    return $user;
}
```

### 3. å®‰å…¨æœ€ä½³å®è·µ

#### æ•æ„Ÿæ“ä½œåŒé‡éªŒè¯
```php
class CriticalOperationController extends Controller
{
    public function deleteCriticalData(Request $request)
    {
        // ç¬¬ä¸€å±‚ï¼šPolicyéªŒè¯
        $this->authorize('critical.delete');
        
        // ç¬¬äºŒå±‚ï¼šé¢å¤–çš„å®‰å…¨æ£€æŸ¥
        if (!$request->user()->hasVerifiedEmail()) {
            abort(403, 'éœ€è¦éªŒè¯é‚®ç®±åæ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œ');
        }
        
        // ç¬¬ä¸‰å±‚ï¼šæ“ä½œç¡®è®¤
        if ($request->input('confirmation') !== 'DELETE') {
            abort(400, 'è¯·è¾“å…¥ç¡®è®¤æ–‡æœ¬');
        }
        
        // æ‰§è¡Œåˆ é™¤æ“ä½œ...
    }
}
```

#### å®¡è®¡æ—¥å¿—è®°å½•
```php
class AuditLogger
{
    public static function logPermissionChange(User $user, string $action, array $details = [])
    {
        Log::channel('audit')->info('Permission change detected', [
            'user_id' => $user->id,
            'user_email' => $user->email,
            'action' => $action,
            'details' => $details,
            'ip_address' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'timestamp' => now(),
        ]);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
AuditLogger::logPermissionChange($user, 'role_assigned', [
    'role' => 'Production Manager',
    'team_id' => 1,
]);
```

---

## â“ å¸¸è§é—®é¢˜è§£å†³

### 1. æƒé™ä¸ç”Ÿæ•ˆé—®é¢˜

#### é—®é¢˜ï¼šç”¨æˆ·æœ‰æƒé™ä½†æ— æ³•è®¿é—®
```php
// æ£€æŸ¥æ¸…å•ï¼š
// 1. ç¡®è®¤å›¢é˜Ÿä¸Šä¸‹æ–‡æ˜¯å¦æ­£ç¡®è®¾ç½®
app(PermissionRegistrar::class)->setPermissionsTeamId($user->current_team_id);

// 2. æ¸…é™¤æƒé™ç¼“å­˜
$user->unsetRelation('roles')->unsetRelation('permissions');

// 3. æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜è®¾ç½®
if ($user->is_super_admin) {
    // è¶…çº§ç®¡ç†å‘˜åº”è¯¥é€šè¿‡Gate::beforeç»•è¿‡
}

// 4. éªŒè¯Policyä¸­çš„beforeæ–¹æ³•
public function before(User $user): ?bool
{
    return $user->is_super_admin ? true : null; // æ³¨æ„è¿”å›nullè€Œä¸æ˜¯false
}
```

### 2. å›¢é˜Ÿåˆ‡æ¢é—®é¢˜

#### é—®é¢˜ï¼šåˆ‡æ¢å›¢é˜Ÿåæƒé™ä¸æ›´æ–°
```php
// è§£å†³æ–¹æ¡ˆï¼šå®Œæ•´çš„å›¢é˜Ÿåˆ‡æ¢æµç¨‹
public function switchTeam(User $user, int $newTeamId): bool
{
    // 1. éªŒè¯ç”¨æˆ·å±äºæ–°å›¢é˜Ÿ
    if (!$user->teams()->where('teams.id', $newTeamId)->exists()) {
        return false;
    }
    
    // 2. æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜
    $user->unsetRelation('roles')->unsetRelation('permissions');
    Cache::forget("user_permissions_{$user->id}");
    Cache::forget("user_roles_{$user->id}");
    
    // 3. æ›´æ–°ç”¨æˆ·å½“å‰å›¢é˜Ÿ
    $user->update(['current_team_id' => $newTeamId]);
    
    // 4. è®¾ç½®æ–°çš„æƒé™ä¸Šä¸‹æ–‡
    app(PermissionRegistrar::class)->setPermissionsTeamId($newTeamId);
    
    return true;
}
```

### 3. æ€§èƒ½ä¼˜åŒ–é—®é¢˜

#### é—®é¢˜ï¼šæƒé™æ£€æŸ¥æ€§èƒ½å·®
```php
// ä¼˜åŒ–ç­–ç•¥ï¼š
// 1. å¯ç”¨æƒé™ç¼“å­˜
'cache' => [
    'expiration_time' => \DateInterval::createFromDateString('24 hours'),
    'key' => 'spatie.permission.cache',
    'model_key' => 'name',
    'store' => 'default',
],

// 2. ä½¿ç”¨é¢„åŠ è½½
$users = User::with(['roles.permissions', 'permissions'])->get();

// 3. æ‰¹é‡æƒé™æ£€æŸ¥
$permissions = ['orders.view', 'orders.create', 'orders.edit'];
$hasAllPermissions = $user->hasAllPermissions($permissions);

// 4. é¿å…åœ¨å¾ªç¯ä¸­æ£€æŸ¥æƒé™
$canEdit = $user->can('orders.edit');
foreach ($orders as $order) {
    if ($canEdit) {
        // å¤„ç†å¯ç¼–è¾‘é€»è¾‘
    }
}
```

### 4. è°ƒè¯•å·¥å…·

#### æƒé™è°ƒè¯•åŠ©æ‰‹
```php
class PermissionDebugger
{
    public static function debugUserPermissions(User $user): array
    {
        return [
            'user_id' => $user->id,
            'current_team_id' => $user->current_team_id,
            'is_super_admin' => $user->is_super_admin,
            'teams' => $user->teams()->pluck('name', 'id')->toArray(),
            'roles' => $user->roles()->pluck('name')->toArray(),
            'permissions' => $user->getPermissionNames()->toArray(),
            'permission_registrar_team_id' => app(PermissionRegistrar::class)->getPermissionsTeamId(),
        ];
    }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼ˆä»…åœ¨å¼€å‘ç¯å¢ƒï¼‰
if (config('app.debug')) {
    $debug = PermissionDebugger::debugUserPermissions(auth()->user());
    Log::debug('User permissions debug', $debug);
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

### Laravelå®˜æ–¹æ–‡æ¡£
- [Laravelè®¤è¯](https://laravel.com/docs/authentication)
- [Laravelæˆæƒ](https://laravel.com/docs/authorization)
- [Laravel Sanctum](https://laravel.com/docs/sanctum)

### Spatie Permissionæ–‡æ¡£
- [Spatie Permissionå®˜æ–¹æ–‡æ¡£](https://spatie.be/docs/laravel-permission/v6)
- [å›¢é˜ŸåŠŸèƒ½æŒ‡å—](https://spatie.be/docs/laravel-permission/v6/basic-usage/teams)

### é¡¹ç›®ç›¸å…³æ–‡æ¡£
- [å›¢é˜Ÿæƒé™ç³»ç»ŸæŒ‡å—](../æƒé™ä¸å›¢é˜Ÿç®¡ç†/13-å›¢é˜Ÿæƒé™ç³»ç»ŸæŒ‡å—.md)
- [APIå‚è€ƒæ–‡æ¡£](../æƒé™ä¸å›¢é˜Ÿç®¡ç†/04-APIå‚è€ƒ.md)
- [æœ€ä½³å®è·µæŒ‡å—](../æƒé™ä¸å›¢é˜Ÿç®¡ç†/08-æœ€ä½³å®è·µ.md)

---

**æœ€åæ›´æ–°**: 2025-01-10  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0 