# MES è®¤è¯ç³»ç»Ÿå®‰å…¨æŒ‡å—

æœ¬æ–‡æ¡£æä¾›MESè®¤è¯ç³»ç»Ÿçš„å®‰å…¨æœ€ä½³å®è·µï¼Œæ¶µç›–ä»¤ç‰Œå®‰å…¨ã€æƒé™ç®¡ç†ã€è¶…çº§ç®¡ç†å‘˜ç®¡ç†å’Œå®¡è®¡æ—¥å¿—ç­‰å…³é”®å®‰å…¨æªæ–½ã€‚

## ğŸ“‹ ç›®å½•
- [ä»¤ç‰Œå®‰å…¨å®è·µ](#ä»¤ç‰Œå®‰å…¨å®è·µ)
- [æƒé™åˆ†é…åŸåˆ™](#æƒé™åˆ†é…åŸåˆ™)
- [è¶…çº§ç®¡ç†å‘˜ç®¡ç†](#è¶…çº§ç®¡ç†å‘˜ç®¡ç†)
- [å®¡è®¡æ—¥å¿—è®¾ç½®](#å®¡è®¡æ—¥å¿—è®¾ç½®)
- [ç½‘ç»œå®‰å…¨é…ç½®](#ç½‘ç»œå®‰å…¨é…ç½®)
- [æ•°æ®ä¿æŠ¤ç­–ç•¥](#æ•°æ®ä¿æŠ¤ç­–ç•¥)
- [å®‰å…¨ç›‘æ§](#å®‰å…¨ç›‘æ§)
- [åº”æ€¥å“åº”](#åº”æ€¥å“åº”)

## ğŸ” ä»¤ç‰Œå®‰å…¨å®è·µ

### 1. Laravel Sanctum ä»¤ç‰Œé…ç½®

#### ä»¤ç‰Œç”Ÿå‘½å‘¨æœŸç®¡ç†
```env
# .env é…ç½®
SANCTUM_EXPIRATION=1440  # 24å°æ—¶ï¼ˆåˆ†é’Ÿï¼‰
SANCTUM_TOKEN_PREFIX=mes_
SANCTUM_GUARD=sanctum
```

#### ä»¤ç‰Œå®‰å…¨å­˜å‚¨
```php
// å‰ç«¯ä»¤ç‰Œå­˜å‚¨æœ€ä½³å®è·µ
// âœ… æ¨èï¼šå­˜å‚¨åœ¨httpOnly cookieä¸­
// âŒ é¿å…ï¼šå­˜å‚¨åœ¨localStorageæˆ–sessionStorage

// åç«¯é…ç½®
// config/sanctum.php
'expiration' => env('SANCTUM_EXPIRATION', 1440),
'token_prefix' => env('SANCTUM_TOKEN_PREFIX', 'mes_'),

'middleware' => [
    'verify_csrf_token' => App\Http\Middleware\VerifyCsrfToken::class,
    'encrypt_cookies' => App\Http\Middleware\EncryptCookies::class,
],
```

#### ä»¤ç‰Œæ’¤é”€ç­–ç•¥
```php
// 1. å•è®¾å¤‡ç™»å‡º
public function logout(Request $request)
{
    $request->user()->currentAccessToken()->delete();
    return response()->json(['message' => 'ç™»å‡ºæˆåŠŸ']);
}

// 2. å…¨è®¾å¤‡ç™»å‡º
public function logoutAll(Request $request) 
{
    $request->user()->tokens()->delete();
    return response()->json(['message' => 'å·²ä»æ‰€æœ‰è®¾å¤‡ç™»å‡º']);
}

// 3. å®šæœŸæ¸…ç†è¿‡æœŸä»¤ç‰Œ
// åœ¨å®šæ—¶ä»»åŠ¡ä¸­æ‰§è¡Œ
php artisan sanctum:prune-expired --hours=24
```

### 2. ä»¤ç‰Œä¼ è¾“å®‰å…¨

#### HTTPS å¼ºåˆ¶é…ç½®
```php
// app/Providers/AppServiceProvider.php
public function boot()
{
    if (app()->environment('production')) {
        URL::forceScheme('https');
    }
}
```

#### CORS å®‰å…¨é…ç½®
```php
// config/cors.php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => [
        'https://yourcompany.com',
        'https://www.yourcompany.com',
    ],
    'allowed_origins_patterns' => [],
    'allowed_headers' => ['*'],
    'exposed_headers' => [],
    'max_age' => 0,
    'supports_credentials' => true,
];
```

### 3. ä¼šè¯å®‰å…¨é…ç½®

```env
# å®‰å…¨ä¼šè¯é…ç½®
SESSION_DRIVER=redis
SESSION_LIFETIME=120
SESSION_ENCRYPT=true
SESSION_SECURE_COOKIES=true
SESSION_SAME_SITE=strict
SESSION_HTTP_ONLY=true
```

---

## ğŸ‘¥ æƒé™åˆ†é…åŸåˆ™

### 1. æœ€å°æƒé™åŸåˆ™

#### æƒé™åˆ†çº§è®¾è®¡
```php
// æƒé™å‘½åçº¦å®š
'{team_name}.{resource}.{action}'

// ç¤ºä¾‹æƒé™çº§åˆ«
'orders.view'         // æŸ¥çœ‹è®¢å•
'orders.create'       // åˆ›å»ºè®¢å•
'orders.edit'         // ç¼–è¾‘è®¢å•
'orders.delete'       // åˆ é™¤è®¢å•
'orders.manage'       // å®Œæ•´ç®¡ç†æƒé™

'teams.members.view'  // æŸ¥çœ‹å›¢é˜Ÿæˆå‘˜
'teams.members.add'   // æ·»åŠ å›¢é˜Ÿæˆå‘˜
'teams.members.remove' // ç§»é™¤å›¢é˜Ÿæˆå‘˜
```

#### è§’è‰²æƒé™çŸ©é˜µ
```php
// database/seeders/RolePermissionSeeder.php
class RolePermissionSeeder extends Seeder
{
    public function run()
    {
        $roles = [
            'operator' => [
                'orders.view',
                'orders.create',
                'production.view',
                'quality.basic',
            ],
            'supervisor' => [
                'orders.*',
                'production.*',
                'quality.*',
                'users.view',
            ],
            'manager' => [
                'orders.*',
                'production.*',
                'quality.*',
                'users.*',
                'teams.view',
                'reports.*',
            ],
            'team_admin' => [
                'teams.*',
                'users.*',
                'roles.*',
                // ä¸åŒ…å«è¶…çº§ç®¡ç†å‘˜æƒé™
            ],
        ];
        
        foreach ($roles as $roleName => $permissions) {
            $role = Role::findByName($roleName);
            $role->syncPermissions($permissions);
        }
    }
}
```

### 2. å›¢é˜Ÿéš”ç¦»å®‰å…¨

#### å›¢é˜Ÿä¸Šä¸‹æ–‡éªŒè¯
```php
// app/Policies/BasePolicy.php
abstract class BasePolicy
{
    protected function ensureTeamContext(User $user): bool
    {
        // éªŒè¯ç”¨æˆ·å±äºå½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡
        if (!$user->current_team_id) {
            return false;
        }
        
        $userBelongsToTeam = $user->teams()
            ->where('teams.id', $user->current_team_id)
            ->exists();
            
        return $userBelongsToTeam;
    }
    
    protected function setPermissionTeamContext(User $user): void
    {
        app(PermissionRegistrar::class)
            ->setPermissionsTeamId($user->current_team_id);
    }
}
```

#### æ•°æ®è®¿é—®æ§åˆ¶
```php
// æ‰€æœ‰æ¨¡å‹æŸ¥è¯¢å¿…é¡»åŒ…å«å›¢é˜Ÿè¿‡æ»¤
class OrderController extends Controller
{
    public function index(Request $request)
    {
        $this->authorize('view', Order::class);
        
        // ç¡®ä¿åªèƒ½æŸ¥çœ‹å½“å‰å›¢é˜Ÿçš„è®¢å•
        $orders = Order::where('team_id', auth()->user()->current_team_id)
            ->paginate(15);
            
        return OrderResource::collection($orders);
    }
}
```

### 3. æƒé™éªŒè¯ä¸­é—´ä»¶

```php
// app/Http/Middleware/EnsureTeamPermission.php
class EnsureTeamPermission
{
    public function handle($request, Closure $next, $permission)
    {
        $user = auth()->user();
        
        if (!$user || !$user->current_team_id) {
            abort(403, 'éœ€è¦è®¾ç½®å½“å‰å›¢é˜Ÿä¸Šä¸‹æ–‡');
        }
        
        // è®¾ç½®æƒé™æ£€æŸ¥çš„å›¢é˜Ÿä¸Šä¸‹æ–‡
        app(PermissionRegistrar::class)
            ->setPermissionsTeamId($user->current_team_id);
            
        if (!$user->hasPermissionTo($permission)) {
            abort(403, 'æƒé™ä¸è¶³');
        }
        
        return $next($request);
    }
}
```

---

## ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜ç®¡ç†

### 1. è¶…çº§ç®¡ç†å‘˜æ¶æ„

#### Gate::before é…ç½®
```php
// app/Providers/AuthServiceProvider.php
public function boot()
{
    Gate::before(function (User $user, string $ability) {
        if ($user->is_super_admin) {
            return true;
        }
        
        return null; // ç»§ç»­æ­£å¸¸æƒé™æ£€æŸ¥
    });
}
```

#### è¶…çº§ç®¡ç†å‘˜å­—æ®µç®¡ç†
```php
// database/migrations/add_is_super_admin_to_users_table.php
Schema::table('users', function (Blueprint $table) {
    $table->boolean('is_super_admin')->default(false);
    $table->timestamp('super_admin_granted_at')->nullable();
    $table->unsignedBigInteger('super_admin_granted_by')->nullable();
    
    $table->foreign('super_admin_granted_by')
          ->references('id')->on('users')
          ->onDelete('set null');
});
```

### 2. è¶…çº§ç®¡ç†å‘˜å®‰å…¨æªæ–½

#### è®¿é—®æ—¥å¿—è®°å½•
```php
// app/Http/Middleware/LogSuperAdminAccess.php
class LogSuperAdminAccess
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        
        $user = auth()->user();
        if ($user && $user->is_super_admin) {
            Log::channel('security')->info('Super admin access', [
                'user_id' => $user->id,
                'email' => $user->email,
                'ip' => $request->ip(),
                'user_agent' => $request->userAgent(),
                'method' => $request->method(),
                'url' => $request->fullUrl(),
                'timestamp' => now(),
            ]);
        }
        
        return $response;
    }
}
```

#### è¶…çº§ç®¡ç†å‘˜æƒé™æˆäºˆ
```php
// app/Services/SuperAdminService.php
class SuperAdminService
{
    public function grantSuperAdmin(User $targetUser, User $grantedBy): bool
    {
        // åªæœ‰ç°æœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥æˆäºˆæƒé™
        if (!$grantedBy->is_super_admin) {
            throw new UnauthorizedException('åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥æˆäºˆæ­¤æƒé™');
        }
        
        DB::transaction(function () use ($targetUser, $grantedBy) {
            $targetUser->update([
                'is_super_admin' => true,
                'super_admin_granted_at' => now(),
                'super_admin_granted_by' => $grantedBy->id,
            ]);
            
            // è®°å½•å®‰å…¨æ—¥å¿—
            Log::channel('security')->warning('Super admin granted', [
                'target_user_id' => $targetUser->id,
                'target_user_email' => $targetUser->email,
                'granted_by_user_id' => $grantedBy->id,
                'granted_by_email' => $grantedBy->email,
                'timestamp' => now(),
            ]);
        });
        
        return true;
    }
    
    public function revokeSuperAdmin(User $targetUser, User $revokedBy): bool
    {
        if (!$revokedBy->is_super_admin) {
            throw new UnauthorizedException('åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä»¥æ’¤é”€æ­¤æƒé™');
        }
        
        if ($targetUser->id === $revokedBy->id) {
            throw new InvalidOperationException('ä¸èƒ½æ’¤é”€è‡ªå·±çš„è¶…çº§ç®¡ç†å‘˜æƒé™');
        }
        
        $targetUser->update([
            'is_super_admin' => false,
            'super_admin_granted_at' => null,
            'super_admin_granted_by' => null,
        ]);
        
        // è®°å½•å®‰å…¨æ—¥å¿—
        Log::channel('security')->warning('Super admin revoked', [
            'target_user_id' => $targetUser->id,
            'target_user_email' => $targetUser->email,
            'revoked_by_user_id' => $revokedBy->id,
            'revoked_by_email' => $revokedBy->email,
            'timestamp' => now(),
        ]);
        
        return true;
    }
}
```

### 3. è¶…çº§ç®¡ç†å‘˜ç›‘æ§

#### å®šæœŸå®¡è®¡
```php
// app/Console/Commands/AuditSuperAdmins.php
class AuditSuperAdmins extends Command
{
    protected $signature = 'audit:super-admins';
    
    public function handle()
    {
        $superAdmins = User::where('is_super_admin', true)->get();
        
        foreach ($superAdmins as $admin) {
            Log::channel('audit')->info('Super admin audit', [
                'user_id' => $admin->id,
                'email' => $admin->email,
                'granted_at' => $admin->super_admin_granted_at,
                'last_login' => $admin->last_login_at,
                'team_count' => $admin->teams()->count(),
            ]);
        }
        
        // å‘é€å®¡è®¡æŠ¥å‘Šé‚®ä»¶
        $this->sendAuditReport($superAdmins);
    }
}
```

---

## ğŸ“Š å®¡è®¡æ—¥å¿—è®¾ç½®

### 1. æ—¥å¿—é€šé“é…ç½®

```php
// config/logging.php
'channels' => [
    'security' => [
        'driver' => 'daily',
        'path' => storage_path('logs/security.log'),
        'level' => 'debug',
        'days' => 90,
        'permission' => 0644,
    ],
    
    'audit' => [
        'driver' => 'daily', 
        'path' => storage_path('logs/audit.log'),
        'level' => 'info',
        'days' => 365,
        'permission' => 0644,
    ],
    
    'authentication' => [
        'driver' => 'daily',
        'path' => storage_path('logs/auth.log'),
        'level' => 'info', 
        'days' => 180,
        'permission' => 0644,
    ],
],
```

### 2. è®¤è¯äº‹ä»¶ç›‘å¬

```php
// app/Listeners/LogAuthenticationEvents.php
class LogAuthenticationEvents
{
    public function handleLogin(Login $event)
    {
        Log::channel('authentication')->info('User login', [
            'user_id' => $event->user->id,
            'email' => $event->user->email,
            'ip' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'timestamp' => now(),
        ]);
    }
    
    public function handleLogout(Logout $event)
    {
        Log::channel('authentication')->info('User logout', [
            'user_id' => $event->user->id,
            'email' => $event->user->email,
            'ip' => request()->ip(),
            'timestamp' => now(),
        ]);
    }
    
    public function handleFailed(Failed $event)
    {
        Log::channel('security')->warning('Login failed', [
            'email' => $event->credentials['email'] ?? 'unknown',
            'ip' => request()->ip(),
            'user_agent' => request()->userAgent(),
            'timestamp' => now(),
        ]);
    }
}
```

### 3. æƒé™å˜æ›´å®¡è®¡

```php
// app/Observers/UserObserver.php
class UserObserver
{
    public function updated(User $user)
    {
        $changes = $user->getChanges();
        
        // è®°å½•æƒé™ç›¸å…³å˜æ›´
        if (array_key_exists('is_super_admin', $changes)) {
            Log::channel('audit')->warning('Super admin status changed', [
                'user_id' => $user->id,
                'email' => $user->email,
                'old_value' => $user->getOriginal('is_super_admin'),
                'new_value' => $changes['is_super_admin'],
                'changed_by' => auth()->id(),
                'timestamp' => now(),
            ]);
        }
        
        if (array_key_exists('current_team_id', $changes)) {
            Log::channel('audit')->info('Team switched', [
                'user_id' => $user->id,
                'email' => $user->email,
                'old_team_id' => $user->getOriginal('current_team_id'),
                'new_team_id' => $changes['current_team_id'],
                'timestamp' => now(),
            ]);
        }
    }
}
```

### 4. æ•æ„Ÿæ“ä½œå®¡è®¡

```php
// app/Http/Middleware/AuditSensitiveOperations.php
class AuditSensitiveOperations
{
    protected $sensitiveRoutes = [
        'api.users.store',
        'api.users.destroy',
        'api.roles.store',
        'api.permissions.store',
        'api.teams.store',
        'api.teams.destroy',
    ];
    
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        
        $routeName = $request->route()->getName();
        
        if (in_array($routeName, $this->sensitiveRoutes)) {
            Log::channel('audit')->info('Sensitive operation', [
                'user_id' => auth()->id(),
                'route' => $routeName,
                'method' => $request->method(),
                'parameters' => $request->except(['password', 'password_confirmation']),
                'ip' => $request->ip(),
                'status_code' => $response->status(),
                'timestamp' => now(),
            ]);
        }
        
        return $response;
    }
}
```

---

## ğŸŒ ç½‘ç»œå®‰å…¨é…ç½®

### 1. é˜²ç«å¢™è§„åˆ™

```bash
# UFW åŸºç¡€é…ç½®
sudo ufw --force reset
sudo ufw default deny incoming
sudo ufw default allow outgoing

# å…è®¸SSHï¼ˆé™åˆ¶IPï¼‰
sudo ufw allow from 192.168.1.0/24 to any port 22

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å…è®¸å†…éƒ¨æ•°æ®åº“è¿æ¥
sudo ufw allow from 10.0.0.0/8 to any port 5432
sudo ufw allow from 10.0.0.0/8 to any port 6379

# å¯ç”¨é˜²ç«å¢™
sudo ufw --force enable
sudo ufw status verbose
```

### 2. Nginx å®‰å…¨é…ç½®

```nginx
# /etc/nginx/sites-available/mes-api
server {
    listen 443 ssl http2;
    server_name mes-api.yourcompany.com;
    
    # SSL é…ç½®
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # é™åˆ¶è¯·æ±‚å¤§å°
    client_max_body_size 10M;
    
    # é€Ÿç‡é™åˆ¶
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req zone=api burst=20 nodelay;
    
    # éšè—ç‰ˆæœ¬ä¿¡æ¯
    server_tokens off;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        
        # å®‰å…¨è®¾ç½®
        fastcgi_hide_header X-Powered-By;
        fastcgi_read_timeout 300;
    }
    
    # æ‹’ç»è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~ /\.(?!well-known).* {
        deny all;
    }
    
    location ~ /storage/logs {
        deny all;
    }
}
```

### 3. IP ç™½åå•é…ç½®

```php
// app/Http/Middleware/IpWhitelist.php
class IpWhitelist
{
    protected $allowedIps = [
        '192.168.1.0/24',    // å†…ç½‘
        '10.0.0.0/8',        // VPN
        '203.0.113.0/24',    // åŠå…¬ç½‘ç»œ
    ];
    
    public function handle($request, Closure $next)
    {
        $clientIp = $request->ip();
        
        if (!$this->isIpAllowed($clientIp)) {
            Log::channel('security')->warning('IP blocked', [
                'ip' => $clientIp,
                'url' => $request->fullUrl(),
                'user_agent' => $request->userAgent(),
            ]);
            
            abort(403, 'è®¿é—®è¢«æ‹’ç»');
        }
        
        return $next($request);
    }
    
    private function isIpAllowed($ip): bool
    {
        foreach ($this->allowedIps as $allowedIp) {
            if ($this->ipInRange($ip, $allowedIp)) {
                return true;
            }
        }
        
        return false;
    }
}
```

---

## ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ç­–ç•¥

### 1. æ•°æ®åŠ å¯†

#### æ•æ„Ÿå­—æ®µåŠ å¯†
```php
// app/Models/User.php
class User extends Authenticatable
{
    use HasApiTokens, HasRoles, SoftDeletes;
    
    protected $fillable = [
        'name', 'email', 'phone', 'address',
    ];
    
    protected $hidden = [
        'password', 'remember_token',
    ];
    
    protected $casts = [
        'email_verified_at' => 'datetime',
        'last_login_at' => 'datetime',
        'phone' => 'encrypted',        // è‡ªåŠ¨åŠ å¯†
        'address' => 'encrypted',      // è‡ªåŠ¨åŠ å¯†
    ];
}
```

#### æ•°æ®åº“åŠ å¯†è®¾ç½®
```sql
-- PostgreSQL æ•°æ®åº“çº§åŠ å¯†
-- å¯ç”¨ pgcrypto æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åˆ›å»ºåŠ å¯†è§†å›¾
CREATE VIEW encrypted_user_data AS
SELECT 
    id,
    email,
    pgp_sym_decrypt(phone::bytea, 'encryption_key') as phone,
    pgp_sym_decrypt(address::bytea, 'encryption_key') as address
FROM users;
```

### 2. å¤‡ä»½å®‰å…¨

```bash
#!/bin/bash
# scripts/secure_backup.sh

# æ•°æ®åº“å¤‡ä»½åŠ å¯†
pg_dump mes_production | gpg --cipher-algo AES256 --compress-algo 1 \
  --symmetric --output "/backup/db_$(date +%Y%m%d_%H%M%S).sql.gpg"

# æ–‡ä»¶å¤‡ä»½åŠ å¯†
tar -czf - /var/www/mes-backend/storage | \
  gpg --cipher-algo AES256 --compress-algo 1 --symmetric \
  --output "/backup/files_$(date +%Y%m%d_%H%M%S).tar.gz.gpg"

# æ¸…ç†30å¤©å‰çš„å¤‡ä»½
find /backup -name "*.gpg" -mtime +30 -delete

# å¤‡ä»½å®Œæ•´æ€§éªŒè¯
for file in /backup/*.gpg; do
    if ! gpg --decrypt "$file" > /dev/null 2>&1; then
        echo "Backup verification failed: $file" | \
        mail -s "Backup Alert" admin@yourcompany.com
    fi
done
```

### 3. æ•°æ®è„±æ•

```php
// app/Console/Commands/AnonymizeData.php
class AnonymizeData extends Command
{
    protected $signature = 'data:anonymize {--environment=staging}';
    
    public function handle()
    {
        if (app()->environment('production')) {
            $this->error('ä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œæ•°æ®è„±æ•');
            return 1;
        }
        
        DB::transaction(function () {
            // ç”¨æˆ·æ•°æ®è„±æ•
            User::where('is_super_admin', false)->chunk(100, function ($users) {
                foreach ($users as $user) {
                    $user->update([
                        'email' => 'user' . $user->id . '@example.com',
                        'phone' => '138****' . rand(1000, 9999),
                        'address' => 'æµ‹è¯•åœ°å€ ' . $user->id,
                    ]);
                }
            });
            
            $this->info('æ•°æ®è„±æ•å®Œæˆ');
        });
    }
}
```

---

## ğŸ“ˆ å®‰å…¨ç›‘æ§

### 1. å…¥ä¾µæ£€æµ‹

```php
// app/Services/SecurityMonitorService.php
class SecurityMonitorService
{
    public function detectSuspiciousActivity()
    {
        // æ£€æµ‹æš´åŠ›ç ´è§£
        $this->detectBruteForce();
        
        // æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼
        $this->detectAnomalousAccess();
        
        // æ£€æµ‹æƒé™æå‡
        $this->detectPrivilegeEscalation();
    }
    
    private function detectBruteForce()
    {
        $attempts = DB::table('failed_jobs')
            ->where('failed_at', '>', now()->subMinutes(15))
            ->whereJsonContains('payload->data->command', 'login')
            ->count();
            
        if ($attempts > 10) {
            $this->triggerAlert('bruteforce', [
                'attempts' => $attempts,
                'timeframe' => '15 minutes'
            ]);
        }
    }
    
    private function detectAnomalousAccess()
    {
        // æ£€æµ‹å¼‚å¸¸IPè®¿é—®
        $suspiciousIps = DB::table('audit_logs')
            ->select('ip', DB::raw('count(*) as access_count'))
            ->where('created_at', '>', now()->subHour())
            ->groupBy('ip')
            ->having('access_count', '>', 100)
            ->get();
            
        foreach ($suspiciousIps as $ip) {
            $this->triggerAlert('suspicious_ip', [
                'ip' => $ip->ip,
                'access_count' => $ip->access_count
            ]);
        }
    }
    
    private function triggerAlert($type, $data)
    {
        Log::channel('security')->emergency("Security alert: $type", $data);
        
        // å‘é€é€šçŸ¥
        Notification::route('mail', 'security@yourcompany.com')
            ->notify(new SecurityAlertNotification($type, $data));
    }
}
```

### 2. æ€§èƒ½ç›‘æ§æ•´åˆ

```php
// app/Http/Middleware/SecurityMetrics.php
class SecurityMetrics
{
    public function handle($request, Closure $next)
    {
        $startTime = microtime(true);
        
        $response = $next($request);
        
        $duration = microtime(true) - $startTime;
        
        // è®°å½•å®‰å…¨ç›¸å…³æŒ‡æ ‡
        $this->recordSecurityMetrics($request, $response, $duration);
        
        return $response;
    }
    
    private function recordSecurityMetrics($request, $response, $duration)
    {
        $user = auth()->user();
        
        $metrics = [
            'request_duration' => $duration,
            'response_status' => $response->status(),
            'user_id' => $user?->id,
            'is_super_admin' => $user?->is_super_admin ?? false,
            'team_id' => $user?->current_team_id,
            'endpoint' => $request->route()?->getName(),
            'method' => $request->method(),
            'ip' => $request->ip(),
        ];
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        app('metrics')->increment('api.requests', 1, $metrics);
        app('metrics')->histogram('api.duration', $duration, $metrics);
        
        // æ£€æµ‹å¼‚å¸¸
        if ($duration > 5.0) {
            Log::channel('security')->warning('Slow request detected', $metrics);
        }
    }
}
```

---

## ğŸš¨ åº”æ€¥å“åº”

### 1. å®‰å…¨äº‹ä»¶å“åº”æµç¨‹

#### è‡ªåŠ¨å“åº”æªæ–½
```php
// app/Services/IncidentResponseService.php
class IncidentResponseService
{
    public function handleSecurityIncident($type, $severity, $data)
    {
        switch ($severity) {
            case 'critical':
                $this->executeCriticalResponse($type, $data);
                break;
            case 'high':
                $this->executeHighResponse($type, $data);
                break;
            default:
                $this->executeStandardResponse($type, $data);
        }
    }
    
    private function executeCriticalResponse($type, $data)
    {
        // 1. ç«‹å³é€šçŸ¥
        $this->notifySecurityTeam($type, $data, 'critical');
        
        // 2. æ ¹æ®äº‹ä»¶ç±»å‹é‡‡å–è‡ªåŠ¨æªæ–½
        switch ($type) {
            case 'bruteforce':
                $this->blockSuspiciousIp($data['ip']);
                break;
            case 'privilege_escalation':
                $this->suspendUser($data['user_id']);
                break;
            case 'data_breach':
                $this->activateBreachProtocol();
                break;
        }
        
        // 3. è®°å½•è¯¦ç»†æ—¥å¿—
        Log::channel('security')->emergency('Critical security incident', [
            'type' => $type,
            'data' => $data,
            'response_actions' => $this->getExecutedActions(),
            'timestamp' => now(),
        ]);
    }
    
    private function blockSuspiciousIp($ip)
    {
        // æ·»åŠ åˆ°é»‘åå•
        SecurityBlacklist::create([
            'ip_address' => $ip,
            'reason' => 'Automated block - suspicious activity',
            'blocked_at' => now(),
            'expires_at' => now()->addHours(24),
        ]);
        
        // é€šçŸ¥ç³»ç»Ÿç®¡ç†å‘˜æ›´æ–°é˜²ç«å¢™è§„åˆ™
        $this->notifySystemAdmin("IP {$ip} has been blacklisted");
    }
}
```

### 2. æ•°æ®æ³„éœ²å¤„ç†

```php
// app/Services/DataBreachService.php
class DataBreachService
{
    public function handleDataBreach($scope, $affectedData)
    {
        // 1. ç«‹å³éš”ç¦»å—å½±å“ç³»ç»Ÿ
        $this->isolateAffectedSystems($scope);
        
        // 2. æ”¶é›†è¯æ®
        $evidence = $this->collectEvidence($affectedData);
        
        // 3. é€šçŸ¥ç›¸å…³æ–¹
        $this->notifyStakeholders($scope, $affectedData);
        
        // 4. å¼€å§‹æ¢å¤æµç¨‹
        $this->initiateRecovery($evidence);
        
        // 5. è®°å½•äº‹ä»¶
        $this->documentBreach($scope, $affectedData, $evidence);
    }
    
    private function isolateAffectedSystems($scope)
    {
        // æš‚åœå—å½±å“çš„APIæœåŠ¡
        if ($scope['api']) {
            Cache::put('api_maintenance_mode', true, now()->addHours(2));
        }
        
        // å¼ºåˆ¶é‡æ–°è®¤è¯æ‰€æœ‰ç”¨æˆ·
        if ($scope['auth']) {
            User::query()->update(['remember_token' => null]);
            DB::table('personal_access_tokens')->delete();
        }
    }
    
    private function notifyStakeholders($scope, $affectedData)
    {
        // é€šçŸ¥ç®¡ç†å±‚
        Notification::route('mail', 'management@yourcompany.com')
            ->notify(new DataBreachNotification($scope, $affectedData));
        
        // é€šçŸ¥ITå›¢é˜Ÿ
        Notification::route('mail', 'it@yourcompany.com')
            ->notify(new TechnicalBreachNotification($scope, $affectedData));
        
        // å¦‚æœæ¶‰åŠä¸ªäººæ•°æ®ï¼Œå‡†å¤‡ç”¨æˆ·é€šçŸ¥
        if ($affectedData['personal_data']) {
            $this->prepareUserNotifications($affectedData);
        }
    }
}
```

### 3. æ¢å¤è®¡åˆ’

```bash
#!/bin/bash
# scripts/disaster_recovery.sh

echo "å¼€å§‹æ‰§è¡Œç¾éš¾æ¢å¤æµç¨‹..."

# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
sudo systemctl stop nginx
sudo systemctl stop php8.2-fpm
sudo supervisorctl stop all

# 2. å¤‡ä»½å½“å‰çŠ¶æ€
mkdir -p /backup/disaster_recovery/$(date +%Y%m%d_%H%M%S)
cp -r /var/www/mes-backend /backup/disaster_recovery/$(date +%Y%m%d_%H%M%S)/

# 3. æ¢å¤æ•°æ®åº“
echo "æ­£åœ¨æ¢å¤æ•°æ®åº“..."
sudo -u postgres psql -c "DROP DATABASE IF EXISTS mes_production;"
sudo -u postgres psql -c "CREATE DATABASE mes_production;"
gunzip -c /backup/latest_clean_backup.sql.gz | sudo -u postgres psql mes_production

# 4. æ¢å¤åº”ç”¨æ–‡ä»¶
echo "æ­£åœ¨æ¢å¤åº”ç”¨æ–‡ä»¶..."
rsync -av /backup/clean_application/ /var/www/mes-backend/

# 5. é‡æ–°ç”Ÿæˆå®‰å…¨å¯†é’¥
cd /var/www/mes-backend
php artisan key:generate --force

# 6. æ¸…é™¤æ‰€æœ‰ç¼“å­˜
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# 7. é‡æ–°è®¾ç½®æƒé™
sudo chown -R mes:www-data /var/www/mes-backend
sudo chmod -R 755 /var/www/mes-backend
sudo chmod -R 775 /var/www/mes-backend/storage
sudo chmod -R 775 /var/www/mes-backend/bootstrap/cache

# 8. é‡å¯æœåŠ¡
sudo systemctl start php8.2-fpm
sudo systemctl start nginx
sudo supervisorctl start all

# 9. éªŒè¯ç³»ç»ŸçŠ¶æ€
php artisan migrate:status
php artisan queue:work --once
curl -f http://localhost/api/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"

echo "ç¾éš¾æ¢å¤æµç¨‹å®Œæˆ"
```

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

### æ—¥å¸¸å®‰å…¨æ£€æŸ¥
- [ ] æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜è´¦æˆ·æ´»åŠ¨
- [ ] å®¡æŸ¥æƒé™å˜æ›´æ—¥å¿—
- [ ] ç›‘æ§å¤±è´¥ç™»å½•å°è¯•
- [ ] éªŒè¯å¤‡ä»½å®Œæ•´æ€§
- [ ] æ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ
- [ ] å®¡æŸ¥é˜²ç«å¢™æ—¥å¿—
- [ ] ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
- [ ] æ£€æŸ¥åº”ç”¨ç¨‹åºé”™è¯¯æ—¥å¿—

### å‘¨æœŸæ€§å®‰å…¨å®¡è®¡
- [ ] æƒé™åˆ†é…å®¡è®¡
- [ ] ç”¨æˆ·è´¦æˆ·æ¸…ç†
- [ ] å®‰å…¨è¡¥ä¸æ›´æ–°
- [ ] æ¸—é€æµ‹è¯•
- [ ] ä»£ç å®‰å…¨å®¡æŸ¥
- [ ] ç¬¬ä¸‰æ–¹ä¾èµ–æ›´æ–°
- [ ] ç¾éš¾æ¢å¤æ¼”ç»ƒ
- [ ] å®‰å…¨åŸ¹è®­æ›´æ–°

### åˆè§„æ€§æ£€æŸ¥
- [ ] æ•°æ®ä¿æŠ¤åˆè§„æ€§
- [ ] å®¡è®¡æ—¥å¿—ä¿ç•™ç­–ç•¥
- [ ] åŠ å¯†æ ‡å‡†éµå¾ª
- [ ] è®¿é—®æ§åˆ¶å®¡æŸ¥
- [ ] äº‹ä»¶å“åº”èƒ½åŠ›æµ‹è¯•

## ğŸ“ è”ç³»ä¿¡æ¯

**å®‰å…¨äº‹ä»¶æŠ¥å‘Š**ï¼š
- é‚®ç®±ï¼šsecurity@yourcompany.com
- ç”µè¯ï¼š+86-xxx-xxxx-xxxxï¼ˆ24å°æ—¶ï¼‰
- ä¼ä¸šå¾®ä¿¡ï¼šå®‰å…¨åº”æ€¥ç¾¤

**æŠ€æœ¯æ”¯æŒ**ï¼š
- é‚®ç®±ï¼šit-support@yourcompany.com
- å†…éƒ¨å·¥å•ç³»ç»Ÿï¼šhttps://helpdesk.yourcompany.com

**ç®¡ç†å±‚é€šçŸ¥**ï¼š
- CTOï¼šcto@yourcompany.com
- CISOï¼šciso@yourcompany.com

---

*æœ¬å®‰å…¨æŒ‡å—åº”å®šæœŸæ›´æ–°ï¼Œç¡®ä¿ä¸æœ€æ–°çš„å®‰å…¨å¨èƒå’Œæœ€ä½³å®è·µä¿æŒåŒæ­¥ã€‚* 