# MES è®¤è¯ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›MESè®¤è¯ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²æŒ‡å¯¼ï¼ŒåŒ…æ‹¬ç¯å¢ƒé…ç½®ã€æ•°æ®åº“è¿ç§»ã€æ€§èƒ½è°ƒä¼˜å’Œå®‰å…¨è®¾ç½®çš„å®Œæ•´æ¸…å•ã€‚

## ğŸ“‹ ç›®å½•
- [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
- [ç¯å¢ƒå˜é‡é…ç½®](#ç¯å¢ƒå˜é‡é…ç½®)
- [æ•°æ®åº“è¿ç§»å’Œåˆå§‹åŒ–](#æ•°æ®åº“è¿ç§»å’Œåˆå§‹åŒ–)
- [æƒé™ç³»ç»Ÿé…ç½®](#æƒé™ç³»ç»Ÿé…ç½®)
- [æ€§èƒ½ä¼˜åŒ–é…ç½®](#æ€§èƒ½ä¼˜åŒ–é…ç½®)
- [å®‰å…¨è®¾ç½®](#å®‰å…¨è®¾ç½®)
- [éƒ¨ç½²éªŒè¯](#éƒ¨ç½²éªŒè¯)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)

## ğŸ”§ éƒ¨ç½²å‰å‡†å¤‡

### 1. ç³»ç»Ÿè¦æ±‚æ£€æŸ¥

#### æœåŠ¡å™¨è§„æ ¼è¦æ±‚
```bash
# æœ€å°é…ç½®
CPU: 2æ ¸
å†…å­˜: 4GB
å­˜å‚¨: 50GB SSD
ç½‘ç»œ: 100Mbps

# æ¨èé…ç½®  
CPU: 4æ ¸
å†…å­˜: 8GB
å­˜å‚¨: 100GB SSD
ç½‘ç»œ: 1Gbps
```

#### è½¯ä»¶ç‰ˆæœ¬è¦æ±‚
```bash
# æ£€æŸ¥PHPç‰ˆæœ¬ (éœ€è¦8.2+)
php -v

# æ£€æŸ¥å¿…éœ€æ‰©å±•
php -m | grep -E "(pgsql|redis|bcmath|mbstring|openssl|tokenizer|xml)"

# æ£€æŸ¥PostgreSQLç‰ˆæœ¬ (éœ€è¦13+)
psql --version

# æ£€æŸ¥Redisç‰ˆæœ¬ (éœ€è¦6.0+)
redis-cli --version
```

### 2. æƒé™å’Œç›®å½•å‡†å¤‡

```bash
# åˆ›å»ºåº”ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash mes
sudo usermod -a -G www-data mes

# åˆ›å»ºåº”ç”¨ç›®å½•ç»“æ„
sudo mkdir -p /var/www/mes-backend/{storage,bootstrap/cache}
sudo chown -R mes:www-data /var/www/mes-backend
sudo chmod -R 755 /var/www/mes-backend
sudo chmod -R 775 /var/www/mes-backend/storage
sudo chmod -R 775 /var/www/mes-backend/bootstrap/cache
```

### 3. æ•°æ®åº“å‡†å¤‡

```bash
# åˆ›å»ºç”Ÿäº§æ•°æ®åº“
sudo -u postgres psql
CREATE DATABASE mes_production;
CREATE USER mes_user WITH PASSWORD 'secure-password';
GRANT ALL PRIVILEGES ON DATABASE mes_production TO mes_user;
\q

# åˆ›å»ºRedisæ•°æ®åº“é…ç½®
# ç¼–è¾‘ /etc/redis/redis.conf
requirepass your-redis-password
maxmemory 512mb
maxmemory-policy allkeys-lru
```

---

## ğŸŒ ç¯å¢ƒå˜é‡é…ç½®

### 1. è®¤è¯ç³»ç»Ÿæ ¸å¿ƒé…ç½®

åˆ›å»º `/var/www/mes-backend/.env.production`ï¼š

```env
# åº”ç”¨åŸºç¡€é…ç½®
APP_NAME="MESåç«¯ç³»ç»Ÿ"
APP_ENV=production
APP_KEY=base64:your-generated-app-key
APP_DEBUG=false
APP_URL=https://mes-api.yourcompany.com
APP_TIMEZONE=Asia/Shanghai

# æ•°æ®åº“é…ç½®
DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=mes_production
DB_USERNAME=mes_user
DB_PASSWORD=your-secure-db-password

# Redisé…ç½® (ç”¨äºç¼“å­˜ã€ä¼šè¯ã€é˜Ÿåˆ—)
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=your-redis-password
REDIS_PORT=6379
REDIS_DB=0

# ä¼šè¯é…ç½®
SESSION_DRIVER=redis
SESSION_LIFETIME=120
SESSION_ENCRYPT=true
SESSION_PATH=/
SESSION_DOMAIN=.yourcompany.com
SESSION_SECURE_COOKIES=true

# ç¼“å­˜é…ç½®
CACHE_DRIVER=redis
CACHE_PREFIX=mes_auth

# é˜Ÿåˆ—é…ç½®
QUEUE_CONNECTION=redis
QUEUE_FAILED_DRIVER=database-uuids

# Laravel Sanctumé…ç½®
SANCTUM_STATEFUL_DOMAINS=yourcompany.com,www.yourcompany.com,127.0.0.1,localhost
SANCTUM_GUARD=sanctum
SANCTUM_EXPIRATION=null
SANCTUM_TOKEN_PREFIX=mes_

# Spatie Permissioné…ç½®
PERMISSION_CACHE_EXPIRATION_TIME=86400
PERMISSION_CACHE_KEY=spatie.permission.cache
PERMISSION_CACHE_STORE=redis

# æ—¥å¿—é…ç½®
LOG_CHANNEL=stack
LOG_STACK=single,daily
LOG_LEVEL=warning
LOG_DAYS=14

# é‚®ä»¶é…ç½® (ç”¨äºé‡ç½®å¯†ç ç­‰)
MAIL_MAILER=smtp
MAIL_HOST=smtp.yourcompany.com
MAIL_PORT=587
MAIL_USERNAME=noreply@yourcompany.com
MAIL_PASSWORD=your-mail-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@yourcompany.com
MAIL_FROM_NAME="MESç³»ç»Ÿ"

# æ€§èƒ½ç›‘æ§é…ç½®
TELESCOPE_ENABLED=false
HORIZON_ENABLED=true
```

### 2. ç¯å¢ƒé…ç½®éªŒè¯

```bash
# éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
php artisan config:show

# æµ‹è¯•æ•°æ®åº“è¿æ¥
php artisan tinker
DB::connection()->getPdo();

# æµ‹è¯•Redisè¿æ¥
php artisan tinker
Cache::store('redis')->put('test', 'value', 60);
Cache::store('redis')->get('test');
```

---

## ğŸ—„ï¸ æ•°æ®åº“è¿ç§»å’Œåˆå§‹åŒ–

### 1. æ•°æ®åº“è¿ç§»æ‰§è¡Œ

```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
cd /var/www/mes-backend

# è¿è¡Œè¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦ç¡®è®¤ï¼‰
php artisan migrate --force

# éªŒè¯è¿ç§»çŠ¶æ€
php artisan migrate:status
```

### 2. æƒé™ç³»ç»Ÿåˆå§‹åŒ–

```bash
# è¿è¡Œæƒé™å’Œè§’è‰²æ•°æ®å¡«å……
php artisan db:seed --class=PermissionSeeder --force
php artisan db:seed --class=RoleSeeder --force
php artisan db:seed --class=ModulePermissionSeeder --force

# åˆ›å»ºè¶…çº§ç®¡ç†å‘˜ç”¨æˆ·
php artisan db:seed --class=SuperAdminSeeder --force

# åˆ›å»ºç¤ºä¾‹å›¢é˜Ÿå’Œç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
php artisan db:seed --class=TeamSeeder --force
php artisan db:seed --class=UserSeeder --force
```

### 3. æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

```sql
-- åœ¨psqlä¸­æ‰§è¡Œä»¥ä¸‹ä¼˜åŒ–
\c mes_production

-- ä¸ºè®¤è¯ç›¸å…³è¡¨æ·»åŠ æ€§èƒ½ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_users_email ON users(email);
CREATE INDEX CONCURRENTLY idx_users_work_no ON users(work_no);
CREATE INDEX CONCURRENTLY idx_users_phone ON users(phone);
CREATE INDEX CONCURRENTLY idx_users_current_team_id ON users(current_team_id);
CREATE INDEX CONCURRENTLY idx_users_status ON users(status);

-- ä¸ºæƒé™ç³»ç»Ÿæ·»åŠ ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_model_has_permissions_model ON model_has_permissions(model_type, model_id);
CREATE INDEX CONCURRENTLY idx_model_has_roles_model ON model_has_roles(model_type, model_id);
CREATE INDEX CONCURRENTLY idx_role_has_permissions_role ON role_has_permissions(role_id);

-- ä¸ºå›¢é˜Ÿç³»ç»Ÿæ·»åŠ ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_team_user_team_id ON team_user(team_id);
CREATE INDEX CONCURRENTLY idx_team_user_user_id ON team_user(user_id);

-- ä¸ºè®¿é—®ä»¤ç‰Œæ·»åŠ ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_personal_access_tokens_tokenable ON personal_access_tokens(tokenable_type, tokenable_id);
CREATE INDEX CONCURRENTLY idx_personal_access_tokens_token ON personal_access_tokens(token);
```

---

## ğŸ” æƒé™ç³»ç»Ÿé…ç½®

### 1. Spatie Permissioné…ç½®

ç¼–è¾‘ `config/permission.php`ï¼š

```php
<?php

return [
    'models' => [
        'permission' => Spatie\Permission\Models\Permission::class,
        'role' => Spatie\Permission\Models\Role::class,
    ],

    'table_names' => [
        'roles' => 'roles',
        'permissions' => 'permissions',
        'model_has_permissions' => 'model_has_permissions',
        'model_has_roles' => 'model_has_roles',
        'role_has_permissions' => 'role_has_permissions',
    ],

    'column_names' => [
        'role_pivot_key' => null,
        'permission_pivot_key' => null,
        'model_morph_key' => 'model_id',
        'team_foreign_key' => 'team_id',
    ],

    'register_permission_check_method' => true,
    'register_octane_reset_listener' => false,

    'teams' => true, // å¯ç”¨å›¢é˜Ÿæ”¯æŒ

    'use_passport_client_credentials' => false,

    'display_permission_in_exception' => false,
    'display_role_in_exception' => false,

    'enable_wildcard_permission' => false,

    'cache' => [
        'expiration_time' => \DateInterval::createFromDateString('24 hours'),
        'key' => 'spatie.permission.cache',
        'store' => 'redis', // ä½¿ç”¨Redisç¼“å­˜
    ],
];
```

### 2. è®¤è¯é…ç½®

ç¼–è¾‘ `config/auth.php`ï¼š

```php
<?php

return [
    'defaults' => [
        'guard' => 'sanctum',
        'passwords' => 'users',
    ],

    'guards' => [
        'web' => [
            'driver' => 'session',
            'provider' => 'users',
        ],
        'sanctum' => [
            'driver' => 'sanctum',
            'provider' => 'users',
        ],
    ],

    'providers' => [
        'users' => [
            'driver' => 'eloquent',
            'model' => App\Models\User::class,
        ],
    ],

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table' => 'password_reset_tokens',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],

    'password_timeout' => 10800,
];
```

### 3. Sanctumé…ç½®

ç¼–è¾‘ `config/sanctum.php`ï¼š

```php
<?php

return [
    'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', sprintf(
        '%s%s',
        'localhost,localhost:3000,127.0.0.1,127.0.0.1:8000,::1',
        Str::startsWith(app()->environment(), 'local') ? ','.parse_url(env('APP_URL'), PHP_URL_HOST) : ''
    ))),

    'guard' => ['sanctum'],

    'expiration' => null, // Tokenæ°¸ä¸è¿‡æœŸï¼Œç”±ä¸šåŠ¡é€»è¾‘æ§åˆ¶

    'token_prefix' => env('SANCTUM_TOKEN_PREFIX', ''),

    'middleware' => [
        'authenticate_session' => Laravel\Sanctum\Http\Middleware\AuthenticateSession::class,
        'encrypt_cookies' => App\Http\Middleware\EncryptCookies::class,
        'verify_csrf_token' => App\Http\Middleware\VerifyCsrfToken::class,
    ],
];
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

### 1. PHPä¼˜åŒ–

ç¼–è¾‘ `/etc/php/8.2/fpm/pool.d/www.conf`ï¼š

```ini
; è¿›ç¨‹ç®¡ç†
pm = dynamic
pm.max_children = 50
pm.start_servers = 10
pm.min_spare_servers = 5
pm.max_spare_servers = 15
pm.max_requests = 500

; æ€§èƒ½ä¼˜åŒ–
request_terminate_timeout = 30s
request_slowlog_timeout = 10s
slowlog = /var/log/php8.2-fpm-slow.log

; å®‰å…¨è®¾ç½®
security.limit_extensions = .php
```

ç¼–è¾‘ `/etc/php/8.2/fpm/php.ini`ï¼š

```ini
; å†…å­˜é™åˆ¶
memory_limit = 256M
max_execution_time = 30
max_input_time = 60

; æ–‡ä»¶ä¸Šä¼ 
upload_max_filesize = 10M
post_max_size = 10M
max_file_uploads = 20

; OPcacheä¼˜åŒ–
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=60
opcache.fast_shutdown=1

; APCuç”¨æˆ·ç¼“å­˜
apc.enabled=1
apc.enable_cli=1
apc.shm_size=64M
```

### 2. Nginxé…ç½®

åˆ›å»º `/etc/nginx/sites-available/mes-backend`ï¼š

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name mes-api.yourcompany.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mes-api.yourcompany.com;
    root /var/www/mes-backend/public;

    # SSLé…ç½®
    ssl_certificate /etc/ssl/certs/mes-api.yourcompany.com.crt;
    ssl_certificate_key /etc/ssl/private/mes-api.yourcompany.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # æ€§èƒ½ä¼˜åŒ–
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/rss+xml text/javascript image/svg+xml application/x-font-ttf font/opentype application/vnd.ms-fontobject;

    # PHPå¤„ç†
    index index.php;
    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # PHP-FPMé…ç½®
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    # å®‰å…¨è®¾ç½®
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/mes-backend.access.log;
    error_log /var/log/nginx/mes-backend.error.log;
}
```

### 3. Laravelç¼“å­˜ä¼˜åŒ–

```bash
# ç¼–è¯‘é…ç½®ç¼“å­˜
php artisan config:cache

# ç¼–è¯‘è·¯ç”±ç¼“å­˜
php artisan route:cache

# ç¼–è¯‘è§†å›¾ç¼“å­˜
php artisan view:cache

# ç”Ÿæˆä¼˜åŒ–çš„ç±»æ˜ å°„
composer install --optimize-autoloader --no-dev

# ç¼“å­˜äº‹ä»¶å’Œç›‘å¬å™¨
php artisan event:cache
```

---

## ğŸ”’ å®‰å…¨è®¾ç½®

### 1. åº”ç”¨å®‰å…¨é…ç½®

```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
sudo chown -R mes:www-data /var/www/mes-backend
sudo find /var/www/mes-backend -type f -exec chmod 644 {} \;
sudo find /var/www/mes-backend -type d -exec chmod 755 {} \;
sudo chmod -R 775 /var/www/mes-backend/storage
sudo chmod -R 775 /var/www/mes-backend/bootstrap/cache

# ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶
sudo chmod 600 /var/www/mes-backend/.env.production
sudo chown mes:mes /var/www/mes-backend/.env.production
```

### 2. æ•°æ®åº“å®‰å…¨

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·ç”¨äºç›‘æ§
CREATE USER mes_readonly WITH PASSWORD 'readonly-password';
GRANT CONNECT ON DATABASE mes_production TO mes_readonly;
GRANT USAGE ON SCHEMA public TO mes_readonly;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO mes_readonly;

-- æ’¤é”€å…¬å…±æƒé™
REVOKE ALL ON SCHEMA public FROM PUBLIC;
GRANT ALL ON SCHEMA public TO mes_user;
```

### 3. Rediså®‰å…¨é…ç½®

ç¼–è¾‘ `/etc/redis/redis.conf`ï¼š

```conf
# ç»‘å®šåˆ°æœ¬åœ°æ¥å£
bind 127.0.0.1 ::1

# è®¾ç½®å¯†ç 
requirepass your-strong-redis-password

# ç¦ç”¨å±é™©å‘½ä»¤
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command SHUTDOWN SHUTDOWN_MES_ONLY
rename-command DEBUG ""
rename-command EVAL ""
```

---

## âœ… éƒ¨ç½²éªŒè¯

### 1. åŠŸèƒ½éªŒè¯è„šæœ¬

åˆ›å»º `scripts/deployment-check.php`ï¼š

```php
#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

$app = require_once __DIR__ . '/../bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);

echo "ğŸ” å¼€å§‹éƒ¨ç½²éªŒè¯...\n\n";

// 1. æ•°æ®åº“è¿æ¥æµ‹è¯•
try {
    DB::connection()->getPdo();
    echo "âœ… æ•°æ®åº“è¿æ¥: æ­£å¸¸\n";
} catch (Exception $e) {
    echo "âŒ æ•°æ®åº“è¿æ¥: å¤±è´¥ - " . $e->getMessage() . "\n";
    exit(1);
}

// 2. Redisè¿æ¥æµ‹è¯•
try {
    Cache::store('redis')->put('deployment_test', 'ok', 60);
    $result = Cache::store('redis')->get('deployment_test');
    if ($result === 'ok') {
        echo "âœ… Redisè¿æ¥: æ­£å¸¸\n";
    } else {
        echo "âŒ Redisè¿æ¥: æµ‹è¯•å¤±è´¥\n";
    }
} catch (Exception $e) {
    echo "âŒ Redisè¿æ¥: å¤±è´¥ - " . $e->getMessage() . "\n";
}

// 3. æƒé™ç³»ç»Ÿæµ‹è¯•
try {
    $permissionCount = \Spatie\Permission\Models\Permission::count();
    $roleCount = \Spatie\Permission\Models\Role::count();
    echo "âœ… æƒé™ç³»ç»Ÿ: {$permissionCount}ä¸ªæƒé™, {$roleCount}ä¸ªè§’è‰²\n";
} catch (Exception $e) {
    echo "âŒ æƒé™ç³»ç»Ÿ: å¤±è´¥ - " . $e->getMessage() . "\n";
}

// 4. è¶…çº§ç®¡ç†å‘˜éªŒè¯
try {
    $superAdmin = \App\Models\User::where('is_super_admin', true)->first();
    if ($superAdmin) {
        echo "âœ… è¶…çº§ç®¡ç†å‘˜: å·²é…ç½® ({$superAdmin->email})\n";
    } else {
        echo "âš ï¸  è¶…çº§ç®¡ç†å‘˜: æœªé…ç½®\n";
    }
} catch (Exception $e) {
    echo "âŒ è¶…çº§ç®¡ç†å‘˜æ£€æŸ¥: å¤±è´¥ - " . $e->getMessage() . "\n";
}

// 5. å­˜å‚¨æƒé™æµ‹è¯•
try {
    $testFile = storage_path('app/deployment_test.txt');
    file_put_contents($testFile, 'test');
    if (file_exists($testFile)) {
        unlink($testFile);
        echo "âœ… å­˜å‚¨æƒé™: æ­£å¸¸\n";
    }
} catch (Exception $e) {
    echo "âŒ å­˜å‚¨æƒé™: å¤±è´¥ - " . $e->getMessage() . "\n";
}

echo "\nğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆ!\n";
```

### 2. APIç«¯ç‚¹æµ‹è¯•

```bash
# åˆ›å»ºæµ‹è¯•è„šæœ¬
cat > scripts/api-test.sh << 'EOF'
#!/bin/bash

API_BASE="https://mes-api.yourcompany.com/api"

echo "ğŸ§ª å¼€å§‹APIæµ‹è¯•..."

# æµ‹è¯•ç™»å½•ç«¯ç‚¹
echo "æµ‹è¯•ç™»å½•ç«¯ç‚¹..."
curl -s -X POST "$API_BASE/auth/login" \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -d '{
    "user": "admin@example.com",
    "password": "password",
    "device_name": "deployment-test"
  }' | jq .

# æµ‹è¯•å¥åº·æ£€æŸ¥
echo "æµ‹è¯•å¥åº·æ£€æŸ¥..."
curl -s "$API_BASE/health" | jq .

echo "âœ… APIæµ‹è¯•å®Œæˆ"
EOF

chmod +x scripts/api-test.sh
```

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

```bash
# ä½¿ç”¨Apache Benchè¿›è¡Œç®€å•å‹åŠ›æµ‹è¯•
ab -n 100 -c 10 https://mes-api.yourcompany.com/api/health

# ä½¿ç”¨wrkè¿›è¡Œæ›´è¯¦ç»†çš„æµ‹è¯•
wrk -t4 -c100 -d30s --latency https://mes-api.yourcompany.com/api/health
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æ—¥å¿—ç›‘æ§è®¾ç½®

```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
sudo tee /etc/logrotate.d/mes-backend << EOF
/var/www/mes-backend/storage/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 mes www-data
    postrotate
        systemctl reload php8.2-fpm
    endscript
}
EOF
```

### 2. å®šæœŸç»´æŠ¤ä»»åŠ¡

åˆ›å»º `/etc/cron.d/mes-backend`ï¼š

```cron
# Laravelè°ƒåº¦å™¨
* * * * * mes cd /var/www/mes-backend && php artisan schedule:run >> /dev/null 2>&1

# æ¸…ç†è¿‡æœŸToken (æ¯å°æ—¶)
0 * * * * mes cd /var/www/mes-backend && php artisan sanctum:prune-expired >> /var/log/mes-token-cleanup.log 2>&1

# æ€§èƒ½ç›‘æ§æ•°æ®æ¸…ç† (æ¯å¤©å‡Œæ™¨2ç‚¹)
0 2 * * * mes cd /var/www/mes-backend && php artisan performance:cleanup >> /var/log/mes-performance-cleanup.log 2>&1

# æƒé™ç¼“å­˜åˆ·æ–° (æ¯å¤©å‡Œæ™¨3ç‚¹)
0 3 * * * mes cd /var/www/mes-backend && php artisan permission:cache-reset >> /var/log/mes-permission-cache.log 2>&1

# æ—¥å¿—æ¸…ç† (æ¯å‘¨æ—¥å‡Œæ™¨4ç‚¹)
0 4 * * 0 mes find /var/www/mes-backend/storage/logs -name "*.log" -mtime +30 -delete
```

### 3. ç›‘æ§è„šæœ¬

åˆ›å»º `scripts/health-check.sh`ï¼š

```bash
#!/bin/bash

# ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬
LOGFILE="/var/log/mes-health-check.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "[$TIMESTAMP] å¼€å§‹å¥åº·æ£€æŸ¥" >> $LOGFILE

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
services=("nginx" "php8.2-fpm" "postgresql" "redis-server")
for service in "${services[@]}"; do
    if systemctl is-active --quiet $service; then
        echo "[$TIMESTAMP] âœ… $service: è¿è¡Œæ­£å¸¸" >> $LOGFILE
    else
        echo "[$TIMESTAMP] âŒ $service: æœåŠ¡å¼‚å¸¸" >> $LOGFILE
        # å‘é€å‘Šè­¦é€šçŸ¥ (å¯é›†æˆé’‰é’‰ã€é‚®ä»¶ç­‰)
    fi
done

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "[$TIMESTAMP] âš ï¸  ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡: ${DISK_USAGE}%" >> $LOGFILE
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEM_USAGE=$(free | awk 'FNR==2{printf "%.0f\n", $3/($3+$4)*100}')
if [ $MEM_USAGE -gt 85 ]; then
    echo "[$TIMESTAMP] âš ï¸  å†…å­˜ä½¿ç”¨ç‡: ${MEM_USAGE}%" >> $LOGFILE
fi

echo "[$TIMESTAMP] å¥åº·æ£€æŸ¥å®Œæˆ" >> $LOGFILE
```

---

## ğŸ“ éƒ¨ç½²æ¸…å•

### ğŸ”² éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡å®Œæˆ
- [ ] å¿…è¦è½¯ä»¶ç‰ˆæœ¬ç¡®è®¤
- [ ] æ•°æ®åº“å’ŒRedisæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] SSLè¯ä¹¦é…ç½®å®Œæˆ
- [ ] åŸŸåDNSè§£ææ­£ç¡®

### ğŸ”² éƒ¨ç½²é…ç½®æ¸…å•

- [ ] ä»£ç ä»“åº“å…‹éš†å®Œæˆ
- [ ] Composerä¾èµ–å®‰è£…å®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] åº”ç”¨å¯†é’¥ç”Ÿæˆ
- [ ] æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡®

### ğŸ”² æ•°æ®åº“åˆå§‹åŒ–æ¸…å•

- [ ] æ•°æ®åº“è¿ç§»æ‰§è¡ŒæˆåŠŸ
- [ ] æƒé™å’Œè§’è‰²æ•°æ®å¡«å……å®Œæˆ
- [ ] è¶…çº§ç®¡ç†å‘˜è´¦æˆ·åˆ›å»º
- [ ] æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å®Œæˆ

### ğŸ”² å®‰å…¨é…ç½®æ¸…å•

- [ ] æ–‡ä»¶æƒé™æ­£ç¡®è®¾ç½®
- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] Rediså®‰å…¨é…ç½®å®Œæˆ
- [ ] Nginxå®‰å…¨å¤´é…ç½®
- [ ] SSL/TLSé…ç½®æ­£ç¡®

### ğŸ”² æ€§èƒ½ä¼˜åŒ–æ¸…å•

- [ ] PHP-FPMé…ç½®ä¼˜åŒ–
- [ ] Nginxé…ç½®ä¼˜åŒ–
- [ ] Laravelç¼“å­˜é…ç½®
- [ ] æ•°æ®åº“è¿æ¥æ± é…ç½®
- [ ] Redisç¼“å­˜é…ç½®

### ğŸ”² éƒ¨ç½²éªŒè¯æ¸…å•

- [ ] åŠŸèƒ½éªŒè¯è„šæœ¬é€šè¿‡
- [ ] APIç«¯ç‚¹æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ
- [ ] æ—¥å¿—ç›‘æ§é…ç½®å®Œæˆ
- [ ] å®šæœŸç»´æŠ¤ä»»åŠ¡è®¾ç½®

---

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æƒé™é”™è¯¯
```bash
# é—®é¢˜ï¼šæƒé™æ£€æŸ¥å¤±è´¥
# è§£å†³ï¼šæ¸…é™¤æƒé™ç¼“å­˜
php artisan permission:cache-reset
php artisan config:cache
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# æ£€æŸ¥è¿æ¥é…ç½®
php artisan tinker
DB::connection()->getPdo();
```

#### 3. Redisè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥RedisæœåŠ¡
sudo systemctl status redis-server

# æµ‹è¯•è¿æ¥
redis-cli ping
```

#### 4. æ€§èƒ½é—®é¢˜
```bash
# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# é‡æ–°ç”Ÿæˆä¼˜åŒ–ç¼“å­˜
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

**æœ€åæ›´æ–°**: 2025-01-10  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0

> **æ³¨æ„**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·åŠ¡å¿…åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ç¡®ä¿æœ‰å®Œæ•´çš„æ•°æ®å¤‡ä»½ç­–ç•¥ã€‚ 