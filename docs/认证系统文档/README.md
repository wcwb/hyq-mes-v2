# MES 认证系统文档

本文档提供MES制造执行系统认证模块的完整指南，包括API文档、开发指南、部署指南和安全最佳实践。

## 📚 文档目录

### [1. API 文档](./01-API文档.md)
- 认证端点详细说明
- 权限系统使用方法
- Token管理功能
- 性能监控接口
- 错误代码参考

### [2. 开发者指南](./02-开发者指南.md)
- 如何添加新权限
- Policy创建最佳实践
- 团队上下文管理
- 认证系统测试指南
- 代码示例和最佳实践

### [3. 部署指南](./03-部署指南.md)
- 环境变量配置
- 数据库迁移步骤
- Seeder执行指南
- 性能调优建议
- 部署清单

### [4. 安全指南](./04-安全指南.md)
- 令牌安全实践
- 权限分配原则
- 超级管理员管理
- 审计日志设置
- 网络安全配置
- 数据保护策略
- 安全监控
- 应急响应

### [5. 文档总结](./05-文档总结.md)
- 文档清单和导航
- 按角色推荐阅读
- 重要概念索引
- 实施检查清单
- 支持与维护指南

## 🚀 快速开始

### 认证流程概述
1. **用户登录** - 通过邮箱/工号/手机号和密码进行身份验证
2. **Token生成** - 系统为已验证用户生成Sanctum访问令牌
3. **团队上下文** - 为用户设置当前团队的权限上下文
4. **权限验证** - 基于Spatie Permission进行细粒度权限控制
5. **性能监控** - 实时监控认证系统的性能指标

### 核心特性
- ✅ **多种登录方式**：支持邮箱、工号、手机号登录
- ✅ **JWT令牌认证**：基于Laravel Sanctum的安全令牌系统
- ✅ **团队隔离**：完整的多团队数据隔离架构
- ✅ **细粒度权限**：基于角色和权限的访问控制（RBAC）
- ✅ **超级管理员**：通过Laravel Gate::before实现全局权限
- ✅ **性能监控**：实时监控认证性能和使用统计
- ✅ **审计日志**：完整的用户操作追踪记录

### 技术栈
- **框架**：Laravel 12.x
- **认证**：Laravel Sanctum
- **权限管理**：Spatie Permission (支持团队模式)
- **数据库**：PostgreSQL
- **缓存**：Redis
- **监控**：自定义性能监控服务

## 📋 系统架构

### 认证架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用       │    │   API网关       │    │   认证服务      │
│                 │────│                 │────│                 │
│ • Vue/React     │    │ • 路由管理      │    │ • 用户验证      │
│ • Token存储      │    │ • 中间件        │    │ • Token管理     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                        ┌─────────────────┐    ┌─────────────────┐
                        │   权限系统      │    │   团队管理      │
                        │                 │────│                 │
                        │ • Spatie Perm   │    │ • 团队隔离      │
                        │ • Policy管理    │    │ • 上下文切换    │
                        └─────────────────┘    └─────────────────┘
```

### 数据库关系图
```
User ──┐
       ├── Teams (多对多关系)
       ├── Roles (通过Spatie Permission)
       └── Permissions (通过Spatie Permission)

Team ──┐
       ├── Users (多对多关系)
       ├── Roles (团队级角色)
       └── Permissions (团队级权限)
```

## 🔒 安全特性

### 认证安全
- 密码哈希：使用bcrypt算法
- 令牌过期：可配置的Token生命周期
- 设备管理：支持多设备登录管理
- 登录限制：防暴力破解保护

### 权限安全
- 团队隔离：完全的数据访问隔离
- 最小权限原则：用户仅获得必要权限
- 权限缓存：高性能的权限检查机制
- 审计跟踪：完整的操作日志记录

## 📊 性能特性

### 监控指标
- **Gate::before检查**：权限预检查性能
- **Token验证**：令牌验证响应时间
- **权限检查**：Spatie Permission查询性能
- **认证端点**：API端点响应时间

### 性能优化
- 权限缓存：减少数据库查询
- 延迟加载：按需加载用户关系
- 查询优化：避免N+1查询问题
- Redis缓存：会话和权限数据缓存

## 🛠️ 开发工具

### 命令行工具
```bash
# 创建新用户
php artisan user:create

# 分配权限
php artisan permission:assign

# 查看权限
php artisan permission:list

# 性能监控
php artisan performance:monitor
```

### 调试工具
- Laravel Telescope：请求和查询分析
- Debug Bar：开发环境调试
- Log Viewer：日志查看和分析

## 📞 获取支持

如果您在使用认证系统时遇到问题，请：

1. **查阅文档**：首先查看相关章节的详细说明
2. **检查日志**：查看Laravel日志文件获取错误信息
3. **联系开发团队**：通过项目管理系统提交issue

---

> **注意**：本文档基于Laravel 12.x和Spatie Permission最新版本编写。在使用前请确保系统版本兼容性。

**最后更新**：{{ now()->format('Y-m-d H:i:s') }}
**文档版本**：1.0.0 